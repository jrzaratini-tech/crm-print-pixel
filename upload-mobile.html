<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Scanner de Documento</title>

<style>
body{
  margin:0;
  background:linear-gradient(135deg,#667eea,#764ba2);
  font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
.container{
  background:#fff;
  max-width:480px;
  width:100%;
  border-radius:20px;
  padding:20px;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
}
h1{text-align:center}
p{text-align:center;color:#555}
button{
  width:100%;
  padding:16px;
  margin-top:12px;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}
.scan{background:#10b981;color:#fff}
.gallery{background:#3b82f6;color:#fff}
video,canvas,img{
  width:100%;
  margin-top:15px;
  border-radius:12px;
}
.hidden{display:none}
.controls{
  display:flex;
  gap:10px;
  margin-top:15px;
}
.controls button{
  flex:1;
}
.ok{background:#10b981;color:#fff}
.retry{background:#f59e0b;color:#fff}
</style>
</head>

<body>
<div class="container">

<h1>Escanear Documento</h1>
<p>Scanner inteligente com corte autom√°tico</p>

<button class="scan" id="scanBtn">üìÑ Escanear Documento</button>
<button class="gallery" id="galleryBtn">üñºÔ∏è Galeria</button>

<video id="video" autoplay playsinline class="hidden"></video>
<canvas id="canvas" class="hidden"></canvas>
<img id="preview" class="hidden"/>

<div class="controls hidden" id="controls">
  <button class="retry" id="retake">Refazer</button>
  <button class="ok" id="send">Enviar</button>
</div>

<input type="file" id="fileInput" accept="image/*" hidden>

</div>

<!-- OpenCV -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<script>
let video=document.getElementById("video");
let canvas=document.getElementById("canvas");
let preview=document.getElementById("preview");
let controls=document.getElementById("controls");
let stream;

document.getElementById("scanBtn").onclick=startCamera;
document.getElementById("galleryBtn").onclick=()=>fileInput.click();
document.getElementById("retake").onclick=()=>location.reload();
document.getElementById("send").onclick=()=>alert("Imagem pronta para upload üöÄ");

async function startCamera(){
  video.classList.remove("hidden");
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=stream;
  setTimeout(capture,2500);
}

function capture(){
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  stopCamera();
  scanDocument();
}

function stopCamera(){
  if(stream)stream.getTracks().forEach(t=>t.stop());
}

function scanDocument(){
  let src=cv.imread(canvas);
  let gray=new cv.Mat();
  cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray,gray,new cv.Size(5,5),0);

  let edged=new cv.Mat();
  cv.Canny(gray,edged,75,200);

  let contours=new cv.MatVector();
  let hierarchy=new cv.Mat();
  cv.findContours(edged,contours,hierarchy,cv.RETR_LIST,cv.CHAIN_APPROX_SIMPLE);

  let maxArea=0,docContour=null;

  for(let i=0;i<contours.size();i++){
    let cnt=contours.get(i);
    let peri=cv.arcLength(cnt,true);
    let approx=new cv.Mat();
    cv.approxPolyDP(cnt,approx,0.02*peri,true);
    let area=cv.contourArea(cnt);
    if(approx.rows===4 && area>maxArea){
      maxArea=area;
      docContour=approx;
    }
  }

  if(!docContour){
    applyBW(src);
    return;
  }

  let pts=[];
  for(let i=0;i<4;i++){
    pts.push({
      x:docContour.data32S[i*2],
      y:docContour.data32S[i*2+1]
    });
  }

  pts.sort((a,b)=>a.x+a.y-(b.x+b.y));
  let [tl,br]=[pts[0],pts[3]];
  let tr=pts.find(p=>p.x>tl.x && p.y< br.y);
  let bl=pts.find(p=>p.x< br.x && p.y>tl.y);

  let srcTri=cv.matFromArray(4,1,cv.CV_32FC2,
    [tl.x,tl.y,tr.x,tr.y,br.x,br.y,bl.x,bl.y]);

  let w=Math.max(
    dist(br,tr),dist(bl,tl)
  );
  let h=Math.max(
    dist(tr,tl),dist(br,bl)
  );

  let dstTri=cv.matFromArray(4,1,cv.CV_32FC2,
    [0,0,w,0,w,h,0,h]);

  let M=cv.getPerspectiveTransform(srcTri,dstTri);
  let dst=new cv.Mat();
  cv.warpPerspective(src,dst,M,new cv.Size(w,h));

  applyBW(dst);
}

function applyBW(mat){
  let gray=new cv.Mat();
  cv.cvtColor(mat,gray,cv.COLOR_RGBA2GRAY);
  cv.adaptiveThreshold(
    gray,gray,255,
    cv.ADAPTIVE_THRESH_GAUSSIAN_C,
    cv.THRESH_BINARY,11,2
  );
  cv.imshow(canvas,gray);
  preview.src=canvas.toDataURL("image/jpeg",0.8);
  preview.classList.remove("hidden");
  controls.classList.remove("hidden");
}

function dist(a,b){
  return Math.hypot(a.x-b.x,a.y-b.y);
}

fileInput.onchange=e=>{
  let f=e.target.files[0];
  let r=new FileReader();
  r.onload=()=>{
    let img=new Image();
    img.onload=()=>{
      canvas.width=img.width;
      canvas.height=img.height;
      canvas.getContext("2d").drawImage(img,0,0);
      scanDocument();
    }
    img.src=r.result;
  }
  r.readAsDataURL(f);
}
</script>
</body>
</html>
