<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Dados - Sistema CORE</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 25px 30px;
            border-bottom: 5px solid var(--danger);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .content {
            padding: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--light);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border-left: 5px solid;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--accent), transparent);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .stat-card.vendas { border-color: var(--success); }
        .stat-card.despesas { border-color: var(--danger); }
        .stat-card.lucro { border-color: var(--accent); }
        .stat-card.total { border-color: var(--warning); }
        
        .stat-card .value {
            font-size: 2.2rem;
            font-weight: bold;
            display: block;
            margin: 10px 0;
        }
        
        .stat-card.vendas .value { color: var(--success); }
        .stat-card.despesas .value { color: var(--danger); }
        .stat-card.lucro .value { color: var(--accent); }
        .stat-card.total .value { color: var(--warning); }
        
        .stat-card .label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            background: var(--light);
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--dark);
        }
        
        .filter-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        .search-bar {
            display: flex;
            gap: 15px;
            flex: 1;
            max-width: 500px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .search-bar input:focus {
            border-color: var(--accent);
        }
        
        .search-bar select {
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            background: white;
            font-size: 1rem;
            cursor: pointer;
            outline: none;
            min-width: 150px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-export {
            background: linear-gradient(135deg, var(--success) 0%, #219150 100%);
            color: white;
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-top: 20px;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        thead {
            background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            color: white;
        }
        
        tbody tr {
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .tag {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-venda { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .tag-despesa { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .tag-pedido { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        .tag-producao { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .btn-del {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-del:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-del:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-restore {
            background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%);
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-restore:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        
        .status-deleted {
            background: #f8f9fa;
        }
        
        .status-deleted td {
            color: #95a5a6;
            text-decoration: line-through;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
            color: #bdc3c7;
        }
        
        .empty-state h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading i {
            font-size: 2rem;
            color: var(--accent);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
        }
        
        .page-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-btn:hover {
            background: var(--light);
            border-color: var(--accent);
        }
        
        .page-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .page-info {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .actions-cell {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s;
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.info {
            background: var(--accent);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 992px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-bar {
                max-width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 12px 8px;
                font-size: 0.9rem;
            }
            
            .filters {
                justify-content: center;
            }
            
            .search-bar {
                flex-direction: column;
            }
            
            .search-bar select {
                width: 100%;
            }
            
            .actions-cell {
                flex-direction: column;
            }
        }
        
        .export-options {
            display: none;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .export-options h4 {
            margin-top: 0;
            color: var(--primary);
        }
        
        .export-options label {
            display: block;
            margin: 10px 0 5px;
            color: var(--dark);
        }
        
        .export-options input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-database"></i>
                Gerenciador de Dados
                <small style="font-size: 1rem; opacity: 0.9; font-weight: normal;">Sistema CORE v4.0 - Port√°til</small>
            </h1>
        </div>
        
        <div class="content">
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card vendas">
                    <span class="value" id="total-vendas">‚Ç¨0,00</span>
                    <span class="label">Total Vendas</span>
                </div>
                <div class="stat-card despesas">
                    <span class="value" id="total-despesas">‚Ç¨0,00</span>
                    <span class="label">Total Despesas</span>
                </div>
                <div class="stat-card lucro">
                    <span class="value" id="total-lucro">‚Ç¨0,00</span>
                    <span class="label">Lucro L√≠quido</span>
                </div>
                <div class="stat-card total">
                    <span class="value" id="total-registros">0</span>
                    <span class="label">Registros Ativos</span>
                </div>
            </div>
            
            <div class="toolbar">
                <div class="filters">
                    <button class="filter-btn active" onclick="filtrarPorTipo('all')">
                        <i class="fas fa-layer-group"></i> Todos
                    </button>
                    <button class="filter-btn" onclick="filtrarPorTipo('venda')">
                        <i class="fas fa-shopping-cart"></i> Vendas
                    </button>
                    <button class="filter-btn" onclick="filtrarPorTipo('despesa')">
                        <i class="fas fa-money-bill-wave"></i> Despesas
                    </button>
                    <button class="filter-btn" onclick="filtrarPorTipo('pedido')">
                        <i class="fas fa-clipboard-list"></i> Pedidos
                    </button>
                    <button class="filter-btn" onclick="filtrarPorTipo('deleted')">
                        <i class="fas fa-trash"></i> Anulados
                    </button>
                </div>
                
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="üîç Buscar por cliente, descri√ß√£o, valor..." 
                           onkeyup="filtrarTabela()">
                    <select id="date-filter" onchange="filtrarTabela()">
                        <option value="all">Todas as datas</option>
                        <option value="today">Hoje</option>
                        <option value="week">Esta semana</option>
                        <option value="month">Este m√™s</option>
                        <option value="year">Este ano</option>
                    </select>
                </div>
                
                <button class="btn btn-export" onclick="toggleExportOptions()">
                    <i class="fas fa-file-export"></i> Exportar Dados
                </button>
            </div>
            
            <div class="export-options" id="export-options">
                <h4><i class="fas fa-cog"></i> Op√ß√µes de Exporta√ß√£o</h4>
                <label>
                    <input type="checkbox" id="exp-all-data" checked> Todos os dados
                </label>
                <label>
                    <input type="checkbox" id="exp-only-active"> Apenas registros ativos
                </label>
                <label>
                    <input type="checkbox" id="exp-include-deleted"> Incluir registros anulados
                </label>
                <label>
                    <input type="checkbox" id="exp-include-stats"> Incluir estat√≠sticas
                </label>
                <div class="export-buttons">
                    <button class="btn" onclick="exportarDados('json')" style="background: var(--success); color: white;">
                        <i class="fas fa-file-code"></i> Exportar JSON
                    </button>
                    <button class="btn" onclick="exportarDados('csv')" style="background: var(--accent); color: white;">
                        <i class="fas fa-file-csv"></i> Exportar CSV
                    </button>
                    <button class="btn" onclick="toggleExportOptions()" style="background: var(--danger); color: white;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <i class="fas fa-spinner"></i>
                <p>Carregando dados...</p>
            </div>
            
            <div class="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Tipo</th>
                            <th>Descri√ß√£o/Cliente</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Dados ser√£o carregados aqui -->
                    </tbody>
                </table>
            </div>
            
            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-inbox"></i>
                <h3>Nenhum registro encontrado</h3>
                <p>Comece adicionando vendas ou despesas atrav√©s das p√°ginas do sistema.</p>
            </div>
            
            <div class="pagination" id="pagination" style="display: none;">
                <button class="page-btn" onclick="mudarPagina(-1)">
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <span class="page-info" id="page-info">P√°gina 1 de 1</span>
                <button class="page-btn" onclick="mudarPagina(1)">
                    Pr√≥xima <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script>
        let todosEventos = [];
        let eventosFiltrados = [];
        let filtroAtual = 'all';
        let paginaAtual = 1;
        const itensPorPagina = 20;
        
        async function inicializar() {
            mostrarLoading(true);
            
            try {
                // Verificar acesso admin
                const isAdmin = await verificarAdmin();
                if (!isAdmin) {
                    mostrarAcessoRestrito();
                    return;
                }
                
                // Carregar dados
                await carregarDados();
                
            } catch (error) {
                console.error("Erro ao inicializar:", error);
                mostrarNotificacao("Erro ao carregar dados do sistema", "error");
            } finally {
                mostrarLoading(false);
            }
        }
        
        function verificarAdmin() {
            return new Promise((resolve) => {
                window.parent.postMessage({ type: "ADMIN_STATUS_REQUEST" }, "*");
                
                const timeout = setTimeout(() => resolve(false), 1000);
                
                window.addEventListener("message", function handler(e) {
                    if (e.data.type === "ADMIN_STATUS_RESPONSE") {
                        clearTimeout(timeout);
                        window.removeEventListener("message", handler);
                        resolve(e.data.isAdmin);
                    }
                }, { once: true });
            });
        }
        
        function mostrarAcessoRestrito() {
            document.body.innerHTML = `
                <div style="
                    text-align: center; 
                    padding: 100px 20px; 
                    color: white;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                ">
                    <i class="fas fa-lock" style="font-size: 4rem; margin-bottom: 20px;"></i>
                    <h1 style="margin: 0 0 20px 0;">ACESSO RESTRITO</h1>
                    <p style="font-size: 1.2rem; max-width: 500px; line-height: 1.6;">
                        Esta p√°gina requer privil√©gios de administrador.
                    </p>
                    <p style="margin-top: 10px; opacity: 0.9;">
                        Ative o modo admin no menu principal usando o PIN: 3377
                    </p>
                    <button onclick="voltarParaDashboard()" style="
                        margin-top: 30px;
                        padding: 12px 30px;
                        background: white;
                        color: #667eea;
                        border: none;
                        border-radius: 25px;
                        font-weight: bold;
                        cursor: pointer;
                        font-size: 1rem;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    ">
                        <i class="fas fa-arrow-left"></i> Voltar para Dashboard
                    </button>
                </div>
            `;
        }
        
        function voltarParaDashboard() {
            window.parent.postMessage({ type: "NAVIGATE_TO_DASHBOARD" }, "*");
        }
        
        async function carregarDados() {
            try {
                window.parent.postMessage({ 
                    type: "QUERY_REQUEST", 
                    source: 'admin-lancamentos' 
                }, "*");
                
                // Configurar listener para receber resposta
                window.addEventListener("message", function handler(e) {
                    if (e.data.type === "QUERY_RESPONSE") {
                        window.removeEventListener("message", handler);
                        processarDadosRecebidos(e.data.data);
                    }
                }, { once: true });
                
                // Timeout de seguran√ßa
                setTimeout(() => {
                    window.removeEventListener("message", handler);
                    mostrarNotificacao("Timeout ao carregar dados", "error");
                }, 5000);
                
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                throw error;
            }
        }
        
        function processarDadosRecebidos(dados) {
            todosEventos = dados || [];
            eventosFiltrados = [...todosEventos];
            
            atualizarEstatisticas();
            filtrarTabela();
        }
        
        function atualizarEstatisticas() {
            const stats = calcularEstatisticas(todosEventos);
            
            document.getElementById('total-vendas').textContent = 
                formatarMoeda(stats.totalVendas);
            document.getElementById('total-despesas').textContent = 
                formatarMoeda(stats.totalDespesas);
            document.getElementById('total-lucro').textContent = 
                formatarMoeda(stats.totalLucro);
            document.getElementById('total-registros').textContent = 
                stats.totalRegistros;
        }
        
        function calcularEstatisticas(eventos) {
            let totalVendas = 0;
            let totalDespesas = 0;
            let totalRegistros = 0;
            
            eventos.forEach(event => {
                if (event.deleted) return;
                
                totalRegistros++;
                
                const valor = parseFloat(
                    event.payload?.total || 
                    event.payload?.valor || 
                    event.payload?.val || 
                    0
                );
                
                if (event.schema === 'venda' || event.schema === 'pedido') {
                    totalVendas += valor;
                } else if (event.schema === 'despesa') {
                    totalDespesas += valor;
                }
            });
            
            const totalLucro = totalVendas - totalDespesas;
            
            return {
                totalVendas,
                totalDespesas,
                totalLucro,
                totalRegistros
            };
        }
        
        function renderizarTabela(eventos = eventosFiltrados) {
            const tbody = document.getElementById('table-body');
            const emptyState = document.getElementById('empty-state');
            const pagination = document.getElementById('pagination');
            
            if (!eventos || eventos.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                pagination.style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Pagina√ß√£o
            const totalPaginas = Math.ceil(eventos.length / itensPorPagina);
            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const eventosPagina = eventos.slice(inicio, fim);
            
            if (totalPaginas > 1) {
                pagination.style.display = 'flex';
                document.getElementById('page-info').textContent = 
                    `P√°gina ${paginaAtual} de ${totalPaginas} (${eventos.length} registros)`;
            } else {
                pagination.style.display = 'none';
            }
            
            const html = eventosPagina.map(event => {
                const isDeleted = event.deleted;
                const tipo = event.schema;
                const valor = parseFloat(
                    event.payload?.total || 
                    event.payload?.valor || 
                    event.payload?.val || 
                    0
                );
                
                let descricao = event.payload?.cliente || 
                               event.payload?.descricao || 
                               event.payload?.produto || 
                               event.payload?.nome || 
                               'Sem descri√ß√£o';
                
                const dataHora = new Date(event.created_at);
                const dataFormatada = dataHora.toLocaleDateString('pt-BR');
                const horaFormatada = dataHora.toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Determinar √≠cone e cor baseado no tipo
                const tipoInfo = {
                    'venda': { icon: 'shopping-cart', class: 'tag-venda', label: 'Venda' },
                    'despesa': { icon: 'money-bill-wave', class: 'tag-despesa', label: 'Despesa' },
                    'pedido': { icon: 'clipboard-list', class: 'tag-pedido', label: 'Pedido' },
                    'producao': { icon: 'cogs', class: 'tag-producao', label: 'Produ√ß√£o' }
                }[tipo] || { icon: 'file', class: 'tag-venda', label: tipo };
                
                // Formatar detalhes adicionais
                let detalhes = '';
                if (event.payload?.categoria) {
                    detalhes += `<br><small><strong>Categoria:</strong> ${event.payload.categoria}</small>`;
                }
                if (event.payload?.observacoes) {
                    detalhes += `<br><small><strong>Obs:</strong> ${event.payload.observacoes}</small>`;
                }
                
                return `
                    <tr class="${isDeleted ? 'status-deleted' : ''}">
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <strong>${dataFormatada}</strong>
                                <small style="color: #666;">${horaFormatada}</small>
                            </div>
                        </td>
                        <td>
                            <span class="tag ${tipoInfo.class}">
                                <i class="fas fa-${tipoInfo.icon}"></i>
                                ${tipoInfo.label}
                            </span>
                        </td>
                        <td>
                            <strong>${descricao}</strong>
                            ${detalhes}
                        </td>
                        <td>
                            <strong style="color: ${valor >= 0 ? 'var(--success)' : 'var(--danger)'}">
                                ${formatarMoeda(valor)}
                            </strong>
                        </td>
                        <td>
                            ${isDeleted ? 
                                `<span style="color: var(--danger);"><i class="fas fa-ban"></i> Anulado</span>` : 
                                `<span style="color: var(--success);"><i class="fas fa-check-circle"></i> Ativo</span>`
                            }
                        </td>
                        <td class="actions-cell">
                            ${!isDeleted ? `
                                <button class="btn-del" onclick="anularRegistro('${event.id}', this)" title="Anular registro">
                                    <i class="fas fa-trash"></i> Anular
                                </button>
                            ` : `
                                <button class="btn-restore" onclick="restaurarRegistro('${event.id}', this)" title="Restaurar registro">
                                    <i class="fas fa-undo"></i> Restaurar
                                </button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }
        
        function filtrarPorTipo(tipo) {
            filtroAtual = tipo;
            
            // Atualizar bot√µes ativos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Aplicar filtro
            filtrarTabela();
        }
        
        function filtrarTabela() {
            let eventosFiltradosTemp = [...todosEventos];
            
            // Aplicar filtro por tipo
            if (filtroAtual !== 'all') {
                if (filtroAtual === 'deleted') {
                    eventosFiltradosTemp = eventosFiltradosTemp.filter(event => event.deleted);
                } else {
                    eventosFiltradosTemp = eventosFiltradosTemp.filter(event => 
                        event.schema === filtroAtual && !event.deleted
                    );
                }
            } else {
                eventosFiltradosTemp = eventosFiltradosTemp.filter(event => !event.deleted);
            }
            
            // Aplicar filtro de busca
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (searchTerm) {
                eventosFiltradosTemp = eventosFiltradosTemp.filter(event => {
                    const cliente = (event.payload?.cliente || '').toLowerCase();
                    const descricao = (event.payload?.descricao || '').toLowerCase();
                    const produto = (event.payload?.produto || '').toLowerCase();
                    const observacoes = (event.payload?.observacoes || '').toLowerCase();
                    const categoria = (event.payload?.categoria || '').toLowerCase();
                    const valor = (event.payload?.total || event.payload?.valor || 0).toString();
                    
                    return cliente.includes(searchTerm) || 
                           descricao.includes(searchTerm) ||
                           produto.includes(searchTerm) ||
                           observacoes.includes(searchTerm) ||
                           categoria.includes(searchTerm) ||
                           valor.includes(searchTerm);
                });
            }
            
            // Aplicar filtro de data
            const dateFilter = document.getElementById('date-filter').value;
            if (dateFilter !== 'all') {
                const now = new Date();
                eventosFiltradosTemp = eventosFiltradosTemp.filter(event => {
                    const eventDate = new Date(event.created_at);
                    
                    switch (dateFilter) {
                        case 'today':
                            return eventDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                            return eventDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            return eventDate >= monthAgo;
                        case 'year':
                            const yearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                            return eventDate >= yearAgo;
                        default:
                            return true;
                    }
                });
            }
            
            // Ordenar por data (mais recente primeiro)
            eventosFiltradosTemp.sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            );
            
            eventosFiltrados = eventosFiltradosTemp;
            paginaAtual = 1; // Resetar para primeira p√°gina
            renderizarTabela();
        }
        
        function mudarPagina(direcao) {
            const totalPaginas = Math.ceil(eventosFiltrados.length / itensPorPagina);
            const novaPagina = paginaAtual + direcao;
            
            if (novaPagina >= 1 && novaPagina <= totalPaginas) {
                paginaAtual = novaPagina;
                renderizarTabela();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        async function anularRegistro(eventId, button) {
            if (!confirm("Tem certeza que deseja anular este registro?\n\nEsta a√ß√£o marcar√° o registro como exclu√≠do, mas os dados permanecer√£o no hist√≥rico.")) {
                return;
            }
            
            button.disabled = true;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Anulando...';
            
            try {
                window.parent.postMessage({ 
                    type: "DELETE_EVENT", 
                    id: eventId 
                }, "*");
                
                // Atualizar localmente
                const eventIndex = todosEventos.findIndex(e => e.id === eventId);
                if (eventIndex !== -1) {
                    todosEventos[eventIndex].deleted = true;
                }
                
                // Recalcular filtros
                filtrarTabela();
                atualizarEstatisticas();
                
                mostrarNotificacao("Registro anulado com sucesso", "success");
                
            } catch (error) {
                console.error("Erro ao anular registro:", error);
                mostrarNotificacao("Erro ao anular registro", "error");
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        }
        
        async function restaurarRegistro(eventId, button) {
            if (!confirm("Deseja restaurar este registro?\n\nO registro voltar√° a aparecer no sistema como ativo.")) {
                return;
            }
            
            button.disabled = true;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restaurando...';
            
            try {
                // Enviar mensagem para restaurar (o sistema principal precisa implementar esta funcionalidade)
                window.parent.postMessage({ 
                    type: "RESTORE_EVENT", 
                    id: eventId 
                }, "*");
                
                // Atualizar localmente
                const eventIndex = todosEventos.findIndex(e => e.id === eventId);
                if (eventIndex !== -1) {
                    todosEventos[eventIndex].deleted = false;
                }
                
                // Recalcular filtros
                filtrarTabela();
                atualizarEstatisticas();
                
                mostrarNotificacao("Registro restaurado com sucesso", "success");
                
            } catch (error) {
                console.error("Erro ao restaurar registro:", error);
                mostrarNotificacao("Erro ao restaurar registro", "error");
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        }
        
        function toggleExportOptions() {
            const options = document.getElementById('export-options');
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        }
        
        function exportarDados(formato) {
            const incluirAtivos = document.getElementById('exp-all-data').checked || 
                                 document.getElementById('exp-only-active').checked;
            const incluirAnulados = document.getElementById('exp-include-deleted').checked;
            const incluirEstatisticas = document.getElementById('exp-include-stats').checked;
            
            let eventosParaExportar = [];
            
            if (incluirAtivos) {
                eventosParaExportar.push(...todosEventos.filter(e => !e.deleted));
            }
            if (incluirAnulados) {
                eventosParaExportar.push(...todosEventos.filter(e => e.deleted));
            }
            
            // Remover duplicados
            eventosParaExportar = [...new Map(eventosParaExportar.map(item => [item.id, item])).values()];
            
            if (eventosParaExportar.length === 0) {
                mostrarNotificacao("Nenhum dado para exportar", "info");
                return;
            }
            
            const exportData = {
                meta: {
                    sistema: "SISTEMA CORE v4.0",
                    data_exportacao: new Date().toISOString(),
                    total_registros: eventosParaExportar.length,
                    formato: formato.toUpperCase()
                },
                eventos: eventosParaExportar
            };
            
            if (incluirEstatisticas) {
                exportData.estatisticas = calcularEstatisticas(todosEventos);
            }
            
            let dataStr, mimeType, extensao;
            
            if (formato === 'json') {
                dataStr = JSON.stringify(exportData, null, 2);
                mimeType = 'application/json';
                extensao = 'json';
            } else if (formato === 'csv') {
                // Converter para CSV
                const headers = ['ID', 'Data', 'Tipo', 'Cliente/Descricao', 'Valor', 'Categoria', 'Status'];
                const rows = eventosParaExportar.map(event => [
                    event.id,
                    new Date(event.created_at).toISOString(),
                    event.schema,
                    event.payload?.cliente || event.payload?.descricao || '',
                    event.payload?.total || event.payload?.valor || 0,
                    event.payload?.categoria || '',
                    event.deleted ? 'Anulado' : 'Ativo'
                ]);
                
                dataStr = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');
                mimeType = 'text/csv';
                extensao = 'csv';
            }
            
            const dataBlob = new Blob([dataStr], { type: mimeType });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `core_export_${new Date().toISOString().split('T')[0]}.${extensao}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            mostrarNotificacao(`Dados exportados em ${formato.toUpperCase()} com sucesso!`, "success");
            toggleExportOptions();
        }
        
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-PT', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2
            }).format(valor);
        }
        
        function mostrarLoading(mostrar) {
            document.getElementById('loading').style.display = mostrar ? 'block' : 'none';
            document.getElementById('table-body').style.display = mostrar ? 'none' : '';
        }
        
        function mostrarNotificacao(mensagem, tipo = 'info') {
            const notification = document.getElementById('notification');
            notification.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${mensagem}</span>
            `;
            
            notification.className = `notification ${tipo}`;
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', inicializar);
        
        // Configurar auto-refresh a cada 30 segundos
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                carregarDados();
            }
        }, 30000);
    </script>
</body>
</html>