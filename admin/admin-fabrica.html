<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F√°brica de P√°ginas CORE v4.0</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e5e7eb;
            --text-main: #1f2937;
            --text-sec: #6b7280;
            --bg-light: #f9fafb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content { padding: 40px; }

        .form-grid {
            display: grid;
            gap: 24px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-main);
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            border-color: var(--primary);
        }

        .type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 8px;
        }

        .type-card {
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .type-card:hover { border-color: var(--primary); background: #f8fafc; }
        .type-card.selected {
            border-color: var(--primary);
            background-color: #eff6ff;
            color: var(--primary-dark);
        }

        .type-title { font-weight: 700; margin-bottom: 4px; display: block; }
        .type-desc { font-size: 0.8rem; color: var(--text-sec); }

        .actions {
            display: flex;
            gap: 16px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s;
        }

        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }

        .protocol-box {
            margin-top: 30px;
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            display: none;
        }

        .protocol-content {
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #334155;
            padding: 15px;
            margin-top: 10px;
            background: #0f172a;
            border-radius: 6px;
        }

        .status-msg {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            display: none;
            text-align: center;
            font-weight: 500;
        }
        .status-success { background: #dcfce7; color: #166534; }
        .status-error { background: #fee2e2; color: #991b1b; }
        .status-warning { background: #fef3c7; color: #92400e; }

        /* SVG Icons */
        .icon { width: 20px; height: 20px; fill: currentColor; }
        
        .instructions {
            background: #f8fafc;
            border-left: 4px solid var(--primary);
            padding: 16px;
            margin-top: 24px;
            border-radius: 8px;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: var(--primary-dark);
            font-size: 0.95rem;
        }
        
        .instructions ol {
            margin: 8px 0;
            padding-left: 20px;
            font-size: 0.85rem;
            color: var(--text-sec);
        }
        
        .instructions li {
            margin-bottom: 6px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>
            <svg class="icon" viewBox="0 0 24 24"><path d="M22 13v-2h-2.2c-.4-3.5-3.1-6.2-6.6-6.6V2l-2-2-2 2v2.2C5.7 4.6 2.9 7.3 2.5 10.8H0v2h2.2c.4 3.5 3.1 6.2 6.6 6.6v2.2l2 2 2-2v-2.2c3.5-.4 6.2-3.1 6.6-6.6H22zM11 16c-2.8 0-5-2.2-5-5s2.2-5 5-5 5 2.2 5 5-2.2 5-5 5z"/></svg>
            F√°brica de P√°ginas CORE v4.0
        </h1>
        <p>Crie novas p√°ginas para o sistema modular</p>
    </div>

    <div class="content">
        <div class="form-grid">
            <div class="input-group">
                <label>1. Nome no Menu</label>
                <div class="input-wrapper">
                    <input type="text" id="pageName" placeholder="Ex: Cadastro de Clientes">
                </div>
            </div>

            <div class="input-group">
                <label>2. Nome do Arquivo (sem .html)</label>
                <div class="input-wrapper">
                    <input type="text" id="pageFile" placeholder="Ex: clientes">
                </div>
                <small style="color: var(--text-sec); margin-top: 5px; display:block;">
                    Ser√° salvo em: <strong>pages/<span id="previewFile">...</span>.html</strong>
                </small>
            </div>

            <div class="input-group">
                <label>3. Tipo de P√°gina</label>
                <div class="type-selector">
                    <div class="type-card selected" onclick="selectType(this, 'WRITE')">
                        <span class="type-title">üìù WRITE (Escrita)</span>
                        <span class="type-desc">Formul√°rios e Cadastros</span>
                    </div>
                    <div class="type-card" onclick="selectType(this, 'READ')">
                        <span class="type-title">üìä READ (Leitura)</span>
                        <span class="type-desc">Dashboards e Relat√≥rios</span>
                    </div>
                    <div class="type-card" onclick="selectType(this, 'NEUTRAL')">
                        <span class="type-title">üìÑ NEUTRAL (Neutro)</span>
                        <span class="type-desc">Informativos ou Ajustes</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h3>‚ö†Ô∏è IMPORTANTE: Como funciona o salvamento no Firebase</h3>
            <ol>
                <li>A p√°gina ser√° registrada no <strong>sistema principal</strong> (index.html)</li>
                <li>Os dados s√£o salvos no <strong>Firebase online</strong></li>
                <li>Funciona de qualquer lugar do mundo</li>
                <li>Para criar: gere o prompt, crie o HTML, salve em pages/, depois registre aqui</li>
            </ol>
        </div>

        <div class="status-msg" id="statusMsg"></div>

        <div class="actions">
            <button class="btn btn-primary" onclick="generatePrompt()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M7.5 5.6L10 0l2.5 5.6L18 8l-5.5 2.4L10 16l-2.5-5.6L2 8l5.5-2.4z"/></svg>
                Gerar Prompt IA
            </button>
            <button class="btn btn-success" onclick="registerPage()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                Gerar C√≥digo Bot√£o
            </button>
        </div>

        <div class="protocol-box" id="protocolBox">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <strong>Copie este comando para a IA:</strong>
                <button onclick="copyToClipboard()" style="background:#3b82f6; border:none; color:white; padding:4px 10px; border-radius:4px; cursor:pointer;">Copiar</button>
            </div>
            <div class="protocol-content" id="protocolText"></div>
        </div>
    </div>
</div>

<script>
    let currentType = 'WRITE';

    // Atualiza preview do arquivo
    document.getElementById('pageFile').addEventListener('input', (e) => {
        let val = e.target.value.replace(/[^a-z0-9-]/g, '').toLowerCase();
        document.getElementById('previewFile').textContent = val || '...';
    });

    // Sele√ß√£o visual do tipo
    function selectType(el, type) {
        document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        currentType = type;
    }

    // Feedback visual
    function showStatus(msg, type = 'info') {
        const el = document.getElementById('statusMsg');
        el.textContent = msg;
        el.className = `status-msg status-${type}`;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 4000);
    }

    // Valida√ß√£o
    function validate() {
        const name = document.getElementById('pageName').value.trim();
        const file = document.getElementById('pageFile').value.trim();
        
        if (!name) {
            showStatus('Digite um Nome para a p√°gina!', 'error');
            return null;
        }
        
        if (!file) {
            showStatus('Digite um Nome de Arquivo!', 'error');
            return null;
        }
        
        // Limpeza do nome do arquivo
        const cleanFile = file.toLowerCase().replace(/[^a-z0-9-]/g, '');
        if (!cleanFile) {
            showStatus('Nome de arquivo inv√°lido! Use apenas letras, n√∫meros e h√≠fens.', 'error');
            return null;
        }
        
        return { name, file: cleanFile, type: currentType };
    }

    // A√ß√£o 1: Gerar Prompt
    function generatePrompt() {
        const data = validate();
        if (!data) return;

        const pageId = data.file.replace(/-/g, '_');
        const example = data.type === 'WRITE' 
            ? '<input type="text" data-bind="venda.cliente" placeholder="Nome do cliente">\n<button type="button" data-action="commit">Salvar</button>'
            : '<div data-bind="vendas.total">R$ 0,00</div>';

        const prompt = `Crie um arquivo HTML para o "Sistema CORE v5.0".
Nome do arquivo: ${data.file}.html
Tipo: ${data.type}

REGRAS R√çGIDAS:
1. Use esta estrutura HTML base:
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.name}</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f8fafc; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; 
        }
        .btn { padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; }
    </style>
    ${data.type === 'READ' ? '<script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>' : ''}
</head>
<body data-page-id="${pageId}" data-page-type="${data.type}">
    <div class="container">
        <h2>${data.name}</h2>
        ${example}
    </div>
    <script src="../core/engine.js"><\/script>
</body>
</html>

2. N√ÉO use dados falsos (Math.random).
3. Se for WRITE, use inputs com 'data-bind="schema.campo"' (ex: data-bind="venda.cliente").
4. Se for READ, use 'data-bind' para exibir valores (ex: data-bind="vendas.total").
5. O bot√£o de salvar DEVE ter: data-action="commit"
6. Use nomes de schema: venda, despesa, pedido, cliente, produto, etc.`;

        document.getElementById('protocolText').textContent = prompt;
        document.getElementById('protocolBox').style.display = 'block';
        showStatus('Prompt gerado! Copie e envie para a IA.', 'success');
    }

    // A√ß√£o 2: Registrar no Sistema
    function registerPage() {
        const data = validate();
        if (!data) return;

        // Gerar c√≥digo do menu para colar na pasta menu
        const menuCode = `{
  id: "nav_${data.file}",
  name: "${data.name}",
  file: "pages/${data.file}.html",
  type: "${data.type}",
  pos: 100,
  hidden: false,
  deleted: false
},`;

        // Mostrar o c√≥digo na caixa de protocolo
        document.getElementById('protocolText').textContent = menuCode;
        document.getElementById('protocolBox').style.display = 'block';
        
        // Atualizar t√≠tulo da caixa
        document.querySelector('#protocolBox strong').textContent = 'C√≥digo do Menu - Copie e cole em menu/menu.config.js (dentro do array MENU_CONFIG):';
        
        showStatus('C√≥digo do menu gerado! Copie e cole em menu/menu.config.js', 'success');
    }

    // M√©todo de fallback para garantir o salvamento
    function tryFallbackRegistration(page) {
        try {
            const systemSettingsStr = localStorage.getItem('system_settings');
            
            if (systemSettingsStr) {
                const systemSettings = JSON.parse(systemSettingsStr);
                
                if (!systemSettings.menu_config) {
                    systemSettings.menu_config = [];
                }
                
                const exists = systemSettings.menu_config.some(p => 
                    p.name === page.name || p.file === page.file
                );
                
                if (!exists) {
                    systemSettings.menu_config.push(page);
                    localStorage.setItem('system_settings', JSON.stringify(systemSettings));
                    
                    console.log('‚úÖ P√°gina registrada via fallback:', page);
                    
                    setTimeout(() => {
                        showStatus('‚úÖ P√°gina salva no sistema! Reinicie o sistema para ver no menu.', 'success');
                    }, 2000);
                }
            }
        } catch (error) {
            console.warn('Fallback n√£o funcionou:', error);
        }
    }

    function copyToClipboard() {
        const text = document.getElementById('protocolText').textContent;
        navigator.clipboard.writeText(text);
        showStatus('Copiado para a √°rea de transfer√™ncia!', 'success');
    }

    // Configurar listener para resposta do sistema principal
    window.addEventListener('message', function(event) {
        console.log('F√°brica recebeu mensagem:', event.data);
        
        if (event.data.type === "PAGE_REGISTERED") {
            showStatus(`‚úÖ P√°gina registrada com sucesso! ID: ${event.data.pageId}`, 'success');
        }
    });

    // Dica inicial
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            showStatus('üí° Dica: Crie o arquivo HTML primeiro na pasta /pages/, depois registre aqui.', 'info');
        }, 1000);
    });
</script>

</body>
</html>
