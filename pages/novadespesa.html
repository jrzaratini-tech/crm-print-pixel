<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Despesa - PrintPixel</title>
    <style>
        /* Estilo para mensagem de sucesso */
        .success-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Estilos principais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background-color: #f8fafc;
            color: #1e293b;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 18px;
            color: #dc2626;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dc2626;
            font-weight: 600;
            letter-spacing: -0.2px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #334155;
            font-size: 14px;
            letter-spacing: 0.2px;
        }
        
        input, select, textarea {
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.2s;
            background-color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        input[type="date"] {
            padding: 11px 16px;
        }
        
        input[type="number"] {
            text-align: right;
        }
        
        input[type="file"] {
            padding: 10px;
            border: 2px dashed #e2e8f0;
            background: #f8fafc;
            cursor: pointer;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }
        
        .radio-option label {
            margin-bottom: 0;
            font-weight: 500;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pago {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }
        
        .file-preview {
            margin-top: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: none;
        }
        
        .file-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            margin-top: 8px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 14px;
            color: #64748b;
        }
        
        .compression-info {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
            font-style: italic;
        }
        
        .total-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1.5px solid #e2e8f0;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 18px;
            color: #dc2626;
        }
        
        .categoria-select {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 15px;
            background-color: white;
            cursor: pointer;
        }
        
        .outra-categoria-input {
            margin-top: 12px;
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 15px;
            width: 100%;
            display: none;
        }
        
        .outra-categoria-input.active {
            display: block;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }
        
        .btn-cancel {
            background-color: #64748b;
            color: white;
            border: none;
            padding: 15px 32px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .btn-cancel:hover {
            background-color: #475569;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.2);
        }
        
        .btn-save {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 15px 32px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .btn-save:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
        }
        
        .btn-save.saving {
            background-color: #059669;
            opacity: 0.8;
        }
        
        .btn-save.success {
            background-color: #059669;
        }
        
        .required::after {
            content: " *";
            color: #ef4444;
        }
        
        .field-note {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn-cancel, .btn-save {
                width: 100%;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 12px;
            }
            
            .success-message {
                bottom: 10px;
                right: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body data-page-id="nova_despesa" data-page-type="WRITE">
    <div class="container">
        <form id="despesaForm">
            <input type="hidden" id="despesaId" data-bind="despesa.id" value="">
            
            <div class="form-section">
                <h2 class="section-title">Informações da Despesa</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fornecedor" class="required">Fornecedor</label>
                        <input type="text" id="fornecedor" name="fornecedor" data-bind="despesa.fornecedor" placeholder="Nome do fornecedor" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="descricao" class="required">Descrição da Despesa</label>
                        <input type="text" id="descricao" name="descricao" data-bind="despesa.descricao" placeholder="Ex: Compra de material gráfico" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="telefone">Telefone do Fornecedor</label>
                        <input type="tel" id="telefone" name="telefone" data-bind="despesa.telefone" placeholder="Ex: 912345678">
                    </div>
                    
                    <div class="form-group">
                        <label for="nifFornecedor">NIF do Fornecedor</label>
                        <input type="text" id="nifFornecedor" name="nifFornecedor" data-bind="despesa.nifFornecedor" placeholder="Número de identificação fiscal">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Datas</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="dataCompra" class="required">Data da Compra</label>
                        <input type="date" id="dataCompra" name="dataCompra" data-bind="despesa.dataCompra" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataVencimento" class="required">Data de Vencimento</label>
                        <input type="date" id="dataVencimento" name="dataVencimento" data-bind="despesa.dataVencimento" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataPagamento">Data do Pagamento</label>
                        <input type="date" id="dataPagamento" name="dataPagamento" data-bind="despesa.dataPagamento">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Valores</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="valorBruto" class="required">Valor Bruto (sem IVA)</label>
                        <input type="number" id="valorBruto" name="valorBruto" data-bind="despesa.valorBruto" min="0" step="0.01" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label>IVA</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="ivaSim" name="ivaOption" value="comIVA" data-bind="despesa.comIVA" checked>
                                <label for="ivaSim">Com IVA (23%)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="ivaNao" name="ivaOption" value="isento" data-bind="despesa.comIVA">
                                <label for="ivaNao">Isento</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Status do Pagamento</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="statusPago" name="statusPagamento" value="pago" data-bind="despesa.statusPagamento" checked>
                                <label for="statusPago"><span class="status-badge status-pago">Pago</span></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="statusPendente" name="statusPagamento" value="pendente" data-bind="despesa.statusPagamento">
                                <label for="statusPendente"><span class="status-badge status-pendente">A Pagar</span></label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="total-section">
                    <div class="total-row">
                        <span>Valor Bruto (sem IVA):</span>
                        <span id="valorBrutoDisplay">€0.00</span>
                    </div>
                    <div class="total-row">
                        <span>IVA (23%):</span>
                        <span id="valorIVADisplay">€0.00</span>
                    </div>
                    <div class="total-row">
                        <span>TOTAL (com IVA):</span>
                        <span id="valorTotalDisplay">€0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Categoria</h2>
                
                <div class="form-group">
                    <label for="categoria" class="required">Selecione uma Categoria</label>
                    <select id="categoria" name="categoria" class="categoria-select" data-bind="despesa.categoria" required>
                        <option value="">Selecione uma categoria...</option>
                        <option value="ÁGUA">ÁGUA</option>
                        <option value="AMAZON">AMAZON</option>
                        <option value="ALIMENTAÇÃO">ALIMENTAÇÃO</option>
                        <option value="ARRENDAMENTO">ARRENDAMENTO</option>
                        <option value="COMISSÃO">COMISSÃO</option>
                        <option value="CONTABILIDADE">CONTABILIDADE</option>
                        <option value="CTT">CTT</option>
                        <option value="COMBUSTÍVEL">COMBUSTÍVEL</option>
                        <option value="CAFÉ">CAFÉ</option>
                        <option value="DIMATUR">DIMATUR</option>
                        <option value="DAGOL">DAGOL</option>
                        <option value="ENERGIA">ENERGIA</option>
                        <option value="FILAMENTO 3D">FILAMENTO 3D</option>
                        <option value="IMPOSTOS">IMPOSTOS</option>
                        <option value="LEROY MERLIN">LEROY MERLIN</option>
                        <option value="LUZACRIL">LUZACRIL</option>
                        <option value="MANUTENÇÃO">MANUTENÇÃO</option>
                        <option value="MATERIAL ESCRITORIO">MATERIAL ESCRITORIO</option>
                        <option value="MAKRO">MAKRO</option>
                        <option value="PLOTTERZONE">PLOTTERZONE</option>
                        <option value="POLEGADA LED">POLEGADA LED</option>
                        <option value="SALÁRIO">SALÁRIO</option>
                        <option value="SANTANDER">SANTANDER</option>
                        <option value="TRANSPORTE">TRANSPORTE</option>
                        <option value="TELEFONE/INTERNET">TELEFONE/INTERNET</option>
                        <option value="WEDDT">WEDDT</option>
                        <option value="OUTROS">OUTROS</option>
                    </select>
                    
                    <input type="text" id="outraCategoriaInput" class="outra-categoria-input" data-bind="despesa.outraCategoria" placeholder="Especifique outra categoria...">
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Forma de Pagamento</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="formaPagamento" class="required">Método de Pagamento</label>
                        <select id="formaPagamento" name="formaPagamento" class="categoria-select" data-bind="despesa.formaPagamento" required>
                            <option value="">Selecione a forma de pagamento...</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="mbway">MBWay</option>
                            <option value="transferencia">Transferência Bancária</option>
                            <option value="cartao">Cartão de Crédito/Débito</option>
                            <option value="cheque">Cheque</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="outroPagamento">Especificar Outro</label>
                        <input type="text" id="outroPagamento" name="outroPagamento" data-bind="despesa.outroPagamento" placeholder="Especifique a forma de pagamento">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Anexos e Observações</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="observacoes">Observações</label>
                        <textarea id="observacoes" name="observacoes" data-bind="despesa.observacoes" rows="4" placeholder="Observações sobre a despesa..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="notaFiscal">Anexar Nota Fiscal/Fatura</label>
                        <input type="file" id="notaFiscal" name="notaFiscal" accept="image/*,.pdf,.doc,.docx">
                        <div class="field-note">Formatos aceitos: JPG, PNG, PDF, DOC (máx. 2MB). Imagens serão otimizadas.</div>
                        <div class="field-note">Dica: Para melhor otimização, use PDF para documentos e JPG para imagens.</div>
                        <div class="file-preview" id="filePreview">
                            <div id="fileName"></div>
                            <div class="file-info" id="fileInfo"></div>
                            <div class="compression-info" id="compressionInfo"></div>
                            <img id="fileImage" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Campos ocultos para totais (usados pelo engine.js) -->
            <input type="hidden" id="despesaValorTotal" data-bind="despesa.valorTotal" value="0">
            <input type="hidden" id="despesaValorIVA" data-bind="despesa.valorIVA" value="0">
            <input type="hidden" id="despesaNotaFiscal" data-bind="despesa.notaFiscal" value="">
            <input type="hidden" id="despesaTipoArquivo" data-bind="despesa.tipoArquivo" value="">
            <input type="hidden" id="despesaTamanhoOriginal" data-bind="despesa.tamanhoOriginal" value="">
            <input type="hidden" id="despesaTamanhoOtimizado" data-bind="despesa.tamanhoOtimizado" value="">
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="cancelBtn">CANCELAR</button>
                <button type="button" class="btn-save" id="saveBtn" data-action="commit">SALVAR DESPESA</button>
            </div>
        </form>
    </div>

    <script>
        // ============================================
        // VARIÁVEIS GLOBAIS E REFERÊNCIAS
        // ============================================
        let isEditMode = false;
        let currentDespesaId = '';
        let notaFiscalBase64 = '';
        let tipoArquivo = '';
        let tamanhoOriginal = 0;
        let tamanhoOtimizado = 0;
        
        // Referências DOM
        const despesaForm = document.getElementById('despesaForm');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const categoriaSelect = document.getElementById('categoria');
        const outraCategoriaInput = document.getElementById('outraCategoriaInput');
        const formaPagamentoSelect = document.getElementById('formaPagamento');
        const outroPagamentoInput = document.getElementById('outroPagamento');
        const notaFiscalInput = document.getElementById('notaFiscal');
        const filePreview = document.getElementById('filePreview');
        
        // Elementos para cálculo
        const valorBrutoInput = document.getElementById('valorBruto');
        const ivaSimRadio = document.getElementById('ivaSim');
        const ivaNaoRadio = document.getElementById('ivaNao');
        const valorBrutoDisplay = document.getElementById('valorBrutoDisplay');
        const valorIVADisplay = document.getElementById('valorIVADisplay');
        const valorTotalDisplay = document.getElementById('valorTotalDisplay');
        
        // Campos ocultos para valores calculados
        const valorTotalHidden = document.getElementById('despesaValorTotal');
        const valorIVAHidden = document.getElementById('despesaValorIVA');
        const notaFiscalHidden = document.getElementById('despesaNotaFiscal');
        const tipoArquivoHidden = document.getElementById('despesaTipoArquivo');
        const tamanhoOriginalHidden = document.getElementById('despesaTamanhoOriginal');
        const tamanhoOtimizadoHidden = document.getElementById('despesaTamanhoOtimizado');
        
        // ============================================
        // FUNÇÕES DE COMPRESSÃO DE IMAGEM
        // ============================================
        
        // Função para comprimir imagem
        function comprimirImagem(file, maxWidth = 1024, quality = 0.7) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) {
                    // Não é imagem, retornar o arquivo original
                    resolve({
                        base64: '',
                        tipo: file.type,
                        tamanhoOriginal: file.size,
                        tamanhoOtimizado: file.size
                    });
                    return;
                }
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Redimensionar se necessário
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Converter para JPG com qualidade otimizada
                        const base64 = canvas.toDataURL('image/jpeg', quality);
                        
                        resolve({
                            base64: base64,
                            tipo: 'image/jpeg',
                            tamanhoOriginal: file.size,
                            tamanhoOtimizado: Math.round((base64.length * 3) / 4)
                        });
                    };
                    
                    img.onerror = reject;
                };
                
                reader.onerror = reject;
            });
        }
        
        // Função para processar PDF ou outros documentos
        function processarDocumento(file, maxSizeKB = 200) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = (event) => {
                    let base64 = event.target.result;
                    let tamanhoOtimizado = Math.round((base64.length * 3) / 4);
                    
                    // Se for muito grande, tentar reduzir
                    if (tamanhoOtimizado > maxSizeKB * 1024) {
                        // Para documentos, apenas armazenamos referência e não o conteúdo completo
                        // Em produção, você pode querer usar storage externo como Firebase Storage
                        showMessage('Documento muito grande. Salve apenas o número da nota ou referência.', 'warning');
                        resolve({
                            base64: '',
                            tipo: file.type,
                            tamanhoOriginal: file.size,
                            tamanhoOtimizado: 0,
                            referencia: file.name
                        });
                    } else {
                        resolve({
                            base64: base64,
                            tipo: file.type,
                            tamanhoOriginal: file.size,
                            tamanhoOtimizado: tamanhoOtimizado
                        });
                    }
                };
                
                reader.onerror = reject;
            });
        }
        
        // ============================================
        // FUNÇÕES PRINCIPAIS
        // ============================================
        
        // Função para inicializar o formulário
        function inicializarFormulario() {
            configurarEventListeners();
            calcularTotais();
            configurarDatasPadrao();
            
            // Inicializar campos condicionais
            // Categoria: se não for "OUTROS", desabilitar e remover data-bind do campo outraCategoriaInput
            if (categoriaSelect.value !== 'OUTROS') {
                outraCategoriaInput.disabled = true;
                outraCategoriaInput.removeAttribute('data-bind');
            }
            
            // Forma de pagamento: se não for "outro", desabilitar e remover data-bind do campo outroPagamentoInput
            if (formaPagamentoSelect.value !== 'outro') {
                outroPagamentoInput.disabled = true;
                outroPagamentoInput.removeAttribute('data-bind');
            }
            
            console.log('✅ Formulário de despesa inicializado');
        }
        
        // Função para configurar datas padrão
        function configurarDatasPadrao() {
            const hoje = new Date();
            const amanha = new Date(hoje);
            amanha.setDate(amanha.getDate() + 1);
            
            document.getElementById('dataCompra').valueAsDate = hoje;
            document.getElementById('dataVencimento').valueAsDate = amanha;
            document.getElementById('dataPagamento').valueAsDate = hoje;
        }
        
        // Função para calcular totais
        function calcularTotais() {
            const valorBruto = parseFloat(valorBrutoInput.value) || 0;
            
            // Se tem IVA, calcular o valor com IVA (23%)
            if (ivaSimRadio.checked) {
                const valorComIVA = valorBruto * 1.23;
                const valorIVA = valorComIVA - valorBruto;
                
                // Atualizar displays
                valorBrutoDisplay.textContent = formatarMoeda(valorBruto);
                valorIVADisplay.textContent = formatarMoeda(valorIVA);
                valorTotalDisplay.textContent = formatarMoeda(valorComIVA);
                
                // Atualizar campos ocultos (serão usados pelo engine.js)
                valorTotalHidden.value = valorComIVA.toFixed(2);
                valorIVAHidden.value = valorIVA.toFixed(2);
            } else {
                // Se isento de IVA
                valorBrutoDisplay.textContent = formatarMoeda(valorBruto);
                valorIVADisplay.textContent = '€0.00';
                valorTotalDisplay.textContent = formatarMoeda(valorBruto);
                
                // Atualizar campos ocultos
                valorTotalHidden.value = valorBruto.toFixed(2);
                valorIVAHidden.value = '0.00';
            }
        }
        
        // Função para formatar moeda
        function formatarMoeda(valor) {
            return '€' + valor.toFixed(2).replace('.', ',');
        }
        
        // Função para processar anexo de nota fiscal
        async function processarNotaFiscal(file) {
            if (!file) {
                limparNotaFiscal();
                return;
            }
            
            // Verificar tamanho do arquivo (máx. 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showMessage('O arquivo é muito grande (máx. 5MB).', 'error');
                notaFiscalInput.value = '';
                limparNotaFiscal();
                return;
            }
            
            // Mostrar preview inicial
            filePreview.style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileInfo').textContent = 
                `Tipo: ${file.type} • Tamanho original: ${(file.size / 1024).toFixed(2)}KB`;
            document.getElementById('compressionInfo').textContent = 'Otimizando arquivo...';
            
            try {
                let resultado;
                
                if (file.type.startsWith('image/')) {
                    // Comprimir imagem
                    resultado = await comprimirImagem(file, 1024, 0.7);
                    
                    // Mostrar preview da imagem otimizada
                    const fileImage = document.getElementById('fileImage');
                    fileImage.src = resultado.base64;
                    fileImage.style.display = 'block';
                    
                    document.getElementById('compressionInfo').textContent = 
                        `Imagem otimizada: ${(resultado.tamanhoOtimizado / 1024).toFixed(2)}KB (redução de ${((1 - resultado.tamanhoOtimizado/file.size) * 100).toFixed(1)}%)`;
                } else if (file.type === 'application/pdf' || 
                          file.type.includes('document') || 
                          file.type.includes('msword') || 
                          file.type.includes('wordprocessing')) {
                    // Processar documento
                    resultado = await processarDocumento(file, 200);
                    
                    if (resultado.base64) {
                        document.getElementById('compressionInfo').textContent = 
                            `Documento: ${(resultado.tamanhoOtimizado / 1024).toFixed(2)}KB`;
                    } else {
                        document.getElementById('compressionInfo').textContent = 
                            `Documento armazenado como referência apenas: ${resultado.referencia}`;
                    }
                    
                    document.getElementById('fileImage').style.display = 'none';
                } else {
                    // Outros tipos de arquivo
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    
                    reader.onload = (event) => {
                        resultado = {
                            base64: event.target.result,
                            tipo: file.type,
                            tamanhoOriginal: file.size,
                            tamanhoOtimizado: Math.round((event.target.result.length * 3) / 4)
                        };
                        
                        document.getElementById('compressionInfo').textContent = 
                            `Arquivo: ${(resultado.tamanhoOtimizado / 1024).toFixed(2)}KB`;
                    };
                    
                    await new Promise(resolve => reader.onloadend = resolve);
                }
                
                // Armazenar dados
                notaFiscalBase64 = resultado.base64;
                tipoArquivo = resultado.tipo;
                tamanhoOriginal = resultado.tamanhoOriginal;
                tamanhoOtimizado = resultado.tamanhoOtimizado || resultado.tamanhoOriginal;
                
                // Atualizar campos ocultos
                notaFiscalHidden.value = notaFiscalBase64;
                tipoArquivoHidden.value = tipoArquivo;
                tamanhoOriginalHidden.value = tamanhoOriginal;
                tamanhoOtimizadoHidden.value = tamanhoOtimizado;
                
            } catch (error) {
                console.error('Erro ao processar arquivo:', error);
                showMessage('Erro ao processar arquivo. Tente novamente.', 'error');
                limparNotaFiscal();
            }
        }
        
        // Função para limpar nota fiscal
        function limparNotaFiscal() {
            notaFiscalBase64 = '';
            tipoArquivo = '';
            tamanhoOriginal = 0;
            tamanhoOtimizado = 0;
            filePreview.style.display = 'none';
            
            // Limpar campos ocultos
            notaFiscalHidden.value = '';
            tipoArquivoHidden.value = '';
            tamanhoOriginalHidden.value = '';
            tamanhoOtimizadoHidden.value = '';
        }
        
        // Função para validar o formulário
        function validarFormulario() {
            const camposObrigatorios = ['fornecedor', 'descricao', 'dataCompra', 'dataVencimento', 'valorBruto', 'categoria', 'formaPagamento'];
            
            for (const campoId of camposObrigatorios) {
                const campo = document.getElementById(campoId);
                if (!campo.value.trim()) {
                    showMessage(`O campo "${campo.previousElementSibling?.textContent.replace(' *', '') || campoId}" é obrigatório.`, 'warning');
                    campo.focus();
                    return false;
                }
            }
            
            // Validação especial para categoria "Outros"
            if (categoriaSelect.value === 'OUTROS' && !outraCategoriaInput.value.trim()) {
                showMessage('Por favor, especifique a categoria "Outros".', 'warning');
                outraCategoriaInput.focus();
                return false;
            }
            
            // Validação especial para forma de pagamento "Outro"
            if (formaPagamentoSelect.value === 'outro' && !outroPagamentoInput.value.trim()) {
                showMessage('Por favor, especifique a forma de pagamento "Outro".', 'warning');
                outroPagamentoInput.focus();
                return false;
            }
            
            // Validação de valor bruto
            const valorBruto = parseFloat(document.getElementById('valorBruto').value);
            if (isNaN(valorBruto) || valorBruto <= 0) {
                showMessage('Por favor, insira um valor bruto válido (maior que 0).', 'warning');
                document.getElementById('valorBruto').focus();
                return false;
            }
            
            // Validação da data de vencimento
            const dataCompra = new Date(document.getElementById('dataCompra').value);
            const dataVencimento = new Date(document.getElementById('dataVencimento').value);
            if (dataVencimento < dataCompra) {
                showMessage('A data de vencimento não pode ser anterior à data da compra.', 'warning');
                document.getElementById('dataVencimento').focus();
                return false;
            }
            
            // Se status é "Pago", data de pagamento é obrigatória
            const statusPago = document.getElementById('statusPago').checked;
            if (statusPago && !document.getElementById('dataPagamento').value) {
                showMessage('A data de pagamento é obrigatória quando o status é "Pago".', 'warning');
                document.getElementById('dataPagamento').focus();
                return false;
            }
            
            // Verificar tamanho do arquivo otimizado
            if (tamanhoOtimizado > 500 * 1024) { // 500KB
                if (!confirm(`A nota fiscal otimizada tem ${(tamanhoOtimizado / 1024).toFixed(2)}KB. Isso pode sobrecarregar o banco de dados. Deseja continuar?`)) {
                    return false;
                }
            }
            
            return true;
        }
        
        // Função para mostrar mensagens
        function showMessage(message, type = 'info') {
            // Remover mensagens anteriores
            const existingMessages = document.querySelectorAll('.success-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            
            // Cor baseada no tipo
            if (type === 'warning') {
                messageDiv.style.backgroundColor = '#f59e0b';
            } else if (type === 'error') {
                messageDiv.style.backgroundColor = '#ef4444';
            } else if (type === 'success') {
                messageDiv.style.backgroundColor = '#10b981';
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
        
        // Função para limpar o formulário
        function limparFormulario() {
            despesaForm.reset();
            limparNotaFiscal();
            outraCategoriaInput.classList.remove('active');
            outraCategoriaInput.value = '';
            outraCategoriaInput.disabled = true;
            outraCategoriaInput.removeAttribute('data-bind');
            outroPagamentoInput.disabled = true;
            outroPagamentoInput.value = '';
            outroPagamentoInput.removeAttribute('data-bind');
            calcularTotais();
            configurarDatasPadrao();
            
            // Resetar modo de edição
            isEditMode = false;
            currentDespesaId = '';
            
            showMessage('Formulário limpo. Pronto para nova despesa.', 'info');
        }
        
        function inicializarFormulario() {
            configurarEventListeners();
            configurarDatasPadrao();
            calcularTotais();
            showMessage('Formulário pronto para nova despesa.', 'success');
        }
        
        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar se é modo de edição
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            
            if (editId) {
                // Modo de edição - carregar despesa existente
                console.log('Modo edição para despesa ID:', editId);
                showMessage('Carregando despesa para edição...', 'info');
                loadDespesaForEdit(editId);
            } else {
                // Configurar novo formulário
                inicializarFormulario();
            }
            
            // Configurar listener para evento do engine.js
            document.addEventListener('coreCommitSuccess', (event) => {
                const detail = event.detail || {};
                
                if (detail.schema === 'despesa') {
                    // Feedback de sucesso
                    saveBtn.classList.remove('saving');
                    saveBtn.textContent = '✓ SALVO!';
                    
                    showMessage(`Despesa ${isEditMode ? 'atualizada' : 'criada'} com sucesso!`, 'success');
                    
                    // Redirecionar após 2 segundos
                    setTimeout(() => {
                        if (confirm(`Despesa ${isEditMode ? 'atualizada' : 'criada'} com sucesso! Deseja criar uma nova despesa?`)) {
                            limparFormulario();
                            saveBtn.textContent = 'SALVAR DESPESA';
                            saveBtn.disabled = false;
                        } else {
                            window.location.href = 'despesas.html';
                        }
                    }, 2000);
                }
            });
            
            document.addEventListener('coreCommitError', (event) => {
                console.error('Erro no commit:', event.detail);
                saveBtn.classList.remove('saving');
                saveBtn.textContent = isEditMode ? 'ATUALIZAR DESPESA' : 'SALVAR DESPESA';
                saveBtn.disabled = false;
                
                showMessage('Erro ao salvar despesa. Tente novamente.', 'error');
            });
        });
        
        // Data de pagamento condicional
        document.querySelectorAll('input[name="statusPagamento"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const dataPagamentoInput = document.getElementById('dataPagamento');
                if (e.target.value === 'pago') {
                    dataPagamentoInput.required = true;
                    dataPagamentoInput.disabled = false;
                    dataPagamentoInput.valueAsDate = new Date();
                } else {
                    dataPagamentoInput.required = false;
                    dataPagamentoInput.disabled = true;
                }
            });
        });
    </script>
    
    <!-- CONEXÃO COM O CORE ENGINE -->
    <script src="../core/engine.js"></script>
</body>
</html>