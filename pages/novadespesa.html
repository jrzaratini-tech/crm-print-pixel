<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio de Despesa - PrintPixel</title>
    <style>
        /* Estilo para mensagem de sucesso */
        .success-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Estilos principais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background-color: #f8fafc;
            color: #1e293b;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 18px;
            color: #dc2626;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dc2626;
            font-weight: 600;
            letter-spacing: -0.2px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #334155;
            font-size: 14px;
            letter-spacing: 0.2px;
        }
        
        input, select, textarea {
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.2s;
            background-color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        input[type="date"] {
            padding: 11px 16px;
        }
        
        input[type="number"] {
            text-align: right;
        }
        
        input[type="file"] {
            padding: 10px;
            border: 2px dashed #e2e8f0;
            background: #f8fafc;
            cursor: pointer;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }
        
        .radio-option label {
            margin-bottom: 0;
            font-weight: 500;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pago {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }
        
        .file-preview {
            margin-top: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: none;
        }
        
        .file-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            margin-top: 8px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 14px;
            color: #64748b;
        }
        
        .compression-info {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
            font-style: italic;
        }
        
        .total-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1.5px solid #e2e8f0;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 18px;
            color: #dc2626;
        }
        
        .categoria-select {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 15px;
            background-color: white;
            cursor: pointer;
        }
        
        .outra-categoria-input {
            margin-top: 12px;
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 15px;
            width: 100%;
            display: none;
        }
        
        .outra-categoria-input.active {
            display: block;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }
        
        .btn-cancel {
            background-color: #64748b;
            color: white;
            border: none;
            padding: 15px 32px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .btn-cancel:hover {
            background-color: #475569;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.2);
        }
        
        .btn-save {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 15px 32px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .btn-save:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
        }
        
        .btn-save.saving {
            background-color: #059669;
            opacity: 0.8;
        }
        
        .btn-save.success {
            background-color: #059669;
        }
        
        .required::after {
            content: " *";
            color: #ef4444;
        }
        
        .field-note {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn-cancel, .btn-save {
                width: 100%;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 12px;
            }
            
            .success-message {
                bottom: 10px;
                right: 10px;
                left: 10px;
            }
        }
    </style>
</head>
<body data-page-id="nova_despesa" data-page-type="WRITE">
    <div class="container">
        <form id="despesaForm">
            <!-- üî• CR√çTICO: Campo hidden para ID (PADR√ÉO PEDIDOS) -->
            <input type="hidden" id="despesaId" data-bind="despesa.id" value="">
            
            <div class="form-section">
                <h2 class="section-title">Informa√ß√µes da Despesa</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fornecedor" class="required">Fornecedor</label>
                        <input type="text" id="fornecedor" name="fornecedor" data-bind="despesa.fornecedor" placeholder="Nome do fornecedor" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="descricao" class="required">Descri√ß√£o da Despesa</label>
                        <input type="text" id="descricao" name="descricao" data-bind="despesa.descricao" placeholder="Ex: Compra de material gr√°fico" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="telefone">Telefone do Fornecedor</label>
                        <input type="tel" id="telefone" name="telefone" data-bind="despesa.telefone" placeholder="Ex: 912345678">
                    </div>
                    
                    <div class="form-group">
                        <label for="nifFornecedor">NIF do Fornecedor</label>
                        <input type="text" id="nifFornecedor" name="nifFornecedor" data-bind="despesa.nifFornecedor" placeholder="N√∫mero de identifica√ß√£o fiscal">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Datas</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="dataCompra" class="required">Data da Compra</label>
                        <input type="date" id="dataCompra" name="dataCompra" data-bind="despesa.dataCompra" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataVencimento" class="required">Data de Vencimento</label>
                        <input type="date" id="dataVencimento" name="dataVencimento" data-bind="despesa.dataVencimento" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataPagamento">Data do Pagamento</label>
                        <input type="date" id="dataPagamento" name="dataPagamento" data-bind="despesa.dataPagamento">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Valores</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="valorBruto" class="required">Valor Bruto (sem IVA)</label>
                        <input type="number" id="valorBruto" name="valorBruto" data-bind="despesa.valorBruto" min="0" step="0.01" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label>IVA</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="ivaSim" name="ivaOption" value="sim" data-bind="despesa.comIVA" checked>
                                <label for="ivaSim">Com IVA (23%)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="ivaNao" name="ivaOption" value="nao" data-bind="despesa.comIVA">
                                <label for="ivaNao">Isento</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Status do Pagamento</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="statusPago" name="statusPagamento" value="pago" data-bind="despesa.statusPagamento" checked>
                                <label for="statusPago"><span class="status-badge status-pago">Pago</span></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="statusPendente" name="statusPagamento" value="pendente" data-bind="despesa.statusPagamento">
                                <label for="statusPendente"><span class="status-badge status-pendente">A Pagar</span></label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="total-section">
                    <div class="total-row">
                        <span>Valor Bruto (sem IVA):</span>
                        <span id="valorBrutoDisplay">‚Ç¨0.00</span>
                    </div>
                    <div class="total-row">
                        <span>IVA (23%):</span>
                        <span id="valorIVADisplay">‚Ç¨0.00</span>
                    </div>
                    <div class="total-row">
                        <span>TOTAL (com IVA):</span>
                        <span id="valorTotalDisplay">‚Ç¨0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Categoria</h2>
                
                <div class="form-group">
                    <label for="categoria" class="required">Selecione uma Categoria</label>
                    <select id="categoria" name="categoria" class="categoria-select" data-bind="despesa.categoria" required>
                        <option value="">Selecione uma categoria...</option>
                        <option value="√ÅGUA">√ÅGUA</option>
                        <option value="AMAZON">AMAZON</option>
                        <option value="ALIMENTA√á√ÉO">ALIMENTA√á√ÉO</option>
                        <option value="ARRENDAMENTO">ARRENDAMENTO</option>
                        <option value="COMISS√ÉO">COMISS√ÉO</option>
                        <option value="CONTABILIDADE">CONTABILIDADE</option>
                        <option value="CTT">CTT</option>
                        <option value="COMBUST√çVEL">COMBUST√çVEL</option>
                        <option value="CAF√â">CAF√â</option>
                        <option value="DIMATUR">DIMATUR</option>
                        <option value="DAGOL">DAGOL</option>
                        <option value="ENERGIA">ENERGIA</option>
                        <option value="FILAMENTO 3D">FILAMENTO 3D</option>
                        <option value="IMPOSTOS">IMPOSTOS</option>
                        <option value="LEROY MERLIN">LEROY MERLIN</option>
                        <option value="LUZACRIL">LUZACRIL</option>
                        <option value="MANUTEN√á√ÉO">MANUTEN√á√ÉO</option>
                        <option value="MATERIAL ESCRITORIO">MATERIAL ESCRITORIO</option>
                        <option value="MAKRO">MAKRO</option>
                        <option value="PLOTTERZONE">PLOTTERZONE</option>
                        <option value="POLEGADA LED">POLEGADA LED</option>
                        <option value="SAL√ÅRIO">SAL√ÅRIO</option>
                        <option value="SANTANDER">SANTANDER</option>
                        <option value="TRANSPORTE">TRANSPORTE</option>
                        <option value="TELEFONE/INTERNET">TELEFONE/INTERNET</option>
                        <option value="WEDDT">WEDDT</option>
                        <option value="OUTROS">OUTROS</option>
                    </select>
                    
                    <input type="text" id="outraCategoriaInput" class="outra-categoria-input" data-bind="despesa.outraCategoria" placeholder="Especifique outra categoria...">
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Forma de Pagamento</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="formaPagamento" class="required">M√©todo de Pagamento</label>
                        <select id="formaPagamento" name="formaPagamento" class="categoria-select" data-bind="despesa.formaPagamento" required>
                            <option value="">Selecione a forma de pagamento...</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="mbway">MBWay</option>
                            <option value="transferencia">Transfer√™ncia Banc√°ria</option>
                            <option value="cartao">Cart√£o de Cr√©dito/D√©bito</option>
                            <option value="cheque">Cheque</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="outroPagamento">Especificar Outro</label>
                        <input type="text" id="outroPagamento" name="outroPagamento" data-bind="despesa.outroPagamento" placeholder="Especifique a forma de pagamento">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Anexos e Observa√ß√µes</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="observacoes">Observa√ß√µes</label>
                        <textarea id="observacoes" name="observacoes" data-bind="despesa.observacoes" rows="4" placeholder="Observa√ß√µes sobre a despesa..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="notaFiscal">Anexar Nota Fiscal/Fatura</label>
                        <input type="file" id="notaFiscal" name="notaFiscal" accept="image/*,.pdf,.doc,.docx">
                        <div class="field-note">Formatos aceitos: JPG, PNG, PDF, DOC (m√°x. 2MB). Imagens ser√£o otimizadas.</div>
                        <div class="field-note">Dica: Para melhor otimiza√ß√£o, use PDF para documentos e JPG para imagens.</div>
                        <div class="file-preview" id="filePreview">
                            <div id="fileName"></div>
                            <div class="file-info" id="fileInfo"></div>
                            <div class="compression-info" id="compressionInfo"></div>
                            <img id="fileImage" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Campos ocultos para totais (usados pelo engine.js) -->
            <input type="hidden" id="despesaValorTotal" data-bind="despesa.valorTotal" value="0">
            <input type="hidden" id="despesaValorIVA" data-bind="despesa.valorIVA" value="0">
            <input type="hidden" id="despesaNotaFiscal" data-bind="despesa.notaFiscal" value="">
            <input type="hidden" id="despesaTipoArquivo" data-bind="despesa.tipoArquivo" value="">
            <input type="hidden" id="despesaTamanhoOriginal" data-bind="despesa.tamanhoOriginal" value="">
            <input type="hidden" id="despesaTamanhoOtimizado" data-bind="despesa.tamanhoOtimizado" value="">
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="cancelBtn">CANCELAR</button>
                <button type="button" class="btn-save" id="saveBtn" data-action="commit">SALVAR DESPESA</button>
            </div>
        </form>
    </div>

    <script>
        // ============================================
        // SISTEMA DE DESPESAS - VERS√ÉO CORRIGIDA (PADR√ÉO PEDIDOS)
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üí∞ Sistema de despesas inicializado v2.0');
            
            // Vari√°veis globais
            let isEditMode = false;
            let currentDespesaId = '';
            let notaFiscalBase64 = '';
            let tipoArquivo = '';
            let tamanhoOriginal = 0;
            let tamanhoOtimizado = 0;
            
            // Refer√™ncias DOM
            const despesaForm = document.getElementById('despesaForm');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const despesaIdInput = document.getElementById('despesaId');
            const categoriaSelect = document.getElementById('categoria');
            const outraCategoriaInput = document.getElementById('outraCategoriaInput');
            const formaPagamentoSelect = document.getElementById('formaPagamento');
            const outroPagamentoInput = document.getElementById('outroPagamento');
            const notaFiscalInput = document.getElementById('notaFiscal');
            const filePreview = document.getElementById('filePreview');
            
            // Elementos para c√°lculo
            const valorBrutoInput = document.getElementById('valorBruto');
            const ivaSimRadio = document.getElementById('ivaSim');
            const ivaNaoRadio = document.getElementById('ivaNao');
            const statusPagoRadio = document.getElementById('statusPago');
            const statusPendenteRadio = document.getElementById('statusPendente');
            const valorBrutoDisplay = document.getElementById('valorBrutoDisplay');
            const valorIVADisplay = document.getElementById('valorIVADisplay');
            const valorTotalDisplay = document.getElementById('valorTotalDisplay');
            const dataPagamentoInput = document.getElementById('dataPagamento');
            
            // Campos ocultos para valores calculados
            const valorTotalHidden = document.getElementById('despesaValorTotal');
            const valorIVAHidden = document.getElementById('despesaValorIVA');
            const notaFiscalHidden = document.getElementById('despesaNotaFiscal');
            const tipoArquivoHidden = document.getElementById('despesaTipoArquivo');
            const tamanhoOriginalHidden = document.getElementById('despesaTamanhoOriginal');
            const tamanhoOtimizadoHidden = document.getElementById('despesaTamanhoOtimizado');
            
            // ============================================
            // FUN√á√ïES PRINCIPAIS - SEGUINDO PADR√ÉO PEDIDOS
            // ============================================
            
            // Inicializar o formul√°rio
            function inicializarFormulario() {
                console.log('üîÑ Inicializando formul√°rio de despesa');
                
                // Configurar datas padr√£o
                const hoje = new Date();
                const amanha = new Date(hoje);
                amanha.setDate(amanha.getDate() + 1);
                
                // S√≥ configurar datas se n√£o estiver em modo edi√ß√£o
                if (!isEditMode) {
                    document.getElementById('dataCompra').valueAsDate = hoje;
                    document.getElementById('dataVencimento').valueAsDate = amanha;
                    
                    // Data de pagamento come√ßa vazia
                    dataPagamentoInput.value = '';
                    dataPagamentoInput.disabled = true;
                }
                
                // Configurar eventos
                configurarEventListeners();
                
                // Calcular totais iniciais
                calcularTotais();
                
                showMessage('Formul√°rio pronto para nova despesa.', 'success');
            }
            
            // Configurar event listeners
            function configurarEventListeners() {
                // C√°lculo autom√°tico de totais
                valorBrutoInput.addEventListener('input', calcularTotais);
                ivaSimRadio.addEventListener('change', calcularTotais);
                ivaNaoRadio.addEventListener('change', calcularTotais);
                
                // Status de pagamento condicional
                statusPagoRadio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        dataPagamentoInput.required = true;
                        dataPagamentoInput.disabled = false;
                        if (!dataPagamentoInput.value) {
                            dataPagamentoInput.valueAsDate = new Date();
                        }
                    }
                });
                
                statusPendenteRadio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        dataPagamentoInput.required = false;
                        dataPagamentoInput.disabled = true;
                        dataPagamentoInput.value = '';
                    }
                });
                
                // Categoria "Outros"
                categoriaSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'OUTROS') {
                        outraCategoriaInput.classList.add('active');
                        outraCategoriaInput.required = true;
                        outraCategoriaInput.disabled = false;
                        outraCategoriaInput.setAttribute('data-bind', 'despesa.outraCategoria');
                    } else {
                        outraCategoriaInput.classList.remove('active');
                        outraCategoriaInput.required = false;
                        outraCategoriaInput.disabled = true;
                        outraCategoriaInput.removeAttribute('data-bind');
                        outraCategoriaInput.value = '';
                    }
                });
                
                // Forma de pagamento "Outro"
                formaPagamentoSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'outro') {
                        outroPagamentoInput.disabled = false;
                        outroPagamentoInput.required = true;
                        outroPagamentoInput.setAttribute('data-bind', 'despesa.outroPagamento');
                    } else {
                        outroPagamentoInput.disabled = true;
                        outroPagamentoInput.required = false;
                        outroPagamentoInput.removeAttribute('data-bind');
                        outroPagamentoInput.value = '';
                    }
                });
                
                // Processar arquivo de nota fiscal
                notaFiscalInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        processarNotaFiscal(file);
                    }
                });
                
                // Bot√£o cancelar
                cancelBtn.addEventListener('click', () => {
                    if (confirm(isEditMode ? 'Tem certeza que deseja cancelar a edi√ß√£o?' : 'Tem certeza que deseja cancelar esta despesa?')) {
                        if (isEditMode) {
                            window.location.href = 'despesas.html';
                        } else {
                            limparFormulario();
                        }
                    }
                });
                
                // Bot√£o salvar (o Core Engine vai interceptar via data-action)
                saveBtn.addEventListener('click', () => {
                    if (validarFormulario()) {
                        saveBtn.classList.add('saving');
                        saveBtn.textContent = 'SALVANDO...';
                        saveBtn.disabled = true;
                        
                        // O Core Engine far√° o commit via data-bind
                        console.log('üì§ Enviando despesa para Core Engine...');
                    }
                });
            }
            
            // Fun√ß√£o para calcular totais
            function calcularTotais() {
                const valorBruto = parseFloat(valorBrutoInput.value) || 0;
                
                // Se tem IVA, calcular o valor com IVA (23%)
                if (ivaSimRadio.checked) {
                    const valorComIVA = valorBruto * 1.23;
                    const valorIVA = valorComIVA - valorBruto;
                    
                    // Atualizar displays
                    valorBrutoDisplay.textContent = formatarMoeda(valorBruto);
                    valorIVADisplay.textContent = formatarMoeda(valorIVA);
                    valorTotalDisplay.textContent = formatarMoeda(valorComIVA);
                    
                    // Atualizar campos ocultos (ser√£o usados pelo engine.js)
                    valorTotalHidden.value = valorComIVA.toFixed(2);
                    valorIVAHidden.value = valorIVA.toFixed(2);
                } else {
                    // Se isento de IVA
                    valorBrutoDisplay.textContent = formatarMoeda(valorBruto);
                    valorIVADisplay.textContent = '‚Ç¨0.00';
                    valorTotalDisplay.textContent = formatarMoeda(valorBruto);
                    
                    // Atualizar campos ocultos
                    valorTotalHidden.value = valorBruto.toFixed(2);
                    valorIVAHidden.value = '0.00';
                }
                
                console.log('üßÆ Totais calculados:', {
                    bruto: valorBruto,
                    comIVA: ivaSimRadio.checked,
                    total: valorTotalHidden.value
                });
            }
            
            // Fun√ß√£o para formatar moeda
            function formatarMoeda(valor) {
                return new Intl.NumberFormat('pt-PT', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(valor);
            }
            
            // ============================================
            // FUN√á√ïES DE EDI√á√ÉO - SEGUINDO PADR√ÉO PEDIDOS
            // ============================================
            
            async function loadDespesaForEdit(despesaId) {
                try {
                    console.log(`üì• Carregando despesa para edi√ß√£o: ${despesaId}`);
                    
                    // üî• CORRE√á√ÉO: Buscar todos e filtrar localmente
                    const response = await fetch('/api/database/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            schema: 'despesa',
                            filters: {}  // ‚úÖ Buscar TODOS os pedidos
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao buscar despesas');
                    }
                    
                    const result = await response.json();
                    const eventos = result.events || [];
                    
                    // üî• CORRE√á√ÉO: Filtrar pelo ID correto
                    const despesaEvento = eventos.find(evento => evento.id === despesaId);
                    
                    if (!despesaEvento) {
                        throw new Error('Despesa n√£o encontrada');
                    }
                    
                    const despesa = despesaEvento.payload;
                    
                    console.log('üí∞ Despesa carregada:', despesa);
                    
                    // üî• CR√çTICO: Preencher o ID do documento (PADR√ÉO PEDIDOS)
                    currentDespesaId = despesaEvento.id;
                    despesaIdInput.value = currentDespesaId;
                    console.log('üîß ID configurado para edi√ß√£o:', currentDespesaId);
                    
                    // Preencher campos do formul√°rio
                    document.getElementById('fornecedor').value = despesa.fornecedor || '';
                    document.getElementById('descricao').value = despesa.descricao || '';
                    document.getElementById('dataCompra').value = despesa.dataCompra || '';
                    document.getElementById('dataVencimento').value = despesa.dataVencimento || '';
                    document.getElementById('valorBruto').value = despesa.valorBruto || '0';
                    document.getElementById('categoria').value = despesa.categoria || '';
                    document.getElementById('formaPagamento').value = despesa.formaPagamento || '';
                    document.getElementById('observacoes').value = despesa.observacoes || '';
                    document.getElementById('telefone').value = despesa.telefone || '';
                    document.getElementById('nifFornecedor').value = despesa.nifFornecedor || '';
                    
                    // Status de pagamento
                    if (despesa.statusPagamento) {
                        const statusValue = (despesa.statusPagamento === 'paga' || despesa.statusPagamento === 'pago') ? 'pago' : 'pendente';
                        const statusRadio = document.querySelector(`input[name="statusPagamento"][value="${statusValue}"]`);
                        if (statusRadio) statusRadio.checked = true;
                        
                        // Habilitar/desabilitar data de pagamento
                        if (statusValue === 'pago') {
                            dataPagamentoInput.disabled = false;
                            dataPagamentoInput.value = despesa.dataPagamento || '';
                        } else {
                            dataPagamentoInput.disabled = true;
                        }
                    }
                    
                    // Data de pagamento se existir
                    if (despesa.dataPagamento) {
                        document.getElementById('dataPagamento').value = despesa.dataPagamento;
                    }
                    
                    // IVA - CORRIGIDO
                    if (despesa.comIVA !== undefined) {
                        // Aceitar m√∫ltiplos formatos: 'sim', 'comIVA', boolean
                        const comIVA = despesa.comIVA === 'sim' || despesa.comIVA === 'comIVA' || despesa.comIVA === true;
                        const ivaRadio = comIVA ? ivaSimRadio : ivaNaoRadio;
                        if (ivaRadio) ivaRadio.checked = true;
                    }
                    
                    // Categoria "Outros"
                    if (despesa.categoria === 'OUTROS' && despesa.outraCategoria) {
                        categoriaSelect.dispatchEvent(new Event('change'));
                        outraCategoriaInput.value = despesa.outraCategoria;
                    }
                    
                    // Forma de pagamento "Outro"
                    if (despesa.formaPagamento === 'outro' && despesa.outroPagamento) {
                        formaPagamentoSelect.dispatchEvent(new Event('change'));
                        outroPagamentoInput.value = despesa.outroPagamento;
                    }
                    
                    // Nota fiscal (se existir)
                    if (despesa.notaFiscal && despesa.tipoArquivo) {
                        notaFiscalBase64 = despesa.notaFiscal;
                        tipoArquivo = despesa.tipoArquivo;
                        tamanhoOriginal = despesa.tamanhoOriginal || 0;
                        tamanhoOtimizado = despesa.tamanhoOtimizado || 0;
                        
                        // Mostrar preview do arquivo
                        filePreview.style.display = 'block';
                        filePreview.innerHTML = `
                            <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-file-alt" style="color: #0ea5e9;"></i>
                                    <div>
                                        <div style="font-weight: 600; color: #0c4a6e;">Nota Fiscal existente</div>
                                        <div style="font-size: 12px; color: #64748b;">
                                            Tamanho: ${(tamanhoOtimizado / 1024).toFixed(2)}KB
                                        </div>
                                    </div>
                                    <button type="button" onclick="limparNotaFiscal()" style="margin-left: auto; background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Atualizar campos ocultos
                        notaFiscalHidden.value = notaFiscalBase64;
                        tipoArquivoHidden.value = tipoArquivo;
                        tamanhoOriginalHidden.value = tamanhoOriginal;
                        tamanhoOtimizadoHidden.value = tamanhoOtimizado;
                    }
                    
                    // Configurar modo de edi√ß√£o
                    isEditMode = true;
                    
                    // Atualizar texto do bot√£o
                    saveBtn.textContent = 'ATUALIZAR DESPESA';
                    
                    // Calcular totais
                    calcularTotais();
                    
                    showMessage('Despesa carregada com sucesso para edi√ß√£o!', 'success');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar despesa:', error);
                    showMessage('Erro ao carregar despesa: ' + error.message, 'error');
                    
                    // Redirecionar para lista ap√≥s erro
                    setTimeout(() => {
                        if (confirm('N√£o foi poss√≠vel carregar a despesa para edi√ß√£o. Deseja voltar para a lista?')) {
                            window.location.href = 'despesas.html';
                        }
                    }, 2000);
                }
            }
            
            // ============================================
            // FUN√á√ïES DE PROCESSAMENTO DE ARQUIVOS
            // ============================================
            
            // Fun√ß√£o para comprimir imagem
            function comprimirImagem(file, maxWidth = 1024, quality = 0.7) {
                return new Promise((resolve, reject) => {
                    if (!file.type.startsWith('image/')) {
                        resolve({
                            base64: '',
                            tipo: file.type,
                            tamanhoOriginal: file.size,
                            tamanhoOtimizado: file.size
                        });
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            const base64 = canvas.toDataURL('image/jpeg', quality);
                            
                            resolve({
                                base64: base64,
                                tipo: 'image/jpeg',
                                tamanhoOriginal: file.size,
                                tamanhoOtimizado: Math.round((base64.length * 3) / 4)
                            });
                        };
                        
                        img.onerror = reject;
                    };
                    
                    reader.onerror = reject;
                });
            }
            
            // Fun√ß√£o para processar anexo de nota fiscal
            async function processarNotaFiscal(file) {
                // Verificar tamanho do arquivo (m√°x. 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('O arquivo √© muito grande (m√°x. 5MB).', 'error');
                    notaFiscalInput.value = '';
                    limparNotaFiscal();
                    return;
                }
                
                // Mostrar preview inicial
                filePreview.style.display = 'block';
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileInfo').textContent = 
                    `Tipo: ${file.type} ‚Ä¢ Tamanho original: ${(file.size / 1024).toFixed(2)}KB`;
                document.getElementById('compressionInfo').textContent = 'Otimizando arquivo...';
                
                try {
                    let resultado;
                    
                    if (file.type.startsWith('image/')) {
                        // Comprimir imagem
                        resultado = await comprimirImagem(file, 1024, 0.7);
                        
                        // Mostrar preview da imagem otimizada
                        const fileImage = document.getElementById('fileImage');
                        fileImage.src = resultado.base64;
                        fileImage.style.display = 'block';
                        
                        document.getElementById('compressionInfo').textContent = 
                            `Imagem otimizada: ${(resultado.tamanhoOtimizado / 1024).toFixed(2)}KB (redu√ß√£o de ${((1 - resultado.tamanhoOtimizado/file.size) * 100).toFixed(1)}%)`;
                    } else {
                        // Outros tipos de arquivo
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        
                        reader.onload = (event) => {
                            resultado = {
                                base64: event.target.result,
                                tipo: file.type,
                                tamanhoOriginal: file.size,
                                tamanhoOtimizado: Math.round((event.target.result.length * 3) / 4)
                            };
                            
                            document.getElementById('compressionInfo').textContent = 
                                `Arquivo: ${(resultado.tamanhoOtimizado / 1024).toFixed(2)}KB`;
                            
                            document.getElementById('fileImage').style.display = 'none';
                            
                            // Armazenar dados
                            notaFiscalBase64 = resultado.base64;
                            tipoArquivo = resultado.tipo;
                            tamanhoOriginal = resultado.tamanhoOriginal;
                            tamanhoOtimizado = resultado.tamanhoOtimizado;
                            
                            // Atualizar campos ocultos
                            notaFiscalHidden.value = notaFiscalBase64;
                            tipoArquivoHidden.value = tipoArquivo;
                            tamanhoOriginalHidden.value = tamanhoOriginal;
                            tamanhoOtimizadoHidden.value = tamanhoOtimizado;
                        };
                        
                        await new Promise(resolve => reader.onloadend = resolve);
                        return;
                    }
                    
                    // Armazenar dados
                    notaFiscalBase64 = resultado.base64;
                    tipoArquivo = resultado.tipo;
                    tamanhoOriginal = resultado.tamanhoOriginal;
                    tamanhoOtimizado = resultado.tamanhoOtimizado || resultado.tamanhoOriginal;
                    
                    // Atualizar campos ocultos
                    notaFiscalHidden.value = notaFiscalBase64;
                    tipoArquivoHidden.value = tipoArquivo;
                    tamanhoOriginalHidden.value = tamanhoOriginal;
                    tamanhoOtimizadoHidden.value = tamanhoOtimizado;
                    
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    showMessage('Erro ao processar arquivo. Tente novamente.', 'error');
                    limparNotaFiscal();
                }
            }
            
            // Fun√ß√£o para limpar nota fiscal
            window.limparNotaFiscal = function() {
                notaFiscalBase64 = '';
                tipoArquivo = '';
                tamanhoOriginal = 0;
                tamanhoOtimizado = 0;
                filePreview.style.display = 'none';
                notaFiscalInput.value = '';
                
                // Limpar campos ocultos
                notaFiscalHidden.value = '';
                tipoArquivoHidden.value = '';
                tamanhoOriginalHidden.value = '';
                tamanhoOtimizadoHidden.value = '';
            };
            
            // ============================================
            // FUN√á√ïES AUXILIARES
            // ============================================
            
            // Fun√ß√£o para validar o formul√°rio
            function validarFormulario() {
                const camposObrigatorios = [
                    'fornecedor', 'descricao', 'dataCompra', 
                    'dataVencimento', 'valorBruto', 'categoria', 
                    'formaPagamento'
                ];
                
                for (const campoId of camposObrigatorios) {
                    const campo = document.getElementById(campoId);
                    if (!campo.value.trim()) {
                        showMessage(`O campo "${campo.previousElementSibling?.textContent.replace(' *', '') || campoId}" √© obrigat√≥rio.`, 'warning');
                        campo.focus();
                        return false;
                    }
                }
                
                // Valida√ß√£o especial para categoria "Outros"
                if (categoriaSelect.value === 'OUTROS' && !outraCategoriaInput.value.trim()) {
                    showMessage('Por favor, especifique a categoria "Outros".', 'warning');
                    outraCategoriaInput.focus();
                    return false;
                }
                
                // Valida√ß√£o especial para forma de pagamento "Outro"
                if (formaPagamentoSelect.value === 'outro' && !outroPagamentoInput.value.trim()) {
                    showMessage('Por favor, especifique a forma de pagamento "Outro".', 'warning');
                    outroPagamentoInput.focus();
                    return false;
                }
                
                // Valida√ß√£o de valor bruto
                const valorBruto = parseFloat(document.getElementById('valorBruto').value);
                if (isNaN(valorBruto) || valorBruto <= 0) {
                    showMessage('Por favor, insira um valor bruto v√°lido (maior que 0).', 'warning');
                    document.getElementById('valorBruto').focus();
                    return false;
                }
                
                // Valida√ß√£o da data de vencimento
                const dataCompra = new Date(document.getElementById('dataCompra').value);
                const dataVencimento = new Date(document.getElementById('dataVencimento').value);
                if (dataVencimento < dataCompra) {
                    showMessage('A data de vencimento n√£o pode ser anterior √† data da compra.', 'warning');
                    document.getElementById('dataVencimento').focus();
                    return false;
                }
                
                // Se status √© "Pago", data de pagamento √© obrigat√≥ria
                if (statusPagoRadio.checked && !dataPagamentoInput.value) {
                    showMessage('A data de pagamento √© obrigat√≥ria quando o status √© "Pago".', 'warning');
                    dataPagamentoInput.focus();
                    return false;
                }
                
                // Verificar tamanho do arquivo otimizado
                if (tamanhoOtimizado > 500 * 1024) {
                    if (!confirm(`A nota fiscal otimizada tem ${(tamanhoOtimizado / 1024).toFixed(2)}KB. Isso pode sobrecarregar o banco de dados. Deseja continuar?`)) {
                        return false;
                    }
                }
                
                return true;
            }
            
            // Fun√ß√£o para mostrar mensagens
            function showMessage(message, type = 'info') {
                // Remover mensagens anteriores
                const existingMessages = document.querySelectorAll('.success-message');
                existingMessages.forEach(msg => msg.remove());
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'success-message';
                messageDiv.textContent = message;
                
                if (type === 'warning') {
                    messageDiv.style.backgroundColor = '#f59e0b';
                } else if (type === 'error') {
                    messageDiv.style.backgroundColor = '#ef4444';
                } else if (type === 'success') {
                    messageDiv.style.backgroundColor = '#10b981';
                }
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }
            
            // Fun√ß√£o para limpar o formul√°rio
            function limparFormulario() {
                despesaForm.reset();
                limparNotaFiscal();
                outraCategoriaInput.classList.remove('active');
                outraCategoriaInput.value = '';
                outraCategoriaInput.disabled = true;
                outraCategoriaInput.removeAttribute('data-bind');
                outroPagamentoInput.disabled = true;
                outroPagamentoInput.value = '';
                outroPagamentoInput.removeAttribute('data-bind');
                
                // Resetar modo de edi√ß√£o
                isEditMode = false;
                currentDespesaId = '';
                despesaIdInput.value = '';
                
                // Re-inicializar
                inicializarFormulario();
                
                showMessage('Formul√°rio limpo. Pronto para nova despesa.', 'info');
            }
            
            // ============================================
            // CONFIGURA√á√ÉO DO CORE ENGINE - SEGUINDO PADR√ÉO PEDIDOS
            // ============================================
            
            // Configurar listeners para eventos do Core Engine
            document.addEventListener('coreCommitSuccess', (event) => {
                const detail = event.detail || {};
                
                if (detail.schema === 'despesa') {
                    // Feedback de sucesso
                    saveBtn.classList.remove('saving');
                    
                    if (detail.isUpdate) {
                        saveBtn.textContent = '‚úì ATUALIZADA!';
                        showMessage('Despesa atualizada com sucesso!', 'success');
                    } else {
                        saveBtn.textContent = '‚úì SALVA!';
                        showMessage('Despesa criada com sucesso!', 'success');
                        
                        // Se for cria√ß√£o, armazenar o ID gerado
                        if (detail.documentId && despesaIdInput) {
                            despesaIdInput.value = detail.documentId;
                            isEditMode = true;
                            currentDespesaId = detail.documentId;
                            saveBtn.textContent = 'ATUALIZAR DESPESA';
                        }
                    }
                    
                    // Redirecionar ap√≥s 2 segundos se for cria√ß√£o
                    setTimeout(() => {
                        if (!detail.isUpdate) {
                            if (confirm('Despesa salva com sucesso! Deseja criar uma nova despesa?')) {
                                limparFormulario();
                                saveBtn.textContent = 'SALVAR DESPESA';
                                saveBtn.disabled = false;
                            } else {
                                window.location.href = 'despesas.html';
                            }
                        } else {
                            saveBtn.disabled = false;
                        }
                    }, 2000);
                }
            });
            
            document.addEventListener('coreCommitError', (event) => {
                console.error('Erro no commit:', event.detail);
                saveBtn.classList.remove('saving');
                saveBtn.textContent = isEditMode ? 'ATUALIZAR DESPESA' : 'SALVAR DESPESA';
                saveBtn.disabled = false;
                
                showMessage('Erro ao salvar despesa. Tente novamente.', 'error');
            });
            
            // ============================================
            // INICIALIZA√á√ÉO
            // ============================================
            
            // Verificar se √© modo de edi√ß√£o
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            
            if (editId) {
                // Modo de edi√ß√£o - carregar despesa existente
                console.log('‚úèÔ∏è Modo EDI√á√ÉO detectado para despesa ID:', editId);
                showMessage('Carregando despesa para edi√ß√£o...', 'info');
                loadDespesaForEdit(editId);
            } else {
                // Modo de cria√ß√£o - configurar novo formul√°rio
                console.log('üÜï Modo CRIA√á√ÉO detectado');
                inicializarFormulario();
            }
            
            console.log('‚úÖ Sistema de despesas inicializado com sucesso');
        });
    </script>
    
    <!-- CONEX√ÉO COM O CORE ENGINE -->
    <script src="../core/engine.js"></script>
</body>
</html>