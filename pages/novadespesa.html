<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio de Despesa - PrintPixel</title>
    <style>
        /* Estilo para mensagem de sucesso */
        .success-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* MODAL DO QR CODE (NOVO) */
        .qr-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .qr-modal-overlay.active {
            display: flex;
        }

        .qr-modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalAppear 0.3s ease-out;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .qr-title {
            font-size: 24px;
            color: #dc2626;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .qr-subtitle {
            color: #64748b;
            margin-bottom: 25px;
            font-size: 16px;
        }

        .qr-code-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            display: inline-block;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
        }

        .qr-instructions {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
            border-left: 4px solid #3b82f6;
        }

        .qr-instructions ol {
            padding-left: 20px;
            margin: 10px 0;
        }

        .qr-instructions li {
            margin-bottom: 8px;
            color: #475569;
        }

        .qr-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 25px;
        }

        .qr-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .qr-btn-close {
            background: #64748b;
            color: white;
        }

        .qr-btn-close:hover {
            background: #475569;
        }

        .qr-btn-refresh {
            background: #3b82f6;
            color: white;
        }

        .qr-btn-refresh:hover {
            background: #2563eb;
        }

        .qr-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }

        .qr-status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
            display: block;
        }

        .qr-status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
            display: block;
        }

        .qr-status.pending {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
            display: block;
        }

        .upload-options {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .upload-option-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 500;
        }

        .upload-option-btn:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .upload-option-btn.active {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }

        .upload-option-btn i {
            display: block;
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* Estilos principais (MANTIDOS) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background-color: #f8fafc;
            color: #1e293b;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 18px;
            color: #dc2626;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dc2626;
            font-weight: 600;
            letter-spacing: -0.2px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #334155;
            font-size: 14px;
            letter-spacing: 0.2px;
        }
        
        input, select, textarea {
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.2s;
            background-color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        input[type="date"] {
            padding: 11px 16px;
        }
        
        input[type="number"] {
            text-align: right;
        }
        
        input[type="file"] {
            padding: 10px;
            border: 2px dashed #e2e8f0;
            background: #f8fafc;
            cursor: pointer;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }
        
        .radio-option label {
            margin-bottom: 0;
            font-weight: 500;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pago {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }
        
        .file-preview {
            margin-top: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: none;
        }
        
        .file-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            margin-top: 8px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 14px;
            color: #64748b;
        }
        
        .compression-info {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 4px;
            font-style: italic;
        }
        
        .total-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1.5px solid #e2e8f0;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .total-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 18px;
            color: #dc2626;
        }
        
        .categoria-select {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 15px;
            background-color: white;
            cursor: pointer;
        }
        
        .outra-categoria-input {
            margin-top: 12px;
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 15px;
            width: 100%;
            display: none;
        }
        
        .outra-categoria-input.active {
            display: block;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }
        
        .btn-cancel {
            background-color: #64748b;
            color: white;
            border: none;
            padding: 15px 32px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .btn-cancel:hover {
            background-color: #475569;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.2);
        }
        
        .btn-save {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 15px 32px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .btn-save:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
        }
        
        .btn-save.saving {
            background-color: #059669;
            opacity: 0.8;
        }
        
        .btn-save.success {
            background-color: #059669;
        }
        
        .required::after {
            content: " *";
            color: #ef4444;
        }
        
        .field-note {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn-cancel, .btn-save {
                width: 100%;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 12px;
            }
            
            .success-message {
                bottom: 10px;
                right: 10px;
                left: 10px;
            }

            .qr-buttons {
                flex-direction: column;
            }

            .upload-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body data-page-id="nova_despesa" data-page-type="WRITE">
    <!-- MODAL DO QR CODE (NOVO) -->
    <div class="qr-modal-overlay" id="qrModalOverlay">
        <div class="qr-modal">
            <h2 class="qr-title">üì± Escanear Nota com Celular</h2>
            <p class="qr-subtitle">Aponte a c√¢mera do iPhone para o c√≥digo abaixo</p>
            
            <div class="qr-code-container">
                <div id="qrCodeDisplay"></div>
            </div>

            <div class="qr-instructions">
                <strong>Como funciona:</strong>
                <ol>
                    <li>Aponte a c√¢mera do iPhone para o QR Code acima</li>
                    <li>Toque na notifica√ß√£o que aparecer</li>
                    <li>Permita o acesso √† c√¢mera</li>
                    <li>Escaneie a nota fiscal</li>
                    <li>A foto ser√° enviada automaticamente</li>
                </ol>
            </div>

            <div class="qr-status" id="qrStatus"></div>

            <div class="qr-buttons">
                <button class="qr-btn qr-btn-close" id="qrCloseBtn">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button class="qr-btn qr-btn-refresh" id="qrRefreshBtn">
                    <i class="fas fa-redo"></i> Gerar Novo C√≥digo
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <form id="despesaForm">
            <!-- üî• CR√çTICO: Campo hidden para ID (PADR√ÉO PEDIDOS) -->
            <input type="hidden" id="despesaId" data-bind="despesa.id" value="">
            
            <div class="form-section">
                <h2 class="section-title">Informa√ß√µes da Despesa</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fornecedor" class="required">Fornecedor</label>
                        <input type="text" id="fornecedor" name="fornecedor" data-bind="despesa.fornecedor" placeholder="Nome do fornecedor" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="descricao" class="required">Descri√ß√£o da Despesa</label>
                        <input type="text" id="descricao" name="descricao" data-bind="despesa.descricao" placeholder="Ex: Compra de material gr√°fico" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="telefone">Telefone do Fornecedor</label>
                        <input type="tel" id="telefone" name="telefone" data-bind="despesa.telefone" placeholder="Ex: 912345678">
                    </div>
                    
                    <div class="form-group">
                        <label for="nifFornecedor">NIF do Fornecedor</label>
                        <input type="text" id="nifFornecedor" name="nifFornecedor" data-bind="despesa.nifFornecedor" placeholder="N√∫mero de identifica√ß√£o fiscal">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Datas</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="dataCompra" class="required">Data da Compra</label>
                        <input type="date" id="dataCompra" name="dataCompra" data-bind="despesa.dataCompra" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataVencimento" class="required">Data de Vencimento</label>
                        <input type="date" id="dataVencimento" name="dataVencimento" data-bind="despesa.dataVencimento" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataPagamento">Data do Pagamento</label>
                        <input type="date" id="dataPagamento" name="dataPagamento" data-bind="despesa.dataPagamento">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Valores</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="valorBruto" class="required">Valor Bruto (sem IVA)</label>
                        <input type="number" id="valorBruto" name="valorBruto" data-bind="despesa.valorBruto" min="0" step="0.01" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label>IVA</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="ivaSim" name="ivaOption" value="sim" data-bind="despesa.comIVA" checked>
                                <label for="ivaSim">Com IVA (23%)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="ivaNao" name="ivaOption" value="nao" data-bind="despesa.comIVA">
                                <label for="ivaNao">Isento</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Status do Pagamento</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="statusPago" name="statusPagamento" value="pago" data-bind="despesa.statusPagamento" checked>
                                <label for="statusPago"><span class="status-badge status-pago">Pago</span></label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="statusPendente" name="statusPagamento" value="pendente" data-bind="despesa.statusPagamento">
                                <label for="statusPendente"><span class="status-badge status-pendente">A Pagar</span></label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="total-section">
                    <div class="total-row">
                        <span>Valor Bruto (sem IVA):</span>
                        <span id="valorBrutoDisplay">‚Ç¨0.00</span>
                    </div>
                    <div class="total-row">
                        <span>IVA (23%):</span>
                        <span id="valorIVADisplay">‚Ç¨0.00</span>
                    </div>
                    <div class="total-row">
                        <span>TOTAL (com IVA):</span>
                        <span id="valorTotalDisplay">‚Ç¨0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Categoria</h2>
                
                <div class="form-group">
                    <label for="categoria" class="required">Selecione uma Categoria</label>
                    <select id="categoria" name="categoria" class="categoria-select" data-bind="despesa.categoria" required>
                        <option value="">Selecione uma categoria...</option>
                        <option value="√ÅGUA">√ÅGUA</option>
                        <option value="AMAZON">AMAZON</option>
                        <option value="ALIMENTA√á√ÉO">ALIMENTA√á√ÉO</option>
                        <option value="ARRENDAMENTO">ARRENDAMENTO</option>
                        <option value="COMISS√ÉO">COMISS√ÉO</option>
                        <option value="CONTABILIDADE">CONTABILIDADE</option>
                        <option value="CTT">CTT</option>
                        <option value="COMBUST√çVEL">COMBUST√çVEL</option>
                        <option value="CAF√â">CAF√â</option>
                        <option value="DIMATUR">DIMATUR</option>
                        <option value="DAGOL">DAGOL</option>
                        <option value="ENERGIA">ENERGIA</option>
                        <option value="FILAMENTO 3D">FILAMENTO 3D</option>
                        <option value="IMPOSTOS">IMPOSTOS</option>
                        <option value="LEROY MERLIN">LEROY MERLIN</option>
                        <option value="LUZACRIL">LUZACRIL</option>
                        <option value="MANUTEN√á√ÉO">MANUTEN√á√ÉO</option>
                        <option value="MATERIAL ESCRITORIO">MATERIAL ESCRITORIO</option>
                        <option value="MAKRO">MAKRO</option>
                        <option value="PLOTTERZONE">PLOTTERZONE</option>
                        <option value="POLEGADA LED">POLEGADA LED</option>
                        <option value="SAL√ÅRIO">SAL√ÅRIO</option>
                        <option value="SANTANDER">SANTANDER</option>
                        <option value="TRANSPORTE">TRANSPORTE</option>
                        <option value="TELEFONE/INTERNET">TELEFONE/INTERNET</option>
                        <option value="WEDDT">WEDDT</option>
                        <option value="OUTROS">OUTROS</option>
                    </select>
                    
                    <input type="text" id="outraCategoriaInput" class="outra-categoria-input" data-bind="despesa.outraCategoria" placeholder="Especifique outra categoria...">
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Forma de Pagamento</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="formaPagamento" class="required">M√©todo de Pagamento</label>
                        <select id="formaPagamento" name="formaPagamento" class="categoria-select" data-bind="despesa.formaPagamento" required>
                            <option value="">Selecione a forma de pagamento...</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="mbway">MBWay</option>
                            <option value="transferencia">Transfer√™ncia Banc√°ria</option>
                            <option value="cartao">Cart√£o de Cr√©dito/D√©bito</option>
                            <option value="cheque">Cheque</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="outroPagamento">Especificar Outro</label>
                        <input type="text" id="outroPagamento" name="outroPagamento" data-bind="despesa.outroPagamento" placeholder="Especifique a forma de pagamento">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2 class="section-title">Anexos e Observa√ß√µes</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="observacoes">Observa√ß√µes</label>
                        <textarea id="observacoes" name="observacoes" data-bind="despesa.observacoes" rows="4" placeholder="Observa√ß√µes sobre a despesa..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="notaFiscal">Anexar Nota Fiscal/Fatura</label>
                        
                        <div class="upload-options">
                            <button type="button" class="upload-option-btn" id="uploadPcBtn">
                                <i class="fas fa-desktop"></i>
                                Computador
                            </button>
                            <button type="button" class="upload-option-btn active" id="uploadMobileBtn">
                                <i class="fas fa-mobile-alt"></i>
                                Celular (QR Code)
                            </button>
                        </div>
                        
                        <input type="file" id="notaFiscal" name="notaFiscal" accept="image/*,.pdf,.doc,.docx" style="display: none;">
                        
                        <div class="field-note">Clique em "Celular" para gerar QR Code e escanear com iPhone</div>
                        <div class="field-note">Dica: Use o scanner nativo do iPhone para melhor qualidade</div>
                        
                        <div class="file-preview" id="filePreview">
                            <div id="fileName"></div>
                            <div class="file-info" id="fileInfo"></div>
                            <div class="compression-info" id="compressionInfo"></div>
                            <img id="fileImage" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Campos ocultos para totais (usados pelo engine.js) -->
            <input type="hidden" id="despesaValorTotal" data-bind="despesa.valorTotal" value="0">
            <input type="hidden" id="despesaValorIVA" data-bind="despesa.valorIVA" value="0">
            <input type="hidden" id="despesaNotaFiscal" data-bind="despesa.notaFiscal" value="">
            <input type="hidden" id="despesaTipoArquivo" data-bind="despesa.tipoArquivo" value="">
            <input type="hidden" id="despesaTamanhoOriginal" data-bind="despesa.tamanhoOriginal" value="">
            <input type="hidden" id="despesaTamanhoOtimizado" data-bind="despesa.tamanhoOtimizado" value="">
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="cancelBtn">CANCELAR</button>
                <button type="button" class="btn-save" id="saveBtn" data-action="commit">SALVAR DESPESA</button>
            </div>
        </form>
    </div>

    <script>
        // ============================================
        // SISTEMA DE DESPESAS COM QR CODE AUTOM√ÅTICO - CORRIGIDO
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üí∞ Sistema de despesas com QR Code inicializado');
            
            // Vari√°veis globais
            let isEditMode = false;
            let currentDespesaId = '';
            let notaFiscalBase64 = '';
            let tipoArquivo = '';
            let tamanhoOriginal = 0;
            let tamanhoOtimizado = 0;
            let uploadSessionId = '';
            let qrCodeCheckInterval = null;
            let temporaryDespesaId = '';
            
            // Refer√™ncias DOM
            const despesaForm = document.getElementById('despesaForm');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const despesaIdInput = document.getElementById('despesaId');
            const categoriaSelect = document.getElementById('categoria');
            const outraCategoriaInput = document.getElementById('outraCategoriaInput');
            const formaPagamentoSelect = document.getElementById('formaPagamento');
            const outroPagamentoInput = document.getElementById('outroPagamento');
            const notaFiscalInput = document.getElementById('notaFiscal');
            const filePreview = document.getElementById('filePreview');
            const uploadPcBtn = document.getElementById('uploadPcBtn');
            const uploadMobileBtn = document.getElementById('uploadMobileBtn');
            
            // QR Code elements
            const qrModalOverlay = document.getElementById('qrModalOverlay');
            const qrCodeDisplay = document.getElementById('qrCodeDisplay');
            const qrCloseBtn = document.getElementById('qrCloseBtn');
            const qrRefreshBtn = document.getElementById('qrRefreshBtn');
            const qrStatus = document.getElementById('qrStatus');
            
            // Elementos para c√°lculo
            const valorBrutoInput = document.getElementById('valorBruto');
            const ivaSimRadio = document.getElementById('ivaSim');
            const ivaNaoRadio = document.getElementById('ivaNao');
            const statusPagoRadio = document.getElementById('statusPago');
            const statusPendenteRadio = document.getElementById('statusPendente');
            const valorBrutoDisplay = document.getElementById('valorBrutoDisplay');
            const valorIVADisplay = document.getElementById('valorIVADisplay');
            const valorTotalDisplay = document.getElementById('valorTotalDisplay');
            const dataPagamentoInput = document.getElementById('dataPagamento');
            
            // Campos ocultos para valores calculados
            const valorTotalHidden = document.getElementById('despesaValorTotal');
            const valorIVAHidden = document.getElementById('despesaValorIVA');
            const notaFiscalHidden = document.getElementById('despesaNotaFiscal');
            const tipoArquivoHidden = document.getElementById('despesaTipoArquivo');
            const tamanhoOriginalHidden = document.getElementById('despesaTamanhoOriginal');
            const tamanhoOtimizadoHidden = document.getElementById('despesaTamanhoOtimizado');
            
            // ============================================
            // INICIALIZA√á√ÉO
            // ============================================
            
            function inicializarFormulario() {
                console.log('üîÑ Inicializando formul√°rio de despesa');
                
                // Configurar datas padr√£o
                const hoje = new Date();
                const amanha = new Date(hoje);
                amanha.setDate(amanha.getDate() + 1);
                
                if (!isEditMode) {
                    document.getElementById('dataCompra').valueAsDate = hoje;
                    document.getElementById('dataVencimento').valueAsDate = amanha;
                    dataPagamentoInput.value = '';
                    dataPagamentoInput.disabled = true;
                }
                
                configurarEventListeners();
                calcularTotais();
                showMessage('Formul√°rio pronto para ' + (isEditMode ? 'edi√ß√£o de despesa' : 'nova despesa') + '.', 'success');
            }
            
            // ============================================
            // SISTEMA DE QR CODE (CORRIGIDO PARA EDI√á√ÉO)
            // ============================================
            
            function gerarUploadSession() {
                uploadSessionId = 'UPL-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                console.log('üÜï Sess√£o de upload gerada:', uploadSessionId);
                return uploadSessionId;
            }
            
            function gerarQRCode() {
                // Se estiver em modo de edi√ß√£o, usar o currentDespesaId
                // Se for nova despesa, gerar um ID tempor√°rio
                const sessionId = gerarUploadSession();
                
                // üî• CORRE√á√ÉO CR√çTICA: Usar o currentDespesaId quando estiver em modo de edi√ß√£o
                // Este √© o problema principal - na edi√ß√£o, o currentDespesaId j√° existe
                temporaryDespesaId = currentDespesaId || 'pending-' + Date.now();
                
                console.log('üîë ID da despesa para QR Code:', temporaryDespesaId);
                console.log('üì± Modo:', isEditMode ? 'EDI√á√ÉO' : 'CRIA√á√ÉO');
                
                // URL que ser√° escaneada pelo iPhone
                const uploadUrl = `${window.location.origin}/upload-mobile.html?session=${sessionId}&despesa=${encodeURIComponent(temporaryDespesaId)}&edit=${isEditMode ? 'true' : 'false'}`;
                
                console.log('üîó URL para QR Code:', uploadUrl);
                console.log('üìã ID da despesa:', temporaryDespesaId);
                console.log('‚úèÔ∏è Modo edi√ß√£o?', isEditMode);
                
                // Gerar QR Code visual
                qrCodeDisplay.innerHTML = `
                    <div style="text-align: center;">
                        <div style="margin-bottom: 15px; color: #64748b; font-size: 14px;">
                            <i class="fas fa-qrcode"></i> C√≥digo: ${sessionId.substring(0, 8)}
                        </div>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(uploadUrl)}" 
                             alt="QR Code" 
                             style="width: 200px; height: 200px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <div style="margin-top: 15px; color: #64748b; font-size: 12px;">
                            V√°lido por 15 minutos
                        </div>
                        ${isEditMode ? '<div style="margin-top: 10px; color: #3b82f6; font-size: 12px; font-weight: bold;"><i class="fas fa-edit"></i> Modo Edi√ß√£o</div>' : ''}
                    </div>
                `;
                
                // Armazenar sess√£o no localStorage para verifica√ß√£o
                localStorage.setItem('uploadSession_' + sessionId, JSON.stringify({
                    id: sessionId,
                    despesaId: temporaryDespesaId,
                    timestamp: Date.now(),
                    status: 'waiting',
                    isEditMode: isEditMode,
                    isTemporary: !currentDespesaId
                }));
                
                // Iniciar verifica√ß√£o
                iniciarVerificacaoUpload(sessionId, temporaryDespesaId);
                
                // Mostrar modal
                qrModalOverlay.classList.add('active');
                qrStatus.className = 'qr-status pending';
                qrStatus.innerHTML = '<i class="fas fa-clock"></i> Aguardando upload do celular...';
                qrStatus.style.display = 'block';
                
                showMessage('QR Code gerado! Escaneie com o iPhone.', 'success');
            }
            
            function iniciarVerificacaoUpload(sessionId, despesaId) {
                if (qrCodeCheckInterval) clearInterval(qrCodeCheckInterval);
                
                let checkCount = 0;
                const maxChecks = 300; // 15 minutos (300 checks * 3 segundos)
                
                qrCodeCheckInterval = setInterval(async () => {
                    checkCount++;
                    
                    if (checkCount > maxChecks) {
                        clearInterval(qrCodeCheckInterval);
                        qrStatus.className = 'qr-status error';
                        qrStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> QR Code expirado. Gere um novo.';
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/upload/check?session=${sessionId}`);
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data.status === 'uploaded' && data.fileData) {
                                // Upload conclu√≠do!
                                clearInterval(qrCodeCheckInterval);
                                
                                qrStatus.className = 'qr-status success';
                                qrStatus.innerHTML = `<i class="fas fa-check-circle"></i> Nota recebida! Processando...`;
                                
                                // Processar arquivo recebido
                                processarArquivoRecebido(data.fileData, sessionId);
                                
                                // Fechar modal ap√≥s 2 segundos
                                setTimeout(() => {
                                    qrModalOverlay.classList.remove('active');
                                    showMessage('Nota fiscal anexada com sucesso via celular!', 'success');
                                }, 2000);
                                
                            } else if (data.status === 'error') {
                                qrStatus.className = 'qr-status error';
                                qrStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Erro no upload: ${data.message}`;
                            }
                        }
                    } catch (error) {
                        // Silencioso - apenas aguardando
                        if (checkCount % 10 === 0) {
                            console.log('‚è≥ Aguardando upload...', checkCount);
                        }
                    }
                }, 3000); // Verificar a cada 3 segundos
            }
            
            function processarArquivoRecebido(fileData, sessionId) {
                console.log('üìÅ Processando arquivo recebido:', fileData);
                console.log('‚úèÔ∏è Modo de edi√ß√£o?', isEditMode);
                
                // Atualizar campos do formul√°rio
                notaFiscalBase64 = fileData.base64;
                tipoArquivo = fileData.tipo;
                tamanhoOriginal = fileData.tamanhoOriginal;
                tamanhoOtimizado = fileData.tamanhoOtimizado;
                
                // Atualizar campos ocultos
                notaFiscalHidden.value = notaFiscalBase64;
                tipoArquivoHidden.value = tipoArquivo;
                tamanhoOriginalHidden.value = tamanhoOriginal;
                tamanhoOtimizadoHidden.value = tamanhoOtimizado;
                
                // Mostrar preview
                filePreview.style.display = 'block';
                
                if (tipoArquivo.startsWith('image/')) {
                    filePreview.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <i class="fas fa-file-image" style="color: #3b82f6; font-size: 24px;"></i>
                            <div>
                                <div style="font-weight: 600; color: #1e293b;">Nota Fiscal (Recebida via Celular)</div>
                                <div style="font-size: 12px; color: #64748b;">
                                    ${(tamanhoOtimizado / 1024).toFixed(2)}KB ‚Ä¢ ${new Date().toLocaleTimeString()}
                                    ${isEditMode ? ' ‚Ä¢ <span style="color: #10b981;"><i class="fas fa-edit"></i> Modo Edi√ß√£o</span>' : ''}
                                </div>
                            </div>
                            <button type="button" onclick="limparNotaFiscal()" style="margin-left: auto; background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>
                        <img src="${notaFiscalBase64}" style="max-width: 100%; max-height: 200px; border-radius: 6px; margin-top: 10px; border: 1px solid #e2e8f0;">
                    `;
                } else {
                    filePreview.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <i class="fas fa-file-pdf" style="color: #ef4444; font-size: 24px;"></i>
                            <div>
                                <div style="font-weight: 600; color: #1e293b;">Nota Fiscal (Recebida via Celular)</div>
                                <div style="font-size: 12px; color: #64748b;">
                                    ${(tamanhoOtimizado / 1024).toFixed(2)}KB ‚Ä¢ ${new Date().toLocaleTimeString()}
                                    ${isEditMode ? ' ‚Ä¢ <span style="color: #10b981;"><i class="fas fa-edit"></i> Modo Edi√ß√£o</span>' : ''}
                                </div>
                            </div>
                            <button type="button" onclick="limparNotaFiscal()" style="margin-left: auto; background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>
                    `;
                }
                
                // Se for despesa j√° existente, atualizar automaticamente
                if (currentDespesaId && isEditMode) {
                    console.log('üîÑ Atualizando despesa existente com anexo...');
                    // O Core Engine vai pegar os campos atualizados automaticamente
                }
                
                // Limpar sess√£o do localStorage
                localStorage.removeItem('uploadSession_' + sessionId);
            }
            
            // ============================================
            // EVENT LISTENERS
            // ============================================
            
            function configurarEventListeners() {
                // Upload options
                uploadPcBtn.addEventListener('click', () => {
                    uploadPcBtn.classList.add('active');
                    uploadMobileBtn.classList.remove('active');
                    notaFiscalInput.style.display = 'block';
                    notaFiscalInput.click();
                });
                
                uploadMobileBtn.addEventListener('click', () => {
                    uploadMobileBtn.classList.add('active');
                    uploadPcBtn.classList.remove('active');
                    notaFiscalInput.style.display = 'none';
                    
                    // üî• CR√çTICO: Verificar se estamos em modo de edi√ß√£o
                    if (isEditMode && currentDespesaId) {
                        console.log('üì± Gerando QR Code para edi√ß√£o da despesa:', currentDespesaId);
                    } else {
                        console.log('üì± Gerando QR Code para nova despesa');
                    }
                    
                    gerarQRCode();
                });
                
                // QR Code modal
                qrCloseBtn.addEventListener('click', () => {
                    qrModalOverlay.classList.remove('active');
                    if (qrCodeCheckInterval) {
                        clearInterval(qrCodeCheckInterval);
                        qrCodeCheckInterval = null;
                    }
                });
                
                qrRefreshBtn.addEventListener('click', gerarQRCode);
                
                qrModalOverlay.addEventListener('click', (e) => {
                    if (e.target === qrModalOverlay) {
                        qrModalOverlay.classList.remove('active');
                        if (qrCodeCheckInterval) {
                            clearInterval(qrCodeCheckInterval);
                            qrCodeCheckInterval = null;
                        }
                    }
                });
                
                // C√°lculo autom√°tico de totais
                valorBrutoInput.addEventListener('input', calcularTotais);
                ivaSimRadio.addEventListener('change', calcularTotais);
                ivaNaoRadio.addEventListener('change', calcularTotais);
                
                // Status de pagamento condicional
                statusPagoRadio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        dataPagamentoInput.required = true;
                        dataPagamentoInput.disabled = false;
                        if (!dataPagamentoInput.value) {
                            dataPagamentoInput.valueAsDate = new Date();
                        }
                    }
                });
                
                statusPendenteRadio.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        dataPagamentoInput.required = false;
                        dataPagamentoInput.disabled = true;
                        dataPagamentoInput.value = '';
                    }
                });
                
                // Categoria "Outros"
                categoriaSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'OUTROS') {
                        outraCategoriaInput.classList.add('active');
                        outraCategoriaInput.required = true;
                        outraCategoriaInput.disabled = false;
                        outraCategoriaInput.setAttribute('data-bind', 'despesa.outraCategoria');
                    } else {
                        outraCategoriaInput.classList.remove('active');
                        outraCategoriaInput.required = false;
                        outraCategoriaInput.disabled = true;
                        outraCategoriaInput.removeAttribute('data-bind');
                        outraCategoriaInput.value = '';
                    }
                });
                
                // Forma de pagamento "Outro"
                formaPagamentoSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'outro') {
                        outroPagamentoInput.disabled = false;
                        outroPagamentoInput.required = true;
                        outroPagamentoInput.setAttribute('data-bind', 'despesa.outroPagamento');
                    } else {
                        outroPagamentoInput.disabled = true;
                        outroPagamentoInput.required = false;
                        outroPagamentoInput.removeAttribute('data-bind');
                        outroPagamentoInput.value = '';
                    }
                });
                
                // Processar arquivo de nota fiscal (PC)
                notaFiscalInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        processarNotaFiscalPC(file);
                    }
                });
                
                // Bot√£o cancelar
                cancelBtn.addEventListener('click', () => {
                    if (confirm(isEditMode ? 'Tem certeza que deseja cancelar a edi√ß√£o?' : 'Tem certeza que deseja cancelar esta despesa?')) {
                        if (isEditMode) {
                            window.location.href = 'despesas.html';
                        } else {
                            limparFormulario();
                        }
                    }
                });
                
                // Bot√£o salvar
                saveBtn.addEventListener('click', () => {
                    if (validarFormulario()) {
                        saveBtn.classList.add('saving');
                        saveBtn.textContent = 'SALVANDO...';
                        saveBtn.disabled = true;
                        
                        console.log('üì§ Enviando despesa para Core Engine...');
                        console.log('üìé Nota fiscal anexada:', !!notaFiscalBase64);
                        console.log('‚úèÔ∏è Modo:', isEditMode ? 'EDI√á√ÉO' : 'CRIA√á√ÉO');
                        
                        // Se tiver nota fiscal via celular, garantir que os campos est√£o preenchidos
                        if (notaFiscalBase64 && !notaFiscalHidden.value) {
                            notaFiscalHidden.value = notaFiscalBase64;
                            tipoArquivoHidden.value = tipoArquivo;
                            tamanhoOriginalHidden.value = tamanhoOriginal;
                            tamanhoOtimizadoHidden.value = tamanhoOtimizado;
                        }
                    }
                });
            }
            
            // ============================================
            // FUN√á√ïES EXISTENTES (MANTIDAS)
            // ============================================
            
            function calcularTotais() {
                const valorBruto = parseFloat(valorBrutoInput.value) || 0;
                
                if (ivaSimRadio.checked) {
                    const valorComIVA = valorBruto * 1.23;
                    const valorIVA = valorComIVA - valorBruto;
                    
                    valorBrutoDisplay.textContent = formatarMoeda(valorBruto);
                    valorIVADisplay.textContent = formatarMoeda(valorIVA);
                    valorTotalDisplay.textContent = formatarMoeda(valorComIVA);
                    
                    valorTotalHidden.value = valorComIVA.toFixed(2);
                    valorIVAHidden.value = valorIVA.toFixed(2);
                } else {
                    valorBrutoDisplay.textContent = formatarMoeda(valorBruto);
                    valorIVADisplay.textContent = '‚Ç¨0.00';
                    valorTotalDisplay.textContent = formatarMoeda(valorBruto);
                    
                    valorTotalHidden.value = valorBruto.toFixed(2);
                    valorIVAHidden.value = '0.00';
                }
            }
            
            function formatarMoeda(valor) {
                return new Intl.NumberFormat('pt-PT', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(valor);
            }
            
            async function loadDespesaForEdit(despesaId) {
                try {
                    console.log(`üì• Carregando despesa para edi√ß√£o: ${despesaId}`);
                    showMessage('Carregando dados da despesa para edi√ß√£o...', 'info');
                    
                    const response = await fetch('/api/database/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            schema: 'despesa',
                            filters: {}
                        })
                    });
                    
                    if (!response.ok) throw new Error('Erro ao buscar despesas');
                    
                    const result = await response.json();
                    const eventos = result.events || [];
                    const despesaEvento = eventos.find(evento => evento.id === despesaId);
                    
                    if (!despesaEvento) throw new Error('Despesa n√£o encontrada');
                    
                    const despesa = despesaEvento.payload;
                    console.log('üí∞ Despesa carregada para edi√ß√£o:', despesa);
                    
                    // üî• CR√çTICO: Definir as vari√°veis globais ANTES de preencher o formul√°rio
                    currentDespesaId = despesaEvento.id;
                    isEditMode = true;
                    
                    // Atualizar o campo hidden do ID
                    if (despesaIdInput) {
                        despesaIdInput.value = currentDespesaId;
                        console.log('‚úÖ ID da despesa definido:', currentDespesaId);
                    }
                    
                    // Preencher campos do formul√°rio
                    document.getElementById('fornecedor').value = despesa.fornecedor || '';
                    document.getElementById('descricao').value = despesa.descricao || '';
                    document.getElementById('dataCompra').value = despesa.dataCompra || '';
                    document.getElementById('dataVencimento').value = despesa.dataVencimento || '';
                    document.getElementById('valorBruto').value = despesa.valorBruto || '0';
                    document.getElementById('categoria').value = despesa.categoria || '';
                    document.getElementById('formaPagamento').value = despesa.formaPagamento || '';
                    document.getElementById('observacoes').value = despesa.observacoes || '';
                    document.getElementById('telefone').value = despesa.telefone || '';
                    document.getElementById('nifFornecedor').value = despesa.nifFornecedor || '';
                    
                    // Status de pagamento
                    if (despesa.statusPagamento) {
                        const statusValue = (despesa.statusPagamento === 'paga' || despesa.statusPagamento === 'pago') ? 'pago' : 'pendente';
                        const statusRadio = document.querySelector(`input[name="statusPagamento"][value="${statusValue}"]`);
                        if (statusRadio) statusRadio.checked = true;
                        
                        if (statusValue === 'pago') {
                            dataPagamentoInput.disabled = false;
                            dataPagamentoInput.value = despesa.dataPagamento || '';
                        } else {
                            dataPagamentoInput.disabled = true;
                        }
                    }
                    
                    // Data de pagamento
                    if (despesa.dataPagamento) {
                        document.getElementById('dataPagamento').value = despesa.dataPagamento;
                    }
                    
                    // IVA
                    if (despesa.comIVA !== undefined) {
                        const comIVA = despesa.comIVA === 'sim' || despesa.comIVA === 'comIVA' || despesa.comIVA === true;
                        const ivaRadio = comIVA ? ivaSimRadio : ivaNaoRadio;
                        if (ivaRadio) ivaRadio.checked = true;
                    }
                    
                    // Categoria "Outros"
                    if (despesa.categoria === 'OUTROS' && despesa.outraCategoria) {
                        categoriaSelect.value = 'OUTROS';
                        setTimeout(() => {
                            categoriaSelect.dispatchEvent(new Event('change'));
                            outraCategoriaInput.value = despesa.outraCategoria;
                        }, 100);
                    }
                    
                    // Forma de pagamento "Outro"
                    if (despesa.formaPagamento === 'outro' && despesa.outroPagamento) {
                        formaPagamentoSelect.value = 'outro';
                        setTimeout(() => {
                            formaPagamentoSelect.dispatchEvent(new Event('change'));
                            outroPagamentoInput.value = despesa.outroPagamento;
                        }, 100);
                    }
                    
                    // Nota fiscal (se existir)
                    if (despesa.notaFiscal && despesa.tipoArquivo) {
                        notaFiscalBase64 = despesa.notaFiscal;
                        tipoArquivo = despesa.tipoArquivo;
                        tamanhoOriginal = despesa.tamanhoOriginal || 0;
                        tamanhoOtimizado = despesa.tamanhoOtimizado || 0;
                        
                        // Atualizar campos ocultos
                        notaFiscalHidden.value = notaFiscalBase64;
                        tipoArquivoHidden.value = tipoArquivo;
                        tamanhoOriginalHidden.value = tamanhoOriginal;
                        tamanhoOtimizadoHidden.value = tamanhoOtimizado;
                        
                        filePreview.style.display = 'block';
                        filePreview.innerHTML = `
                            <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-file-alt" style="color: #0ea5e9;"></i>
                                    <div>
                                        <div style="font-weight: 600; color: #0c4a6e;">Nota Fiscal existente (Modo Edi√ß√£o)</div>
                                        <div style="font-size: 12px; color: #64748b;">
                                            Tamanho: ${(tamanhoOtimizado / 1024).toFixed(2)}KB
                                        </div>
                                    </div>
                                    <button type="button" onclick="limparNotaFiscal()" style="margin-left: auto; background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                ${tipoArquivo.startsWith('image/') ? `
                                    <img src="${notaFiscalBase64}" style="max-width: 100%; max-height: 150px; border-radius: 6px; margin-top: 10px; border: 1px solid #e2e8f0;">
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    saveBtn.textContent = 'ATUALIZAR DESPESA';
                    calcularTotais();
                    
                    // Configurar evento listeners ap√≥s carregar dados
                    setTimeout(() => {
                        configurarEventListeners();
                        showMessage('Despesa carregada com sucesso para edi√ß√£o! Agora voc√™ pode anexar uma nova nota fiscal via QR Code.', 'success');
                    }, 500);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar despesa:', error);
                    showMessage('Erro ao carregar despesa: ' + error.message, 'error');
                    
                    setTimeout(() => {
                        if (confirm('N√£o foi poss√≠vel carregar a despesa para edi√ß√£o. Deseja voltar para a lista?')) {
                            window.location.href = 'despesas.html';
                        }
                    }, 2000);
                }
            }
            
            // ============================================
            // FUN√á√ïES DE PROCESSAMENTO DE ARQUIVOS
            // ============================================
            
            async function processarNotaFiscalPC(file) {
                if (file.size > 5 * 1024 * 1024) {
                    showMessage('O arquivo √© muito grande (m√°x. 5MB).', 'error');
                    notaFiscalInput.value = '';
                    limparNotaFiscal();
                    return;
                }
                
                filePreview.style.display = 'block';
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileInfo').textContent = 
                    `Tipo: ${file.type} ‚Ä¢ Tamanho original: ${(file.size / 1024).toFixed(2)}KB`;
                document.getElementById('compressionInfo').textContent = 'Otimizando arquivo...';
                
                try {
                    let resultado;
                    
                    if (file.type.startsWith('image/')) {
                        resultado = await comprimirImagem(file, 1024, 0.7);
                        
                        const fileImage = document.getElementById('fileImage');
                        fileImage.src = resultado.base64;
                        fileImage.style.display = 'block';
                        
                        document.getElementById('compressionInfo').textContent = 
                            `Imagem otimizada: ${(resultado.tamanhoOtimizado / 1024).toFixed(2)}KB (redu√ß√£o de ${((1 - resultado.tamanhoOtimizado/file.size) * 100).toFixed(1)}%)`;
                    } else {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        
                        await new Promise((resolve) => {
                            reader.onload = (event) => {
                                resultado = {
                                    base64: event.target.result,
                                    tipo: file.type,
                                    tamanhoOriginal: file.size,
                                    tamanhoOtimizado: Math.round((event.target.result.length * 3) / 4)
                                };
                                
                                document.getElementById('compressionInfo').textContent = 
                                    `Arquivo: ${(resultado.tamanhoOtimizado / 1024).toFixed(2)}KB`;
                                
                                document.getElementById('fileImage').style.display = 'none';
                                
                                notaFiscalBase64 = resultado.base64;
                                tipoArquivo = resultado.tipo;
                                tamanhoOriginal = resultado.tamanhoOriginal;
                                tamanhoOtimizado = resultado.tamanhoOtimizado;
                                
                                notaFiscalHidden.value = notaFiscalBase64;
                                tipoArquivoHidden.value = tipoArquivo;
                                tamanhoOriginalHidden.value = tamanhoOriginal;
                                tamanhoOtimizadoHidden.value = tamanhoOtimizado;
                                
                                resolve();
                            };
                        });
                    }
                    
                    if (resultado && !notaFiscalHidden.value) {
                        notaFiscalBase64 = resultado.base64;
                        tipoArquivo = resultado.tipo;
                        tamanhoOriginal = resultado.tamanhoOriginal;
                        tamanhoOtimizado = resultado.tamanhoOtimizado || resultado.tamanhoOriginal;
                        
                        notaFiscalHidden.value = notaFiscalBase64;
                        tipoArquivoHidden.value = tipoArquivo;
                        tamanhoOriginalHidden.value = tamanhoOriginal;
                        tamanhoOtimizadoHidden.value = tamanhoOtimizado;
                    }
                    
                    showMessage('Nota fiscal processada com sucesso!', 'success');
                    
                } catch (error) {
                    console.error('Erro ao processar arquivo:', error);
                    showMessage('Erro ao processar arquivo. Tente novamente.', 'error');
                    limparNotaFiscal();
                }
            }
            
            function comprimirImagem(file, maxWidth = 1024, quality = 0.7) {
                return new Promise((resolve, reject) => {
                    if (!file.type.startsWith('image/')) {
                        resolve({
                            base64: '',
                            tipo: file.type,
                            tamanhoOriginal: file.size,
                            tamanhoOtimizado: file.size
                        });
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            const base64 = canvas.toDataURL('image/jpeg', quality);
                            
                            resolve({
                                base64: base64,
                                tipo: 'image/jpeg',
                                tamanhoOriginal: file.size,
                                tamanhoOtimizado: Math.round((base64.length * 3) / 4)
                            });
                        };
                        
                        img.onerror = reject;
                    };
                    
                    reader.onerror = reject;
                });
            }
            
            window.limparNotaFiscal = function() {
                if (confirm('Tem certeza que deseja remover a nota fiscal?')) {
                    notaFiscalBase64 = '';
                    tipoArquivo = '';
                    tamanhoOriginal = 0;
                    tamanhoOtimizado = 0;
                    filePreview.style.display = 'none';
                    notaFiscalInput.value = '';
                    
                    notaFiscalHidden.value = '';
                    tipoArquivoHidden.value = '';
                    tamanhoOriginalHidden.value = '';
                    tamanhoOtimizadoHidden.value = '';
                    
                    showMessage('Nota fiscal removida.', 'info');
                }
            };
            
            // ============================================
            // FUN√á√ïES AUXILIARES
            // ============================================
            
            function validarFormulario() {
                const camposObrigatorios = [
                    'fornecedor', 'descricao', 'dataCompra', 
                    'dataVencimento', 'valorBruto', 'categoria', 
                    'formaPagamento'
                ];
                
                for (const campoId of camposObrigatorios) {
                    const campo = document.getElementById(campoId);
                    if (!campo.value.trim()) {
                        showMessage(`O campo "${campo.previousElementSibling?.textContent.replace(' *', '') || campoId}" √© obrigat√≥rio.`, 'warning');
                        campo.focus();
                        return false;
                    }
                }
                
                if (categoriaSelect.value === 'OUTROS' && !outraCategoriaInput.value.trim()) {
                    showMessage('Por favor, especifique a categoria "Outros".', 'warning');
                    outraCategoriaInput.focus();
                    return false;
                }
                
                if (formaPagamentoSelect.value === 'outro' && !outroPagamentoInput.value.trim()) {
                    showMessage('Por favor, especifique a forma de pagamento "Outro".', 'warning');
                    outroPagamentoInput.focus();
                    return false;
                }
                
                const valorBruto = parseFloat(document.getElementById('valorBruto').value);
                if (isNaN(valorBruto) || valorBruto <= 0) {
                    showMessage('Por favor, insira um valor bruto v√°lido (maior que 0).', 'warning');
                    document.getElementById('valorBruto').focus();
                    return false;
                }
                
                const dataCompra = new Date(document.getElementById('dataCompra').value);
                const dataVencimento = new Date(document.getElementById('dataVencimento').value);
                if (dataVencimento < dataCompra) {
                    showMessage('A data de vencimento n√£o pode ser anterior √† data da compra.', 'warning');
                    document.getElementById('dataVencimento').focus();
                    return false;
                }
                
                if (statusPagoRadio.checked && !dataPagamentoInput.value) {
                    showMessage('A data de pagamento √© obrigat√≥ria quando o status √© "Pago".', 'warning');
                    dataPagamentoInput.focus();
                    return false;
                }
                
                if (tamanhoOtimizado > 500 * 1024) {
                    if (!confirm(`A nota fiscal otimizada tem ${(tamanhoOtimizado / 1024).toFixed(2)}KB. Isso pode sobrecarregar o banco de dados. Deseja continuar?`)) {
                        return false;
                    }
                }
                
                return true;
            }
            
            function showMessage(message, type = 'info') {
                const existingMessages = document.querySelectorAll('.success-message');
                existingMessages.forEach(msg => msg.remove());
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'success-message';
                messageDiv.textContent = message;
                
                if (type === 'warning') {
                    messageDiv.style.backgroundColor = '#f59e0b';
                } else if (type === 'error') {
                    messageDiv.style.backgroundColor = '#ef4444';
                } else if (type === 'success') {
                    messageDiv.style.backgroundColor = '#10b981';
                }
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }
            
            function limparFormulario() {
                despesaForm.reset();
                limparNotaFiscal();
                outraCategoriaInput.classList.remove('active');
                outraCategoriaInput.value = '';
                outraCategoriaInput.disabled = true;
                outraCategoriaInput.removeAttribute('data-bind');
                outroPagamentoInput.disabled = true;
                outroPagamentoInput.value = '';
                outroPagamentoInput.removeAttribute('data-bind');
                
                isEditMode = false;
                currentDespesaId = '';
                despesaIdInput.value = '';
                
                inicializarFormulario();
                
                showMessage('Formul√°rio limpo. Pronto para nova despesa.', 'info');
            }
            
            // ============================================
            // CONFIGURA√á√ÉO DO CORE ENGINE
            // ============================================
            
            document.addEventListener('coreCommitSuccess', (event) => {
                const detail = event.detail || {};
                
                if (detail.schema === 'despesa') {
                    saveBtn.classList.remove('saving');
                    
                    if (detail.isUpdate) {
                        saveBtn.textContent = '‚úì ATUALIZADA!';
                        showMessage('Despesa atualizada com sucesso!', 'success');
                    } else {
                        saveBtn.textContent = '‚úì SALVA!';
                        showMessage('Despesa criada com sucesso!', 'success');
                        
                        if (detail.documentId && despesaIdInput) {
                            despesaIdInput.value = detail.documentId;
                            isEditMode = true;
                            currentDespesaId = detail.documentId;
                            saveBtn.textContent = 'ATUALIZAR DESPESA';
                        }
                    }
                    
                    setTimeout(() => {
                        if (!detail.isUpdate) {
                            if (confirm('Despesa salva com sucesso! Deseja criar uma nova despesa?')) {
                                limparFormulario();
                                saveBtn.textContent = 'SALVAR DESPESA';
                                saveBtn.disabled = false;
                            } else {
                                window.location.href = 'despesas.html';
                            }
                        } else {
                            saveBtn.disabled = false;
                        }
                    }, 2000);
                }
            });
            
            document.addEventListener('coreCommitError', (event) => {
                console.error('Erro no commit:', event.detail);
                saveBtn.classList.remove('saving');
                saveBtn.textContent = isEditMode ? 'ATUALIZAR DESPESA' : 'SALVAR DESPESA';
                saveBtn.disabled = false;
                
                showMessage('Erro ao salvar despesa. Tente novamente.', 'error');
            });
            
            // ============================================
            // INICIALIZA√á√ÉO
            // ============================================
            
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            
            if (editId) {
                console.log('‚úèÔ∏è Modo EDI√á√ÉO detectado para despesa ID:', editId);
                showMessage('Carregando despesa para edi√ß√£o...', 'info');
                loadDespesaForEdit(editId);
            } else {
                console.log('üÜï Modo CRIA√á√ÉO detectado');
                inicializarFormulario();
            }
            
            console.log('‚úÖ Sistema de despesas com QR Code inicializado com sucesso');
        });
    </script>
    
    <!-- CONEX√ÉO COM O CORE ENGINE -->
    <script src="../core/engine.js"></script>
</body>
</html>