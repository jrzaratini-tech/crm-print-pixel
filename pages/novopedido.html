<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio de Pedido - PrintPixel</title>
    <style>
        /* Estilo para mensagem de sucesso */
        .success-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Modal para pagamentos */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2563eb;
        }
        
        .modal-title {
            font-size: 22px;
            color: #2563eb;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .close-modal:hover {
            background-color: #f1f5f9;
            color: #dc2626;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Estilos principais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background-color: #f8fafc;
            color: #1e293b;
            padding: 20px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            padding: 30px;
        }
        
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #2563eb;
        }
        
        .page-title {
            font-size: 28px;
            color: #2563eb;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-title::before {
            content: "üì¶";
            font-size: 24px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.2);
        }
        
        .btn-success {
            background-color: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }
        
        .form-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 18px;
            color: #2563eb;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2563eb;
            font-weight: 600;
            letter-spacing: -0.2px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #334155;
            font-size: 14px;
            letter-spacing: 0.2px;
        }
        
        input, select, textarea {
            padding: 12px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 6px;
            font-size: 15px;
            transition: all 0.2s;
            background-color: white;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        input[type="date"] {
            padding: 11px 16px;
        }
        
        input[type="number"] {
            text-align: right;
        }
        
        .status-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .status-option {
            display: flex;
            align-items: center;
        }
        
        .status-option input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }
        
        .status-option label {
            margin-bottom: 0;
            font-weight: 500;
        }
        
        .products-section {
            margin-top: 40px;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
        }
        
        .products-table th {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: 600;
            text-align: left;
            padding: 18px 20px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .products-table td {
            padding: 16px 20px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .products-table input, .products-table select, .products-table textarea {
            width: 100%;
            padding: 10px 14px;
            font-size: 14px;
            border: 1.5px solid #e2e8f0;
            border-radius: 5px;
        }
        
        .products-table textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        .remove-btn {
            background-color: transparent;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-btn:hover {
            background-color: #fee2e2;
            transform: scale(1.1);
        }
        
        .add-product-btn {
            background-color: #059669;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            transition: all 0.2s;
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .add-product-btn:hover {
            background-color: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }
        
        .add-product-btn span {
            font-size: 20px;
            margin-right: 10px;
        }
        
        /* Pagamentos Section */
        .payments-section {
            margin-top: 40px;
        }
        
        .payments-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .payments-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .payment-summary-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .payment-summary-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .payment-summary-value {
            font-size: 28px;
            font-weight: 700;
        }
        
        .payments-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
        }
        
        .payments-table th {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: 600;
            text-align: left;
            padding: 18px 20px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .payments-table td {
            padding: 16px 20px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .payment-status {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .payment-status.pago {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .payment-status.pendente {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .payment-status.atrasado {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .add-payment-btn {
            background-color: #7c3aed;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            transition: all 0.2s;
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .add-payment-btn:hover {
            background-color: #6d28d9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.2);
        }
        
        .add-payment-btn span {
            font-size: 20px;
            margin-right: 10px;
        }
        
        .iva-option-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1.5px solid #e2e8f0;
        }
        
        .iva-option-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .iva-option {
            display: flex;
            align-items: center;
        }
        
        .iva-option input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }
        
        .iva-option label {
            margin-bottom: 0;
            font-weight: 500;
        }
        
        .totals-section {
            margin-top: 40px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1.5px solid #e2e8f0;
        }
        
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .total-card {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .total-label {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .total-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }
        
        .total-value.final {
            color: #059669;
        }
        
        .total-value.pendente {
            color: #dc2626;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }
        
        .btn-cancel {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 15px 32px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .btn-cancel:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }
        
        .btn-save {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 15px 32px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
            letter-spacing: 0.3px;
        }
        
        .btn-save:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        
        .btn-save.saving {
            background-color: #059669;
            opacity: 0.8;
        }
        
        .required::after {
            content: " *";
            color: #ef4444;
        }
        
        .field-note {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .header-section {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .totals-grid {
                grid-template-columns: 1fr;
            }
            
            .payments-summary-grid {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn-cancel, .btn-save {
                width: 100%;
            }
            
            .products-table, .payments-table {
                display: block;
                overflow-x: auto;
            }
            
            .status-group {
                flex-direction: column;
                gap: 12px;
            }
            
            .iva-option-group {
                flex-direction: column;
                gap: 12px;
            }
        }
    </style>
</head>
<body data-page-id="novo_pedido" data-page-type="WRITE">
    <div class="container">
        <div class="header-section">
            <div class="page-title">Novo Pedido</div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='pedidos.html'">
                    <span>‚Üê</span> Voltar para Lista
                </button>
            </div>
        </div>
        
        <form id="pedidoForm">
            <!-- CR√çTICO: Campo oculto para armazenar o ID do documento Firebase -->
            <input type="hidden" id="pedidoId" data-bind="pedido.id" value="">
            
            <div class="form-section">
                <h2 class="section-title">Informa√ß√µes do Cliente</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cliente" class="required">Nome do Cliente</label>
                        <input type="text" id="cliente" name="cliente" data-bind="pedido.cliente" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="empresa" class="required">Nome da Empresa</label>
                        <input type="text" id="empresa" name="empresa" data-bind="pedido.empresa" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="nif" class="required">Contribuinte / NIF</label>
                        <input type="text" id="nif" name="nif" data-bind="pedido.nif" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="morada" class="required">Morada</label>
                        <input type="text" id="morada" name="morada" data-bind="pedido.morada" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="telemovel" class="required">Telem√≥vel</label>
                        <input type="tel" id="telemovel" name="telemovel" data-bind="pedido.telemovel" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="numero" class="required">N√∫mero do Pedido</label>
                        <input type="text" id="numero" name="numero" data-bind="pedido.numero" required readonly style="background-color: #f1f5f9;">
                        <div class="field-note">Formato autom√°tico: ANO/SEQU√äNCIA (ex: 2026/0001)</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroFatura">N√∫mero da Fatura</label>
                        <input type="text" id="numeroFatura" name="numeroFatura" data-bind="pedido.numeroFatura" placeholder="Ex: FT2026/0001">
                    </div>
                    
                    <div class="form-group">
                        <label for="dataEntrega" class="required">Data da Entrega</label>
                        <input type="date" id="dataEntrega" name="dataEntrega" data-bind="pedido.dataEntrega" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataFechamento">Data de Fechamento</label>
                        <input type="date" id="dataFechamento" name="dataFechamento" data-bind="pedido.dataFechamento">
                    </div>
                    
                    <div class="form-group">
                        <label for="valorInstalacao">Valor Instala√ß√£o / Deslocamento (‚Ç¨)</label>
                        <input type="number" id="valorInstalacao" name="valorInstalacao" data-bind="pedido.instalacao" min="0" step="0.01" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="atendente" class="required">Atendente</label>
                        <input type="text" id="atendente" name="atendente" data-bind="pedido.atendente" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Status do Pedido</label>
                        <div class="status-group">
                            <div class="status-option">
                                <input type="radio" id="statusPendente" name="status" value="pendente" data-bind="pedido.status" checked>
                                <label for="statusPendente">Pendente</label>
                            </div>
                            <div class="status-option">
                                <input type="radio" id="statusProcessamento" name="status" value="processamento" data-bind="pedido.status">
                                <label for="statusProcessamento">Em Processamento</label>
                            </div>
                            <div class="status-option">
                                <input type="radio" id="statusConcluido" name="status" value="concluido" data-bind="pedido.status">
                                <label for="statusConcluido">Conclu√≠do</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="observacoes">Observa√ß√µes Gerais</label>
                    <textarea id="observacoes" name="observacoes" data-bind="pedido.observacoes" rows="3" placeholder="Informa√ß√µes adicionais sobre o pedido..."></textarea>
                </div>
            </div>
            
            <div class="products-section">
                <h2 class="section-title">Produtos</h2>
                
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Tamanho</th>
                            <th>Quantidade</th>
                            <th>Valor Unit√°rio (‚Ç¨)</th>
                            <th>Observa√ß√µes</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- Produtos ser√£o adicionados dinamicamente aqui -->
                    </tbody>
                </table>
                
                <button type="button" class="add-product-btn" id="addProductBtn">
                    <span>+</span> ADICIONAR PRODUTO
                </button>
            </div>
            
            <div class="payments-section">
                <h2 class="section-title">Pagamentos</h2>
                
                <div class="payments-summary">
                    <h3 style="color: white; margin-bottom: 5px;">Resumo Financeiro</h3>
                    <p style="opacity: 0.9; font-size: 14px;">Controle completo de entradas e saldos pendentes</p>
                    
                    <div class="payments-summary-grid">
                        <div class="payment-summary-card">
                            <div class="payment-summary-label">TOTAL DO PEDIDO</div>
                            <div class="payment-summary-value" id="resumoTotal">‚Ç¨0.00</div>
                        </div>
                        <div class="payment-summary-card">
                            <div class="payment-summary-label">TOTAL PAGO</div>
                            <div class="payment-summary-value" id="resumoPago">‚Ç¨0.00</div>
                        </div>
                        <div class="payment-summary-card">
                            <div class="payment-summary-label">SALDO PENDENTE</div>
                            <div class="payment-summary-value" id="resumoPendente">‚Ç¨0.00</div>
                        </div>
                    </div>
                </div>
                
                <table class="payments-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Data</th>
                            <th>Valor (‚Ç¨)</th>
                            <th>Forma de Pagamento</th>
                            <th>Observa√ß√µes</th>
                            <th>Status</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        <!-- Pagamentos ser√£o adicionados dinamicamente aqui -->
                    </tbody>
                </table>
                
                <button type="button" class="add-payment-btn" id="addPaymentBtn">
                    <span>+</span> REGISTRAR PAGAMENTO
                </button>
            </div>
            
            <div class="totals-section">
                <h2 class="section-title">Totais</h2>
                
                <div class="iva-option-group">
                    <div class="iva-option">
                        <input type="radio" id="ivaSim" name="ivaOption" value="sim" data-bind="pedido.comIVA" checked>
                        <label for="ivaSim">Com IVA (23%)</label>
                    </div>
                    <div class="iva-option">
                        <input type="radio" id="ivaNao" name="ivaOption" value="nao" data-bind="pedido.comIVA">
                        <label for="ivaNao">Isento de IVA</label>
                    </div>
                </div>
                
                <div class="totals-grid">
                    <div class="total-card">
                        <div class="total-label">Subtotal Produtos</div>
                        <div class="total-value" id="subtotalProdutos">0,00 ‚Ç¨</div>
                    </div>
                    
                    <div class="total-card">
                        <div class="total-label">Instala√ß√£o / Deslocamento</div>
                        <div class="total-value" id="totalInstalacaoDisplay">0,00 ‚Ç¨</div>
                    </div>
                    
                    <div class="total-card">
                        <div class="total-label">Valor do IVA (23%)</div>
                        <div class="total-value" id="valorIVA">0,00 ‚Ç¨</div>
                    </div>
                    
                    <div class="total-card">
                        <div class="total-label">TOTAL FINAL</div>
                        <div class="total-value final" id="totalFinal">0,00 ‚Ç¨</div>
                    </div>
                </div>
                
                <!-- Campos ocultos para totais (usados pelo engine.js) -->
                <input type="hidden" id="pedidoSubtotal" data-bind="pedido.subtotal" value="0">
                <input type="hidden" id="pedidoIVA" data-bind="pedido.iva" value="0">
                <input type="hidden" id="pedidoTotal" data-bind="pedido.total" value="0">
                <input type="hidden" id="pedidoTotalPago" data-bind="pedido.totalPago" value="0">
                <input type="hidden" id="pedidoSaldoPendente" data-bind="pedido.saldoPendente" value="0">
                <input type="hidden" id="pedidoStatusPagamento" data-bind="pedido.statusPagamento" value="pendente">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="cancelBtn">CANCELAR</button>
                <button type="button" class="btn-save" id="saveBtn" data-action="commit">SALVAR PEDIDO</button>
            </div>
        </form>
    </div>

    <!-- Modal para Adicionar Pagamento -->
    <div id="paymentModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Registrar Novo Pagamento</h3>
                <button type="button" class="close-modal" id="closePaymentModal">&times;</button>
            </div>
            
            <form id="paymentForm">
                <input type="hidden" id="paymentId" value="">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="paymentType" class="required">Tipo de Pagamento</label>
                        <select id="paymentType" name="paymentType" required>
                            <option value="entrada">Entrada</option>
                            <option value="parcela">Parcela</option>
                            <option value="final">Pagamento Final</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentDate" class="required">Data do Pagamento</label>
                        <input type="date" id="paymentDate" name="paymentDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentAmount" class="required">Valor (‚Ç¨)</label>
                        <input type="number" id="paymentAmount" name="paymentAmount" min="0" step="0.01" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentMethod" class="required">Forma de Pagamento</label>
                        <select id="paymentMethod" name="paymentMethod" required>
                            <option value="">Selecione...</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="mbway">MBWay</option>
                            <option value="transferencia">Transfer√™ncia Banc√°ria</option>
                            <option value="cartao">Cart√£o de Cr√©dito/D√©bito</option>
                            <option value="cheque">Cheque</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentStatus">Status</label>
                        <select id="paymentStatus" name="paymentStatus">
                            <option value="pago" selected>Pago</option>
                            <option value="pendente">Pendente</option>
                            <option value="atrasado">Atrasado</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="paymentObservations">Observa√ß√µes</label>
                        <textarea id="paymentObservations" name="paymentObservations" rows="3" placeholder="Observa√ß√µes sobre o pagamento..."></textarea>
                    </div>
                    
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="paymentReference">Refer√™ncia/Comprovante</label>
                        <input type="text" id="paymentReference" name="paymentReference" placeholder="N¬∫ comprovante, transfer√™ncia, etc.">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="cancelPaymentBtn">CANCELAR</button>
                    <button type="button" class="btn-save" id="savePaymentBtn">SALVAR PAGAMENTO</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // SISTEMA DE PEDIDOS - VERS√ÉO CORRIGIDA
        // ============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Sistema de pedidos inicializado v5.2.2');
            
            // Configura√ß√µes iniciais
            const produtos = [
                "Logo em Acr√≠lico", "Logo Flutuante para Montra", "Neon LED", "Alto Colante",
                "Logo 3D com LED", "Logo 3D sem LED", "Brindes", "Painel de ACM",
                "Caixa de Luz", "Outro"
            ];
            
            let productIndex = 0;
            let paymentIndex = 0;
            let isEditMode = false;
            let currentPedidoId = '';
            
            // Refer√™ncias DOM
            const productsTableBody = document.getElementById('productsTableBody');
            const paymentsTableBody = document.getElementById('paymentsTableBody');
            const pedidoIdInput = document.getElementById('pedidoId');
            const numeroPedidoInput = document.getElementById('numero');
            const numeroFaturaInput = document.getElementById('numeroFatura');
            const valorInstalacaoInput = document.getElementById('valorInstalacao');
            const dataFechamentoInput = document.getElementById('dataFechamento');
            
            // Elementos de exibi√ß√£o de totais
            const subtotalProdutosEl = document.getElementById('subtotalProdutos');
            const totalInstalacaoEl = document.getElementById('totalInstalacaoDisplay');
            const valorIVAEl = document.getElementById('valorIVA');
            const totalFinalEl = document.getElementById('totalFinal');
            const resumoTotalEl = document.getElementById('resumoTotal');
            const resumoPagoEl = document.getElementById('resumoPago');
            const resumoPendenteEl = document.getElementById('resumoPendente');
            
            // Campos ocultos para engine.js
            const pedidoSubtotalInput = document.getElementById('pedidoSubtotal');
            const pedidoIVAInput = document.getElementById('pedidoIVA');
            const pedidoTotalInput = document.getElementById('pedidoTotal');
            const pedidoTotalPagoInput = document.getElementById('pedidoTotalPago');
            const pedidoSaldoPendenteInput = document.getElementById('pedidoSaldoPendente');
            const pedidoStatusPagamentoInput = document.getElementById('pedidoStatusPagamento');
            
            // Verificar se √© modo de edi√ß√£o
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            
            if (editId) {
                console.log(`‚úèÔ∏è Modo EDI√á√ÉO detectado para ID: ${editId}`);
                loadPedidoForEdit(editId);
            } else {
                console.log('üÜï Modo CRIA√á√ÉO detectado');
                setupNewPedido();
            }
            
            // ============================================
            // FUN√á√ïES PRINCIPAIS
            // ============================================
            
            function setupNewPedido() {
                // Configurar datas padr√£o
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                document.getElementById('dataEntrega').valueAsDate = tomorrow;
                document.getElementById('dataFechamento').valueAsDate = null;
                document.getElementById('valorInstalacao').value = '0';
                document.getElementById('numeroFatura').value = '';
                
                // Gerar n√∫mero de pedido autom√°tico
                gerarNumeroPedido();
                
                // Adicionar primeiro produto
                addProductRow();
                
                // Adicionar primeira linha de pagamento (entrada)
                const hoje = new Date().toISOString().split('T')[0];
                addPaymentRow({
                    tipo: 'entrada',
                    data: hoje,
                    valor: 0,
                    formaPagamento: 'dinheiro',
                    status: 'pendente',
                    observacoes: 'Entrada inicial'
                });
                
                // Calcular totais iniciais
                calculateTotals();
            }
            
            async function loadPedidoForEdit(pedidoId) {
                try {
                    console.log(`üì• Carregando pedido para edi√ß√£o: ${pedidoId}`);
                    
                    // üî• CORRE√á√ÉO: Buscar todos e filtrar localmente
                    const response = await fetch('/api/database/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            schema: 'pedido',
                            filters: {}  // Buscar todos os pedidos
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao buscar pedidos');
                    }
                    
                    const result = await response.json();
                    const eventos = result.events || [];
                    
                    // üî• CORRE√á√ÉO: Filtrar pelo ID correto
                    const pedidoEvento = eventos.find(evento => evento.id === pedidoId);
                    
                    if (!pedidoEvento) {
                        throw new Error('Pedido n√£o encontrado');
                    }
                    
                    const pedido = pedidoEvento.payload;
                    
                    console.log('üì¶ Pedido carregado:', pedido);
                    
                    // Preencher campos do formul√°rio
                    document.getElementById('cliente').value = pedido.cliente || '';
                    document.getElementById('empresa').value = pedido.empresa || '';
                    document.getElementById('nif').value = pedido.nif || '';
                    document.getElementById('morada').value = pedido.morada || '';
                    document.getElementById('telemovel').value = pedido.telemovel || '';
                    document.getElementById('numero').value = pedido.numero || '';
                    document.getElementById('numeroFatura').value = pedido.numeroFatura || '';
                    document.getElementById('dataEntrega').value = pedido.dataEntrega || '';
                    document.getElementById('dataFechamento').value = pedido.dataFechamento || '';
                    document.getElementById('valorInstalacao').value = pedido.instalacao || '0';
                    document.getElementById('atendente').value = pedido.atendente || '';
                    document.getElementById('observacoes').value = pedido.observacoes || '';
                    
                    // Status
                    if (pedido.status) {
                        const statusRadio = document.querySelector(`input[name="status"][value="${pedido.status}"]`);
                        if (statusRadio) statusRadio.checked = true;
                    }
                    
                    // IVA
                    if (pedido.comIVA) {
                        const ivaRadio = document.querySelector(`input[name="ivaOption"][value="${pedido.comIVA}"]`);
                        if (ivaRadio) ivaRadio.checked = true;
                    }
                    
                    // Produtos
                    productsTableBody.innerHTML = '';
                    productIndex = 0;
                    
                    if (pedido.produtos && Array.isArray(pedido.produtos)) {
                        pedido.produtos.forEach(produto => {
                            addProductRow(produto);
                        });
                    } else {
                        addProductRow();
                    }
                    
                    // Pagamentos
                    paymentsTableBody.innerHTML = '';
                    paymentIndex = 0;
                    
                    if (pedido.pagamentos && Array.isArray(pedido.pagamentos)) {
                        pedido.pagamentos.forEach(pagamento => {
                            addPaymentRow(pagamento);
                        });
                    } else {
                        // Se n√£o tem pagamentos, criar um padr√£o com entrada
                        const hoje = new Date().toISOString().split('T')[0];
                        addPaymentRow({
                            tipo: 'entrada',
                            data: hoje,
                            valor: 0,
                            formaPagamento: 'dinheiro',
                            status: 'pendente',
                            observacoes: 'Entrada inicial'
                        });
                    }
                    
                    // Configurar modo de edi√ß√£o
                    isEditMode = true;
                    currentPedidoId = pedidoEvento.id;
                    pedidoIdInput.value = currentPedidoId;
                    
                    // Tornar o campo n√∫mero edit√°vel no modo edi√ß√£o
                    numeroPedidoInput.removeAttribute('readonly');
                    numeroPedidoInput.style.backgroundColor = '';
                    
                    // Atualizar texto do bot√£o
                    document.getElementById('saveBtn').textContent = 'ATUALIZAR PEDIDO';
                    
                    // Calcular totais
                    calculateTotals();
                    
                    showMessage('Pedido carregado para edi√ß√£o.', 'info');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar pedido:', error);
                    showMessage('Erro ao carregar pedido. Redirecionando...', 'error');
                    setTimeout(() => {
                        window.location.href = 'pedidos.html';
                    }, 2000);
                }
            }
            
            async function gerarNumeroPedido() {
                try {
                    const anoAtual = new Date().getFullYear();
                    
                    const response = await fetch('/api/database/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            schema: 'pedido',
                            filters: { deleted: false }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Erro ao buscar pedidos');
                    }
                    
                    const result = await response.json();
                    const eventos = result.events || [];
                    
                    let maiorSequencia = 0;
                    
                    eventos.forEach(evento => {
                        const numero = evento.payload.numero;
                        const match = numero.match(/^(\d{4})\/(\d{4})$/);
                        
                        if (match) {
                            const ano = parseInt(match[1]);
                            const sequencia = parseInt(match[2]);
                            
                            if (ano === anoAtual && sequencia > maiorSequencia) {
                                maiorSequencia = sequencia;
                            }
                        }
                    });
                    
                    const novaSequencia = maiorSequencia + 1;
                    const sequenciaFormatada = novaSequencia.toString().padStart(4, '0');
                    const numeroPedido = `${anoAtual}/${sequenciaFormatada}`;
                    
                    numeroPedidoInput.value = numeroPedido;
                    
                } catch (error) {
                    console.error('Erro ao gerar n√∫mero de pedido:', error);
                    const anoAtual = new Date().getFullYear();
                    numeroPedidoInput.value = `${anoAtual}/0001`;
                }
            }
            
            // ============================================
            // FUN√á√ïES DE PRODUTOS
            // ============================================
            
            function addProductRow(productData = null) {
                const row = document.createElement('tr');
                const index = productIndex++;
                
                row.innerHTML = `
                    <td>
                        <select class="product-select" data-bind="pedido.produtos.${index}.nome" required>
                            <option value="">Selecione um produto</option>
                            ${produtos.map(p => `<option value="${p}" ${productData && productData.nome === p ? 'selected' : ''}>${p}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="text" class="tamanho-input" data-bind="pedido.produtos.${index}.tamanho" 
                               placeholder="Ex: 30x40cm" value="${productData ? (productData.tamanho || '') : ''}">
                    </td>
                    <td>
                        <input type="number" class="quantidade-input" data-bind="pedido.produtos.${index}.quantidade" 
                               min="1" value="${productData ? (productData.quantidade || 1) : 1}" required>
                    </td>
                    <td>
                        <input type="number" class="valor-input" data-bind="pedido.produtos.${index}.valor" 
                               min="0" step="0.01" value="${productData ? (productData.valor || '0.00') : '0.00'}" required>
                    </td>
                    <td>
                        <textarea class="obs-input" data-bind="pedido.produtos.${index}.observacoes" 
                                  placeholder="Observa√ß√µes do produto..." rows="2">${productData ? (productData.observacoes || '') : ''}</textarea>
                    </td>
                    <td>
                        <button type="button" class="remove-btn" title="Remover produto">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                
                productsTableBody.appendChild(row);
                
                // Event listeners
                const removeBtn = row.querySelector('.remove-btn');
                const valorInput = row.querySelector('.valor-input');
                const quantidadeInput = row.querySelector('.quantidade-input');
                
                removeBtn.addEventListener('click', () => removeProductRow(row));
                valorInput.addEventListener('input', calculateTotals);
                quantidadeInput.addEventListener('input', calculateTotals);
                
                return row;
            }
            
            function removeProductRow(row) {
                const totalRows = productsTableBody.querySelectorAll('tr').length;
                if (totalRows <= 1) {
                    showMessage('O pedido deve ter pelo menos um produto.', 'warning');
                    return;
                }
                
                row.remove();
                reindexProducts();
                calculateTotals();
            }
            
            function reindexProducts() {
                const rows = productsTableBody.querySelectorAll('tr');
                productIndex = 0;
                
                rows.forEach((row, index) => {
                    const select = row.querySelector('.product-select');
                    const tamanho = row.querySelector('.tamanho-input');
                    const quantidade = row.querySelector('.quantidade-input');
                    const valor = row.querySelector('.valor-input');
                    const obs = row.querySelector('.obs-input');
                    
                    if (select) select.setAttribute('data-bind', `pedido.produtos.${index}.nome`);
                    if (tamanho) tamanho.setAttribute('data-bind', `pedido.produtos.${index}.tamanho`);
                    if (quantidade) quantidade.setAttribute('data-bind', `pedido.produtos.${index}.quantidade`);
                    if (valor) valor.setAttribute('data-bind', `pedido.produtos.${index}.valor`);
                    if (obs) obs.setAttribute('data-bind', `pedido.produtos.${index}.observacoes`);
                    
                    productIndex = index + 1;
                });
            }
            
            // ============================================
            // FUN√á√ïES DE PAGAMENTOS
            // ============================================
            
            function addPaymentRow(paymentData) {
                const row = document.createElement('tr');
                const index = paymentIndex++;
                
                // Determinar label do tipo
                let tipoLabel = '';
                switch(paymentData.tipo) {
                    case 'entrada': tipoLabel = 'Entrada'; break;
                    case 'parcela': tipoLabel = 'Parcela'; break;
                    case 'final': tipoLabel = 'Final'; break;
                    default: tipoLabel = paymentData.tipo;
                }
                
                // Determinar classe do status
                let statusClass = '';
                let statusLabel = '';
                switch(paymentData.status) {
                    case 'pago': 
                        statusClass = 'pago';
                        statusLabel = 'Pago';
                        break;
                    case 'pendente': 
                        statusClass = 'pendente';
                        statusLabel = 'Pendente';
                        break;
                    case 'atrasado': 
                        statusClass = 'atrasado';
                        statusLabel = 'Atrasado';
                        break;
                    default: 
                        statusClass = 'pendente';
                        statusLabel = 'Pendente';
                }
                
                // Gerar um ID √∫nico para o pagamento
                const paymentId = paymentData.id || `payment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                row.innerHTML = `
                    <td>
                        <span>${tipoLabel}</span>
                        <input type="hidden" class="payment-id-input" data-bind="pedido.pagamentos.${index}.id" value="${paymentId}">
                        <input type="hidden" class="payment-tipo-input" data-bind="pedido.pagamentos.${index}.tipo" value="${paymentData.tipo}">
                    </td>
                    <td>
                        <span>${formatarData(paymentData.data)}</span>
                        <input type="hidden" class="payment-data-input" data-bind="pedido.pagamentos.${index}.data" value="${paymentData.data}">
                    </td>
                    <td>
                        <span>${formatarMoeda(paymentData.valor)}</span>
                        <input type="hidden" class="payment-valor-input" data-bind="pedido.pagamentos.${index}.valor" value="${paymentData.valor}">
                    </td>
                    <td>
                        <span>${getFormaPagamentoLabel(paymentData.formaPagamento)}</span>
                        <input type="hidden" class="payment-forma-input" data-bind="pedido.pagamentos.${index}.formaPagamento" value="${paymentData.formaPagamento}">
                    </td>
                    <td>
                        <span title="${paymentData.observacoes || ''}">${(paymentData.observacoes || '').substring(0, 30)}${paymentData.observacoes && paymentData.observacoes.length > 30 ? '...' : ''}</span>
                        <input type="hidden" class="payment-obs-input" data-bind="pedido.pagamentos.${index}.observacoes" value="${paymentData.observacoes || ''}">
                        <input type="hidden" class="payment-ref-input" data-bind="pedido.pagamentos.${index}.referencia" value="${paymentData.referencia || ''}">
                    </td>
                    <td>
                        <span class="payment-status ${statusClass}">${statusLabel}</span>
                        <input type="hidden" class="payment-status-input" data-bind="pedido.pagamentos.${index}.status" value="${paymentData.status}">
                    </td>
                    <td>
                        <button type="button" class="remove-btn edit-payment-btn" title="Editar pagamento">
                            ‚úèÔ∏è
                        </button>
                        <button type="button" class="remove-btn" title="Remover pagamento">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
                
                paymentsTableBody.appendChild(row);
                
                // Event listeners
                const removeBtn = row.querySelectorAll('.remove-btn')[1];
                const editBtn = row.querySelector('.edit-payment-btn');
                
                removeBtn.addEventListener('click', () => removePaymentRow(row));
                editBtn.addEventListener('click', () => {
                    const paymentRowData = {
                        id: row.querySelector('.payment-id-input').value,
                        row: row,
                        tipo: row.querySelector('.payment-tipo-input').value,
                        data: row.querySelector('.payment-data-input').value,
                        valor: parseFloat(row.querySelector('.payment-valor-input').value),
                        formaPagamento: row.querySelector('.payment-forma-input').value,
                        status: row.querySelector('.payment-status-input').value,
                        observacoes: row.querySelector('.payment-obs-input').value,
                        referencia: row.querySelector('.payment-ref-input').value
                    };
                    openPaymentModal(paymentRowData);
                });
                
                return row;
            }
            
            function removePaymentRow(row) {
                const totalRows = paymentsTableBody.querySelectorAll('tr').length;
                if (totalRows <= 1) {
                    showMessage('O pedido deve ter pelo menos um pagamento.', 'warning');
                    return;
                }
                
                if (confirm('Tem certeza que deseja remover este pagamento?')) {
                    row.remove();
                    reindexPayments();
                    updatePaymentSummary();
                }
            }
            
            function reindexPayments() {
                const rows = paymentsTableBody.querySelectorAll('tr');
                paymentIndex = 0;
                
                rows.forEach((row, index) => {
                    const idInput = row.querySelector('.payment-id-input');
                    const tipoInput = row.querySelector('.payment-tipo-input');
                    const dataInput = row.querySelector('.payment-data-input');
                    const valorInput = row.querySelector('.payment-valor-input');
                    const formaInput = row.querySelector('.payment-forma-input');
                    const obsInput = row.querySelector('.payment-obs-input');
                    const refInput = row.querySelector('.payment-ref-input');
                    const statusInput = row.querySelector('.payment-status-input');
                    
                    if (idInput) idInput.setAttribute('data-bind', `pedido.pagamentos.${index}.id`);
                    if (tipoInput) tipoInput.setAttribute('data-bind', `pedido.pagamentos.${index}.tipo`);
                    if (dataInput) dataInput.setAttribute('data-bind', `pedido.pagamentos.${index}.data`);
                    if (valorInput) valorInput.setAttribute('data-bind', `pedido.pagamentos.${index}.valor`);
                    if (formaInput) formaInput.setAttribute('data-bind', `pedido.pagamentos.${index}.formaPagamento`);
                    if (obsInput) obsInput.setAttribute('data-bind', `pedido.pagamentos.${index}.observacoes`);
                    if (refInput) refInput.setAttribute('data-bind', `pedido.pagamentos.${index}.referencia`);
                    if (statusInput) statusInput.setAttribute('data-bind', `pedido.pagamentos.${index}.status`);
                    
                    paymentIndex = index + 1;
                });
            }
            
            function getFormaPagamentoLabel(valor) {
                const formas = {
                    'dinheiro': 'Dinheiro',
                    'mbway': 'MBWay',
                    'transferencia': 'Transfer√™ncia',
                    'cartao': 'Cart√£o',
                    'cheque': 'Cheque',
                    'outro': 'Outro'
                };
                return formas[valor] || valor;
            }
            
            function updatePaymentSummary() {
                const totalPedido = parseFloat(pedidoTotalInput.value) || 0;
                let totalPago = 0;
                
                // Calcular total pago
                document.querySelectorAll('.payment-valor-input').forEach(input => {
                    const valor = parseFloat(input.value) || 0;
                    totalPago += valor;
                });
                
                const saldoPendente = totalPedido - totalPago;
                
                // Atualizar displays
                resumoTotalEl.textContent = formatarMoeda(totalPedido);
                resumoPagoEl.textContent = formatarMoeda(totalPago);
                resumoPendenteEl.textContent = formatarMoeda(saldoPendente);
                
                // Atualizar cores
                if (saldoPendente > 0) {
                    resumoPendenteEl.style.color = '#dc2626';
                } else if (saldoPendente < 0) {
                    resumoPendenteEl.style.color = '#f59e0b';
                } else {
                    resumoPendenteEl.style.color = '#059669';
                }
                
                // Atualizar campos ocultos
                pedidoTotalPagoInput.value = totalPago.toFixed(2);
                pedidoSaldoPendenteInput.value = saldoPendente.toFixed(2);
                
                // Atualizar status do pagamento
                if (totalPago === 0) {
                    pedidoStatusPagamentoInput.value = 'pendente';
                } else if (totalPago > 0 && totalPago < totalPedido) {
                    pedidoStatusPagamentoInput.value = 'parcial';
                } else if (totalPago >= totalPedido) {
                    pedidoStatusPagamentoInput.value = 'pago';
                }
            }
            
            // ============================================
            // FUN√á√ïES COMPARTILHADAS
            // ============================================
            
            function calculateTotals() {
                let subtotalProdutos = 0;
                
                // Calcular subtotal dos produtos
                document.querySelectorAll('#productsTableBody tr').forEach(row => {
                    const valorInput = row.querySelector('.valor-input');
                    const quantidadeInput = row.querySelector('.quantidade-input');
                    
                    const valor = parseFloat(valorInput.value) || 0;
                    const quantidade = parseInt(quantidadeInput.value) || 0;
                    
                    subtotalProdutos += valor * quantidade;
                });
                
                // Calcular valor de instala√ß√£o
                const instalacao = parseFloat(valorInstalacaoInput.value) || 0;
                
                // Calcular subtotal geral
                const subtotalGeral = subtotalProdutos + instalacao;
                
                // Calcular IVA
                const ivaSimRadio = document.getElementById('ivaSim');
                let iva = 0;
                if (ivaSimRadio.checked) {
                    iva = subtotalGeral * 0.23;
                }
                
                // Calcular total final
                const totalFinal = subtotalGeral + iva;
                
                // Atualizar exibi√ß√£o
                subtotalProdutosEl.textContent = formatarMoeda(subtotalProdutos);
                totalInstalacaoEl.textContent = formatarMoeda(instalacao);
                valorIVAEl.textContent = formatarMoeda(iva);
                totalFinalEl.textContent = formatarMoeda(totalFinal);
                
                // Atualizar campos ocultos
                pedidoSubtotalInput.value = subtotalGeral;
                pedidoIVAInput.value = iva;
                pedidoTotalInput.value = totalFinal;
                
                // Atualizar resumo de pagamentos
                updatePaymentSummary();
            }
            
            function formatarMoeda(value) {
                return new Intl.NumberFormat('pt-PT', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            }
            
            function formatarData(dataString) {
                if (!dataString) return '';
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-PT');
            }
            
            function showMessage(message, type = 'info') {
                // Remover mensagens anteriores
                const existingMessages = document.querySelectorAll('.success-message');
                existingMessages.forEach(msg => msg.remove());
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'success-message';
                messageDiv.textContent = message;
                
                if (type === 'warning') {
                    messageDiv.style.backgroundColor = '#f59e0b';
                } else if (type === 'error') {
                    messageDiv.style.backgroundColor = '#ef4444';
                } else if (type === 'success') {
                    messageDiv.style.backgroundColor = '#10b981';
                }
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            }
            
            function validateForm() {
                // Verificar campos obrigat√≥rios
                const requiredFields = ['cliente', 'empresa', 'nif', 'morada', 'telemovel', 'numero', 'dataEntrega', 'atendente'];
                for (const fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        showMessage(`O campo "${field.previousElementSibling.textContent.replace(' *', '')}" √© obrigat√≥rio.`, 'warning');
                        field.focus();
                        return false;
                    }
                }
                
                // Verificar se h√° produtos
                const productRows = productsTableBody.querySelectorAll('tr');
                if (productRows.length === 0) {
                    showMessage('Adicione pelo menos um produto ao pedido.', 'warning');
                    return false;
                }
                
                // Verificar produtos
                const productSelects = document.querySelectorAll('.product-select');
                for (const select of productSelects) {
                    if (!select.value) {
                        showMessage('Selecione um produto para todos os itens.', 'warning');
                        select.focus();
                        return false;
                    }
                }
                
                // Verificar valores dos produtos
                const valorInputs = document.querySelectorAll('.valor-input');
                for (const input of valorInputs) {
                    const valor = parseFloat(input.value);
                    if (isNaN(valor) || valor < 0) {
                        showMessage('Insira um valor v√°lido para todos os produtos.', 'warning');
                        input.focus();
                        return false;
                    }
                }
                
                // Verificar pagamentos
                const paymentRows = paymentsTableBody.querySelectorAll('tr');
                if (paymentRows.length === 0) {
                    showMessage('Adicione pelo menos um pagamento.', 'warning');
                    document.getElementById('addPaymentBtn').focus();
                    return false;
                }
                
                return true;
            }
            
            // ============================================
            // MODAL DE PAGAMENTOS
            // ============================================
            
            const paymentModal = document.getElementById('paymentModal');
            const paymentForm = document.getElementById('paymentForm');
            const paymentIdInput = document.getElementById('paymentId');
            const paymentTypeInput = document.getElementById('paymentType');
            const paymentDateInput = document.getElementById('paymentDate');
            const paymentAmountInput = document.getElementById('paymentAmount');
            const paymentMethodInput = document.getElementById('paymentMethod');
            const paymentStatusInput = document.getElementById('paymentStatus');
            const paymentObservationsInput = document.getElementById('paymentObservations');
            const paymentReferenceInput = document.getElementById('paymentReference');
            
            let isPaymentEditMode = false;
            let currentPaymentRow = null;
            
            function openPaymentModal(paymentData = null) {
                // Resetar formul√°rio
                paymentForm.reset();
                
                // Data padr√£o para hoje
                const hoje = new Date().toISOString().split('T')[0];
                paymentDateInput.value = hoje;
                
                if (paymentData) {
                    // Modo edi√ß√£o
                    isPaymentEditMode = true;
                    currentPaymentRow = paymentData.row;
                    paymentIdInput.value = paymentData.id || '';
                    paymentTypeInput.value = paymentData.tipo || 'entrada';
                    paymentDateInput.value = paymentData.data || hoje;
                    paymentAmountInput.value = paymentData.valor || '0.00';
                    paymentMethodInput.value = paymentData.formaPagamento || '';
                    paymentStatusInput.value = paymentData.status || 'pago';
                    paymentObservationsInput.value = paymentData.observacoes || '';
                    paymentReferenceInput.value = paymentData.referencia || '';
                    
                    document.getElementById('savePaymentBtn').textContent = 'ATUALIZAR PAGAMENTO';
                } else {
                    // Modo cria√ß√£o
                    isPaymentEditMode = false;
                    currentPaymentRow = null;
                    paymentIdInput.value = '';
                    document.getElementById('savePaymentBtn').textContent = 'SALVAR PAGAMENTO';
                }
                
                // Mostrar modal
                paymentModal.style.display = 'flex';
                paymentAmountInput.focus();
            }
            
            function closePaymentModal() {
                paymentModal.style.display = 'none';
                isPaymentEditMode = false;
                currentPaymentRow = null;
                paymentForm.reset();
            }
            
            // ============================================
            // EVENT LISTENERS
            // ============================================
            
            // Adicionar produto
            document.getElementById('addProductBtn').addEventListener('click', () => {
                addProductRow();
                calculateTotals();
            });
            
            // Adicionar pagamento
            document.getElementById('addPaymentBtn').addEventListener('click', () => {
                openPaymentModal();
            });
            
            // Cancelar pedido
            document.getElementById('cancelBtn').addEventListener('click', () => {
                if (confirm(isEditMode ? 'Tem certeza que deseja cancelar a edi√ß√£o?' : 'Tem certeza que deseja cancelar este pedido?')) {
                    if (isEditMode) {
                        window.location.href = 'pedidos.html';
                    } else {
                        // Limpar formul√°rio
                        document.getElementById('pedidoForm').reset();
                        productsTableBody.innerHTML = '';
                        paymentsTableBody.innerHTML = '';
                        productIndex = 0;
                        paymentIndex = 0;
                        pedidoIdInput.value = '';
                        
                        setupNewPedido();
                        showMessage('Formul√°rio limpo. Pronto para novo pedido.', 'info');
                    }
                }
            });
            
            // Salvar pagamento
            document.getElementById('savePaymentBtn').addEventListener('click', () => {
                // Validar
                if (!paymentDateInput.value) {
                    showMessage('A data do pagamento √© obrigat√≥ria.', 'warning');
                    paymentDateInput.focus();
                    return;
                }
                
                if (!paymentAmountInput.value || parseFloat(paymentAmountInput.value) <= 0) {
                    showMessage('O valor do pagamento deve ser maior que zero.', 'warning');
                    paymentAmountInput.focus();
                    return;
                }
                
                if (!paymentMethodInput.value) {
                    showMessage('A forma de pagamento √© obrigat√≥ria.', 'warning');
                    paymentMethodInput.focus();
                    return;
                }
                
                // Criar objeto do pagamento
                const paymentData = {
                    tipo: paymentTypeInput.value,
                    data: paymentDateInput.value,
                    valor: parseFloat(paymentAmountInput.value),
                    formaPagamento: paymentMethodInput.value,
                    status: paymentStatusInput.value,
                    observacoes: paymentObservationsInput.value,
                    referencia: paymentReferenceInput.value
                };
                
                if (isPaymentEditMode && currentPaymentRow) {
                    // Atualizar linha existente
                    const row = currentPaymentRow;
                    const paymentId = paymentIdInput.value || row.querySelector('.payment-id-input').value;
                    
                    paymentData.id = paymentId;
                    row.querySelector('.payment-tipo-input').value = paymentData.tipo;
                    row.querySelector('.payment-data-input').value = paymentData.data;
                    row.querySelector('.payment-valor-input').value = paymentData.valor;
                    row.querySelector('.payment-forma-input').value = paymentData.formaPagamento;
                    row.querySelector('.payment-status-input').value = paymentData.status;
                    row.querySelector('.payment-obs-input').value = paymentData.observacoes;
                    row.querySelector('.payment-ref-input').value = paymentData.referencia;
                    
                    // Atualizar exibi√ß√£o
                    let tipoLabel = '';
                    switch(paymentData.tipo) {
                        case 'entrada': tipoLabel = 'Entrada'; break;
                        case 'parcela': tipoLabel = 'Parcela'; break;
                        case 'final': tipoLabel = 'Final'; break;
                        default: tipoLabel = paymentData.tipo;
                    }
                    
                    let statusClass = '';
                    let statusLabel = '';
                    switch(paymentData.status) {
                        case 'pago': 
                            statusClass = 'pago';
                            statusLabel = 'Pago';
                            break;
                        case 'pendente': 
                            statusClass = 'pendente';
                            statusLabel = 'Pendente';
                            break;
                        case 'atrasado': 
                            statusClass = 'atrasado';
                            statusLabel = 'Atrasado';
                            break;
                    }
                    
                    row.cells[0].querySelector('span').textContent = tipoLabel;
                    row.cells[1].querySelector('span').textContent = formatarData(paymentData.data);
                    row.cells[2].querySelector('span').textContent = formatarMoeda(paymentData.valor);
                    row.cells[3].querySelector('span').textContent = getFormaPagamentoLabel(paymentData.formaPagamento);
                    row.cells[4].querySelector('span').textContent = (paymentData.observacoes || '').substring(0, 30) + (paymentData.observacoes && paymentData.observacoes.length > 30 ? '...' : '');
                    row.cells[4].querySelector('span').title = paymentData.observacoes || '';
                    row.cells[5].querySelector('span').className = `payment-status ${statusClass}`;
                    row.cells[5].querySelector('span').textContent = statusLabel;
                    
                    showMessage('Pagamento atualizado com sucesso!', 'success');
                } else {
                    // Adicionar nova linha
                    addPaymentRow(paymentData);
                    showMessage('Pagamento adicionado com sucesso!', 'success');
                }
                
                // Atualizar resumo e fechar modal
                updatePaymentSummary();
                closePaymentModal();
            });
            
            // Fechar modal
            document.getElementById('closePaymentModal').addEventListener('click', closePaymentModal);
            document.getElementById('cancelPaymentBtn').addEventListener('click', closePaymentModal);
            
            // Listeners para c√°lculo autom√°tico
            document.getElementById('ivaSim').addEventListener('change', calculateTotals);
            document.getElementById('ivaNao').addEventListener('change', calculateTotals);
            valorInstalacaoInput.addEventListener('input', calculateTotals);
            
            // Configurar listener para evento do engine.js
            document.addEventListener('coreCommitSuccess', (event) => {
                const detail = event.detail || {};
                
                if (detail.schema === 'pedido') {
                    const saveBtn = document.getElementById('saveBtn');
                    saveBtn.classList.remove('saving');
                    
                    if (detail.isUpdate) {
                        saveBtn.textContent = '‚úì ATUALIZADO!';
                        showMessage('Pedido atualizado com sucesso!', 'success');
                    } else {
                        saveBtn.textContent = '‚úì SALVO!';
                        showMessage('Pedido criado com sucesso!', 'success');
                        
                        // Se for cria√ß√£o, armazenar o ID gerado
                        if (detail.documentId && pedidoIdInput) {
                            pedidoIdInput.value = detail.documentId;
                            isEditMode = true;
                            saveBtn.textContent = 'ATUALIZAR PEDIDO';
                        }
                    }
                    
                    // Redirecionar ap√≥s 2 segundos se for cria√ß√£o
                    setTimeout(() => {
                        if (!detail.isUpdate) {
                            if (confirm('Pedido salvo com sucesso! Deseja criar um novo pedido?')) {
                                // Limpar e criar novo
                                document.getElementById('pedidoForm').reset();
                                productsTableBody.innerHTML = '';
                                paymentsTableBody.innerHTML = '';
                                productIndex = 0;
                                paymentIndex = 0;
                                pedidoIdInput.value = '';
                                isEditMode = false;
                                saveBtn.textContent = 'SALVAR PEDIDO';
                                
                                setupNewPedido();
                            } else {
                                window.location.href = 'pedidos.html';
                            }
                        }
                    }, 2000);
                }
            });
            
            document.addEventListener('coreCommitError', (event) => {
                console.error('Erro no commit:', event.detail);
                const saveBtn = document.getElementById('saveBtn');
                saveBtn.classList.remove('saving');
                saveBtn.textContent = isEditMode ? 'ATUALIZAR PEDIDO' : 'SALVAR PEDIDO';
                saveBtn.disabled = false;
                
                showMessage('Erro ao salvar pedido. Tente novamente.', 'error');
            });
        });
    </script>
    
    <!-- CONEX√ÉO COM O CORE ENGINE -->
    <script src="../core/engine.js"></script>
</body>
</html>