<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>PrintPixel - Gestor Financeiro Predict</title>
    
    <!-- BIBLIOTECAS EXTERNAS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================
           VARI√ÅVEIS E RESET
           ============================================ */
        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --hover-bg: #f1f5f9;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            padding: 20px;
        }

        /* ============================================
           HEADER PROFISSIONAL
           ============================================ */
        .page-header {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            padding: 24px 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            margin-bottom: 24px;
            color: white;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.3px;
            margin-bottom: 4px;
            opacity: 0.95;
        }

        .header-title p {
            font-size: 14px;
            opacity: 0.7;
        }

        .header-balance {
            background: rgba(255, 255, 255, 0.1);
            padding: 16px 28px;
            border-radius: 100px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .balance-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .balance-value {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
        }

        .balance-value.positive {
            color: #4ade80;
        }

        .balance-value.negative {
            color: #f87171;
        }

        .last-update {
            background: rgba(255, 255, 255, 0.08);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ============================================
           BALAN√áO PRINCIPAL
           ============================================ */
        .balance-section {
            margin-bottom: 24px;
        }

        .balance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .balance-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .balance-card.receita {
            background: linear-gradient(135deg, #1e3a8a, #2563eb);
            color: white;
        }

        .balance-card.despesa {
            background: linear-gradient(135deg, #78350f, #b45309);
            color: white;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-header h3 {
            font-size: 16px;
            font-weight: 500;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-header i {
            font-size: 24px;
            opacity: 0.8;
        }

        .card-value {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1;
        }

        .card-sub {
            display: flex;
            gap: 16px;
            font-size: 14px;
            opacity: 0.8;
        }

        .card-sub span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ============================================
           META DE FATURAMENTO
           ============================================ */
        .target-section {
            margin-bottom: 24px;
        }

        .target-card {
            background: linear-gradient(135deg, #059669, #10b981);
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-lg);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .target-card::before {
            content: 'üéØ';
            position: absolute;
            right: 20px;
            bottom: 20px;
            font-size: 80px;
            opacity: 0.1;
        }

        .target-label {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .target-value {
            font-size: 56px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 8px;
        }

        .target-sub {
            font-size: 16px;
            opacity: 0.9;
        }

        .target-progress {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .target-progress-bar {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* ============================================
           COMPARATIVO POR CATEGORIA
           ============================================ */
        .comparison-section {
            margin-bottom: 24px;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .comparison-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .category-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: transform 0.2s;
        }

        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid;
        }

        .category-header.agua { border-bottom-color: #3b82f6; }
        .category-header.luz { border-bottom-color: #f59e0b; }
        .category-header.aluguel { border-bottom-color: #8b5cf6; }
        .category-header.telefone { border-bottom-color: #10b981; }
        .category-header.combustivel { border-bottom-color: #ef4444; }
        .category-header.outros { border-bottom-color: #64748b; }

        .category-name {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .category-icon.agua { background: #dbeafe; color: #1e40af; }
        .category-icon.luz { background: #fef3c7; color: #92400e; }
        .category-icon.aluguel { background: #ede9fe; color: #6d28d9; }
        .category-icon.telefone { background: #d1fae5; color: #065f46; }
        .category-icon.combustivel { background: #fee2e2; color: #991b1b; }
        .category-icon.outros { background: #f1f5f9; color: #334155; }

        .category-values {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .prev-month {
            text-align: left;
        }

        .prev-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .prev-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .current-month {
            text-align: right;
        }

        .current-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .current-value {
            font-size: 16px;
            font-weight: 600;
        }

        .current-value.paid {
            color: var(--success-color);
        }

        .current-value.pending {
            color: var(--warning-color);
        }

        .category-progress {
            margin: 12px 0;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--success-color);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .category-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            padding-top: 12px;
            border-top: 1px dashed var(--border-color);
        }

        .remaining {
            font-weight: 600;
        }

        .remaining.positive {
            color: var(--success-color);
        }

        .remaining.negative {
            color: var(--danger-color);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.ok {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.urgent {
            background: #fee2e2;
            color: #991b1b;
        }

        /* ============================================
           LISTAS PROFISSIONAIS
           ============================================ */
        .lists-section {
            margin-bottom: 24px;
        }

        .lists-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .lists-grid {
                grid-template-columns: 1fr;
            }
        }

        .list-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .list-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-header.receita {
            background: linear-gradient(135deg, #1e3a8a15, #2563eb15);
        }

        .list-header.despesa {
            background: linear-gradient(135deg, #78350f15, #b4530915);
        }

        .list-header h3 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .list-header.receita h3 {
            color: #1e3a8a;
        }

        .list-header.despesa h3 {
            color: #b45309;
        }

        .list-total {
            font-size: 20px;
            font-weight: 700;
        }

        .list-total.receita {
            color: #2563eb;
        }

        .list-total.despesa {
            color: #b45309;
        }

        .list-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--light-bg);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .list-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .list-item.atrasado {
            border-left: 4px solid var(--danger-color);
            background: #fee2e2;
        }

        .list-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .list-item.receita .list-icon {
            background: #dbeafe;
            color: #1e3a8a;
        }

        .list-item.despesa .list-icon {
            background: #fef3c7;
            color: #b45309;
        }

        .list-content {
            flex: 1;
            min-width: 0;
        }

        .list-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .list-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .list-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .list-value {
            font-weight: 700;
            font-size: 16px;
            white-space: nowrap;
        }

        .list-value.receita {
            color: #2563eb;
        }

        .list-value.despesa {
            color: #b45309;
        }

        .list-value.atrasado {
            color: var(--danger-color);
        }

        .badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 20px;
            font-weight: 600;
        }

        .badge.atrasado {
            background: #fee2e2;
            color: var(--danger-color);
        }

        /* ============================================
           LOADING
           ============================================ */
        .loading-container {
            text-align: center;
            padding: 80px;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body data-page-id="gestor-financeiro-predict" data-page-type="READ">

    <!-- ============================================
         HEADER PROFISSIONAL
         ============================================ -->
    <header class="page-header">
        <div class="header-content">
            <div class="header-title">
                <h1>Gestor Financeiro Predict</h1>
                <p>An√°lise preditiva ‚Ä¢ Comparativo m√™s a m√™s ‚Ä¢ Intelig√™ncia de despesas fixas</p>
            </div>
            
            <div class="header-balance" id="headerBalance">
                <div class="balance-label">BALAN√áO PATRIMONIAL</div>
                <div class="balance-value" id="balanceValue">‚Ç¨ 0</div>
            </div>
            
            <div class="last-update" id="lastUpdate">
                <i class="fas fa-sync-alt"></i>
                <span>Carregando...</span>
            </div>
        </div>
    </header>

    <!-- LOADING STATE -->
    <div id="loadingState" class="loading-container">
        <div class="loading-spinner"></div>
        <h3 style="margin-bottom: 8px;">Processando dados preditivos</h3>
        <p style="color: var(--text-secondary);">Analisando despesas do m√™s anterior e calculando proje√ß√µes</p>
    </div>

    <!-- CONTE√öDO PRINCIPAL -->
    <div id="mainContent" style="display: none;">
        
        <!-- BALAN√áO PRINCIPAL -->
        <section class="balance-section">
            <div class="balance-grid">
                <div class="balance-card receita">
                    <div class="card-header">
                        <h3><i class="fas fa-arrow-down"></i> A RECEBER</h3>
                        <i class="fas fa-arrow-circle-down"></i>
                    </div>
                    <div class="card-value" id="totalReceber">‚Ç¨ 0</div>
                    <div class="card-sub">
                        <span><i class="fas fa-clock"></i> <span id="qtdReceber">0</span> pendentes</span>
                        <span><i class="fas fa-exclamation-triangle"></i> <span id="receberAtrasado">‚Ç¨ 0</span> atrasado</span>
                    </div>
                </div>
                
                <div class="balance-card despesa">
                    <div class="card-header">
                        <h3><i class="fas fa-arrow-up"></i> A PAGAR</h3>
                        <i class="fas fa-arrow-circle-up"></i>
                    </div>
                    <div class="card-value" id="totalPagar">‚Ç¨ 0</div>
                    <div class="card-sub">
                        <span><i class="fas fa-clock"></i> <span id="qtdPagar">0</span> pendentes</span>
                        <span><i class="fas fa-exclamation-triangle"></i> <span id="pagarAtrasado">‚Ç¨ 0</span> atrasado</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- META DE FATURAMENTO BASEADA NO M√äS ANTERIOR -->
        <section class="target-section">
            <div class="target-card" id="targetCard">
                <div class="target-label">üéØ META DE FATURAMENTO DO M√äS</div>
                <div class="target-value" id="targetValue">‚Ç¨ 0</div>
                <div class="target-sub" id="targetSub">Baseado nas despesas do m√™s anterior</div>
                <div class="target-progress">
                    <div class="target-progress-bar" id="targetProgress" style="width: 0%;"></div>
                </div>
                <div style="margin-top: 12px; font-size: 14px; opacity: 0.9;" id="targetDetail"></div>
            </div>
        </section>

        <!-- COMPARATIVO POR CATEGORIA (M√äS ANTERIOR VS ATUAL) -->
        <section class="comparison-section">
            <div class="comparison-header">
                <h2><i class="fas fa-chart-bar" style="margin-right: 8px; color: var(--primary-color);"></i> Comparativo de Despesas Fixas por Categoria</h2>
                <span style="font-size: 13px; color: var(--text-secondary);">M√™s anterior vs M√™s atual</span>
            </div>
            
            <div class="comparison-grid" id="categoryComparison">
                <!-- Preenchido via JS -->
            </div>
        </section>

        <!-- LISTAS COMPLETAS -->
        <section class="lists-section">
            <div class="lists-grid">
                <!-- A RECEBER -->
                <div class="list-card">
                    <div class="list-header receita">
                        <h3><i class="fas fa-arrow-down"></i> A RECEBER ‚Ä¢ Pendentes</h3>
                        <span class="list-total receita" id="totalReceberLista">‚Ç¨ 0</span>
                    </div>
                    <div class="list-container" id="listaReceber">
                        <!-- Preenchido via JS -->
                    </div>
                </div>

                <!-- A PAGAR -->
                <div class="list-card">
                    <div class="list-header despesa">
                        <h3><i class="fas fa-arrow-up"></i> A PAGAR ‚Ä¢ Pendentes</h3>
                        <span class="list-total despesa" id="totalPagarLista">‚Ç¨ 0</span>
                    </div>
                    <div class="list-container" id="listaPagar">
                        <!-- Preenchido via JS -->
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        // ============================================
        // GESTOR FINANCEIRO PREDICT
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä Gestor Financeiro Predict iniciado');
            
            // Elementos do DOM
            const loadingState = document.getElementById('loadingState');
            const mainContent = document.getElementById('mainContent');
            const lastUpdateSpan = document.getElementById('lastUpdate').querySelector('span');
            
            // Estado da aplica√ß√£o
            let todosPedidos = [];
            let todasDespesas = [];
            let despesasMesAnterior = {};
            let despesasMesAtual = {};
            
            // ============================================
            // CARREGAR DADOS
            // ============================================
            
            async function carregarDados() {
                try {
                    console.log('üîÑ Carregando dados...');
                    
                    const responsePedidos = await fetch('/api/database/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ schema: 'pedido', filters: {} })
                    });
                    
                    const responseDespesas = await fetch('/api/database/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ schema: 'despesa', filters: {} })
                    });
                    
                    if (!responsePedidos.ok || !responseDespesas.ok) {
                        throw new Error('Erro ao carregar dados');
                    }
                    
                    const resultPedidos = await responsePedidos.json();
                    const resultDespesas = await responseDespesas.json();
                    
                    processarPedidos(resultPedidos.events || []);
                    processarDespesas(resultDespesas.events || []);
                    
                    // An√°lise preditiva
                    analisarDespesasPorMes();
                    
                    renderizarPainel();
                    
                    loadingState.style.display = 'none';
                    mainContent.style.display = 'block';
                    
                    const dataAtualizacao = new Date();
                    lastUpdateSpan.textContent = `${dataAtualizacao.toLocaleDateString('pt-PT')} ‚Ä¢ ${dataAtualizacao.toLocaleTimeString('pt-PT')}`;
                    
                } catch (error) {
                    console.error('‚ùå Erro:', error);
                    loadingState.innerHTML = `
                        <div style="color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px;"></i>
                            <h3>Erro ao carregar</h3>
                            <p>${error.message}</p>
                            <button onclick="location.reload()" style="margin-top: 16px; padding: 12px 24px; background: var(--primary-color); color: white; border: none; border-radius: 8px;">
                                <i class="fas fa-redo"></i> Tentar novamente
                            </button>
                        </div>
                    `;
                }
            }
            
            // ============================================
            // PROCESSADORES
            // ============================================
            
            function processarPedidos(events) {
                const pedidosMap = new Map();
                events
                    .filter(e => e.schema === 'pedido' && !e.deleted)
                    .forEach(e => {
                        const id = e.id;
                        if (pedidosMap.has(id)) {
                            const existing = pedidosMap.get(id);
                            const existingTime = new Date(existing.timestamp || 0).getTime();
                            const newTime = new Date(e.timestamp || 0).getTime();
                            if (newTime > existingTime) pedidosMap.set(id, e);
                        } else {
                            pedidosMap.set(id, e);
                        }
                    });
                
                todosPedidos = Array.from(pedidosMap.values()).map(event => {
                    let payload = event.payload;
                    if (typeof payload === 'string') {
                        try { payload = JSON.parse(payload); } 
                        catch (e) { payload = {}; }
                    }
                    
                    const pagamentos = Array.isArray(payload.pagamentos) ? payload.pagamentos : [];
                    const totalPago = pagamentos
                        .filter(p => p.status === 'pago')
                        .reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0);
                    
                    const totalPedido = parseFloat(payload.total) || 0;
                    const saldoPendente = totalPedido - totalPago;
                    
                    let statusPagamento = 'pendente';
                    if (totalPago === 0) statusPagamento = 'pendente';
                    else if (totalPago > 0 && totalPago < totalPedido) statusPagamento = 'parcial';
                    else if (totalPago >= totalPedido) statusPagamento = 'pago';
                    
                    let dataVencimento = null;
                    if (payload.dataEntrega) {
                        dataVencimento = new Date(payload.dataEntrega);
                        dataVencimento.setHours(0,0,0,0);
                    }
                    
                    return {
                        id: event.id,
                        nome: payload.cliente || 'Cliente',
                        descricao: payload.empresa || `Pedido ${payload.numero || ''}`,
                        valor: saldoPendente,
                        valorTotal: totalPedido,
                        status: statusPagamento,
                        dataVencimento: dataVencimento,
                        createdAt: event.timestamp || event.created_at
                    };
                }).filter(p => p.valor > 0);
            }
            
            function processarDespesas(events) {
                const despesasMap = new Map();
                events
                    .filter(e => e.schema === 'despesa')
                    .forEach(e => {
                        const id = e.id;
                        if (despesasMap.has(id)) {
                            const existing = despesasMap.get(id);
                            const existingTime = new Date(existing.timestamp || 0).getTime();
                            const newTime = new Date(e.timestamp || 0).getTime();
                            if (newTime > existingTime) despesasMap.set(id, e);
                        } else {
                            despesasMap.set(id, e);
                        }
                    });
                
                todasDespesas = Array.from(despesasMap.values()).map(event => {
                    let payload = event.payload;
                    if (typeof payload === 'string') {
                        try { payload = JSON.parse(payload); } 
                        catch (e) { payload = {}; }
                    }
                    
                    const valorBruto = parseFloat(payload.valorBruto) || 0;
                    const comIVA = payload.comIVA === 'sim';
                    const valorIVA = comIVA ? valorBruto * 0.23 : 0;
                    const valorTotal = valorBruto + valorIVA;
                    
                    let dataDespesa = null;
                    if (payload.data) {
                        dataDespesa = new Date(payload.data);
                        dataDespesa.setHours(0,0,0,0);
                    }
                    
                    let dataVencimento = null;
                    if (payload.dataVencimento) {
                        dataVencimento = new Date(payload.dataVencimento);
                        dataVencimento.setHours(0,0,0,0);
                    }
                    
                    return {
                        id: event.id,
                        nome: payload.fornecedor || 'Fornecedor',
                        descricao: payload.descricao || payload.categoria || 'Despesa',
                        valor: valorTotal,
                        status: payload.statusPagamento || 'pendente',
                        categoria: payload.categoria || 'OUTROS',
                        data: dataDespesa,
                        dataVencimento: dataVencimento,
                        dataPagamento: payload.dataPagamento,
                        createdAt: event.timestamp || event.created_at,
                        deleted: event.deleted || false
                    };
                });
            }
            
            // ============================================
            // AN√ÅLISE PREDITIVA (M√äS ANTERIOR VS ATUAL)
            // ============================================
            
            function analisarDespesasPorMes() {
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                // M√™s anterior
                let mesAnterior = mesAtual - 1;
                let anoAnterior = anoAtual;
                if (mesAnterior < 0) {
                    mesAnterior = 11;
                    anoAnterior = anoAtual - 1;
                }
                
                // Inicializar objetos de categorias
                const categorias = [
                    '√ÅGUA', 'LUZ', 'ALUGUEL', 'TELEFONE', 'WHATSAPP', 
                    'COMBUSTIVEL', 'CAF√â', 'ESCRITORIO', 'COMUNICA√á√ÉO', 
                    'FINAN√áAS', 'INTERNET', 'SAL√ÅRIOS', 'OUTROS'
                ];
                
                despesasMesAnterior = {};
                despesasMesAtual = {};
                
                categorias.forEach(cat => {
                    despesasMesAnterior[cat] = {
                        total: 0,
                        pagas: 0,
                        pendentes: 0
                    };
                    despesasMesAtual[cat] = {
                        total: 0,
                        pagas: 0,
                        pendentes: 0
                    };
                });
                
                // Processar cada despesa
                todasDespesas.forEach(d => {
                    if (!d.data) return;
                    
                    const dataDespesa = new Date(d.data);
                    const mes = dataDespesa.getMonth();
                    const ano = dataDespesa.getFullYear();
                    
                    const categoria = d.categoria || 'OUTROS';
                    
                    // M√™s anterior
                    if (mes === mesAnterior && ano === anoAnterior) {
                        despesasMesAnterior[categoria].total += d.valor;
                        if (d.status === 'paga') {
                            despesasMesAnterior[categoria].pagas += d.valor;
                        } else {
                            despesasMesAnterior[categoria].pendentes += d.valor;
                        }
                    }
                    
                    // M√™s atual
                    if (mes === mesAtual && ano === anoAtual) {
                        despesasMesAtual[categoria].total += d.valor;
                        if (d.status === 'paga') {
                            despesasMesAtual[categoria].pagas += d.valor;
                        } else {
                            despesasMesAtual[categoria].pendentes += d.valor;
                        }
                    }
                });
                
                console.log('üìä Despesas m√™s anterior:', despesasMesAnterior);
                console.log('üìä Despesas m√™s atual:', despesasMesAtual);
            }
            
            // ============================================
            // RENDERIZA√á√ÉO
            // ============================================
            
            function renderizarPainel() {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                // Filtrar dados
                const aReceber = todosPedidos.filter(p => 
                    p.status === 'pendente' || p.status === 'parcial'
                );
                
                const aPagar = todasDespesas.filter(d => 
                    d.status === 'pendente' && !d.deleted
                );
                
                // Atrasados
                const aReceberAtrasado = aReceber.filter(p => {
                    if (!p.dataVencimento) return false;
                    return p.dataVencimento < hoje;
                });
                
                const aPagarAtrasado = aPagar.filter(d => {
                    if (!d.dataVencimento) return false;
                    return d.dataVencimento < hoje;
                });
                
                // Totais
                const totalReceber = aReceber.reduce((sum, p) => sum + p.valor, 0);
                const totalPagar = aPagar.reduce((sum, d) => sum + d.valor, 0);
                const totalReceberAtrasado = aReceberAtrasado.reduce((sum, p) => sum + p.valor, 0);
                const totalPagarAtrasado = aPagarAtrasado.reduce((sum, d) => sum + d.valor, 0);
                
                // BALAN√áO PATRIMONIAL
                const balanco = totalReceber - totalPagar;
                const balanceElement = document.getElementById('balanceValue');
                balanceElement.textContent = formatarMoeda(balanco);
                balanceElement.className = `balance-value ${balanco >= 0 ? 'positive' : 'negative'}`;
                
                // CARDS DE BALAN√áO
                document.getElementById('totalReceber').textContent = formatarMoeda(totalReceber);
                document.getElementById('qtdReceber').textContent = aReceber.length;
                document.getElementById('receberAtrasado').textContent = formatarMoeda(totalReceberAtrasado);
                
                document.getElementById('totalPagar').textContent = formatarMoeda(totalPagar);
                document.getElementById('qtdPagar').textContent = aPagar.length;
                document.getElementById('pagarAtrasado').textContent = formatarMoeda(totalPagarAtrasado);
                
                // ============================================
                // META DE FATURAMENTO BASEADA NO M√äS ANTERIOR
                // ============================================
                
                // Calcular total de despesas do m√™s anterior (pagas)
                let totalDespesasMesAnterior = 0;
                Object.values(despesasMesAnterior).forEach(cat => {
                    totalDespesasMesAnterior += cat.pagas; // S√≥ considerar pagas para base real
                });
                
                // Calcular total de despesas do m√™s atual (pagas at√© agora)
                let totalDespesasMesAtualPagas = 0;
                let totalDespesasMesAtualPendentes = 0;
                Object.values(despesasMesAtual).forEach(cat => {
                    totalDespesasMesAtualPagas += cat.pagas;
                    totalDespesasMesAtualPendentes += cat.pendentes;
                });
                
                // Meta: igual ao total do m√™s anterior (ou um pouco maior para seguran√ßa)
                const metaFaturamento = Math.max(totalDespesasMesAnterior, 100); // M√≠nimo ‚Ç¨100
                
                // Quanto j√° faturou (recebimentos do m√™s atual)
                // Isso √© uma estimativa - idealmente voc√™ teria um campo de data de recebimento
                const faturadoAteAgora = totalReceber; // Simplifica√ß√£o
                
                const percentualMeta = Math.min(100, Math.round((faturadoAteAgora / metaFaturamento) * 100));
                
                document.getElementById('targetValue').textContent = formatarMoeda(metaFaturamento);
                document.getElementById('targetSub').textContent = `Baseado nas despesas pagas do m√™s anterior: ${formatarMoeda(totalDespesasMesAnterior)}`;
                document.getElementById('targetProgress').style.width = `${percentualMeta}%`;
                
                if (faturadoAteAgora >= metaFaturamento) {
                    document.getElementById('targetDetail').innerHTML = `‚úÖ Meta atingida! Faturado ${formatarMoeda(faturadoAteAgora)} de ${formatarMoeda(metaFaturamento)}`;
                } else {
                    const falta = metaFaturamento - faturadoAteAgora;
                    document.getElementById('targetDetail').innerHTML = `üìâ Faltam ${formatarMoeda(falta)} para atingir a meta do m√™s`;
                }
                
                // ============================================
                // COMPARATIVO POR CATEGORIA
                // ============================================
                
                const categoriasOrdenadas = [
                    '√ÅGUA', 'LUZ', 'ALUGUEL', 'TELEFONE', 'WHATSAPP', 
                    'INTERNET', 'SAL√ÅRIOS', 'COMBUSTIVEL', 'CAF√â', 
                    'ESCRITORIO', 'COMUNICA√á√ÉO', 'FINAN√áAS', 'OUTROS'
                ];
                
                let categoryHtml = '';
                
                categoriasOrdenadas.forEach(cat => {
                    const anterior = despesasMesAnterior[cat] || { pagas: 0, pendentes: 0, total: 0 };
                    const atual = despesasMesAtual[cat] || { pagas: 0, pendentes: 0, total: 0 };
                    
                    // Se n√£o tem nada em nenhum dos meses, n√£o mostrar
                    if (anterior.pagas === 0 && atual.pagas === 0 && atual.pendentes === 0) {
                        return;
                    }
                    
                    const totalAnterior = anterior.pagas; // S√≥ considerar pagas para base real
                    const totalAtualPago = atual.pagas;
                    const totalAtualPendente = atual.pendentes;
                    const totalAtual = totalAtualPago + totalAtualPendente;
                    
                    // Determinar status
                    let statusClass = 'ok';
                    let statusText = 'OK';
                    let remainingClass = 'positive';
                    
                    if (totalAtualPendente > 0) {
                        if (totalAtualPendente > totalAnterior * 0.5) {
                            statusClass = 'urgent';
                            statusText = 'URGENTE';
                        } else {
                            statusClass = 'warning';
                            statusText = 'PENDENTE';
                        }
                    }
                    
                    const percentualPago = totalAnterior > 0 ? Math.min(100, Math.round((totalAtualPago / totalAnterior) * 100)) : 0;
                    const faltaPagar = Math.max(0, totalAnterior - totalAtualPago);
                    
                    // √çcone baseado na categoria
                    let icon = 'fa-question';
                    let bgClass = 'outros';
                    
                    switch(cat) {
                        case '√ÅGUA': icon = 'fa-water'; bgClass = 'agua'; break;
                        case 'LUZ': icon = 'fa-bolt'; bgClass = 'luz'; break;
                        case 'ALUGUEL': icon = 'fa-building'; bgClass = 'aluguel'; break;
                        case 'TELEFONE': icon = 'fa-phone'; bgClass = 'telefone'; break;
                        case 'WHATSAPP': icon = 'fa-whatsapp'; bgClass = 'telefone'; break;
                        case 'INTERNET': icon = 'fa-wifi'; bgClass = 'telefone'; break;
                        case 'SAL√ÅRIOS': icon = 'fa-users'; bgClass = 'aluguel'; break;
                        case 'COMBUSTIVEL': icon = 'fa-gas-pump'; bgClass = 'combustivel'; break;
                        case 'CAF√â': icon = 'fa-mug-hot'; bgClass = 'outros'; break;
                        case 'ESCRITORIO': icon = 'fa-pen'; bgClass = 'outros'; break;
                        case 'COMUNICA√á√ÉO': icon = 'fa-bullhorn'; bgClass = 'telefone'; break;
                        case 'FINAN√áAS': icon = 'fa-coins'; bgClass = 'outros'; break;
                        default: icon = 'fa-box'; bgClass = 'outros';
                    }
                    
                    categoryHtml += `
                        <div class="category-card">
                            <div class="category-header ${bgClass}">
                                <div class="category-name">
                                    <div class="category-icon ${bgClass}">
                                        <i class="fas ${icon}"></i>
                                    </div>
                                    ${cat}
                                </div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            
                            <div class="category-values">
                                <div class="prev-month">
                                    <div class="prev-label">M√äS ANTERIOR</div>
                                    <div class="prev-value">${formatarMoeda(totalAnterior)}</div>
                                </div>
                                <div class="current-month">
                                    <div class="prev-label">M√äS ATUAL</div>
                                    <div class="current-value ${totalAtualPendente > 0 ? 'pending' : 'paid'}">
                                        ${formatarMoeda(totalAtual)}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="category-progress">
                                <div class="progress-bar" style="width: ${percentualPago}%;"></div>
                            </div>
                            
                            <div class="category-footer">
                                <div>
                                    <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                                    Pago: ${formatarMoeda(totalAtualPago)}
                                </div>
                                <div class="remaining ${faltaPagar > 0 ? 'negative' : 'positive'}">
                                    ${faltaPagar > 0 ? `Falta: ${formatarMoeda(faltaPagar)}` : 'OK'}
                                </div>
                            </div>
                            
                            ${totalAtualPendente > 0 ? `
                                <div style="margin-top: 8px; font-size: 12px; color: var(--warning-color);">
                                    <i class="fas fa-clock"></i> Pendente: ${formatarMoeda(totalAtualPendente)}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                // Se n√£o houver categorias, mostrar mensagem
                if (!categoryHtml) {
                    categoryHtml = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-chart-pie" style="font-size: 48px; margin-bottom: 16px;"></i><p>Nenhuma despesa encontrada nos √∫ltimos meses</p></div>';
                }
                
                document.getElementById('categoryComparison').innerHTML = categoryHtml;
                
                // ============================================
                // LISTAS
                // ============================================
                
                document.getElementById('totalReceberLista').textContent = formatarMoeda(totalReceber);
                document.getElementById('totalPagarLista').textContent = formatarMoeda(totalPagar);
                
                // Lista A RECEBER
                const receberOrdenados = [...aReceber].sort((a, b) => {
                    const aAtrasado = a.dataVencimento && a.dataVencimento < hoje ? 1 : 0;
                    const bAtrasado = b.dataVencimento && b.dataVencimento < hoje ? 1 : 0;
                    if (aAtrasado !== bAtrasado) return bAtrasado - aAtrasado;
                    
                    if (!a.dataVencimento) return 1;
                    if (!b.dataVencimento) return -1;
                    return a.dataVencimento - b.dataVencimento;
                });
                
                document.getElementById('listaReceber').innerHTML = receberOrdenados.length > 0 
                    ? receberOrdenados.map(item => {
                        const atrasado = item.dataVencimento && item.dataVencimento < hoje;
                        const dataStr = item.dataVencimento 
                            ? item.dataVencimento.toLocaleDateString('pt-PT') 
                            : 'Data n√£o definida';
                        
                        return `
                            <div class="list-item receita ${atrasado ? 'atrasado' : ''}">
                                <div class="list-icon"><i class="fas fa-user"></i></div>
                                <div class="list-content">
                                    <div class="list-title">${item.nome}</div>
                                    <div class="list-subtitle">${item.descricao}</div>
                                    <div class="list-meta">
                                        <span><i class="fas fa-calendar"></i> Vence: ${dataStr}</span>
                                        ${atrasado ? '<span class="badge atrasado">ATRASADO</span>' : ''}
                                    </div>
                                </div>
                                <div class="list-value receita ${atrasado ? 'atrasado' : ''}">
                                    ${formatarMoeda(item.valor)}
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 12px;"></i><p>Nenhum valor a receber pendente</p></div>';
                
                // Lista A PAGAR
                const pagarOrdenados = [...aPagar].sort((a, b) => {
                    const aAtrasado = a.dataVencimento && a.dataVencimento < hoje ? 1 : 0;
                    const bAtrasado = b.dataVencimento && b.dataVencimento < hoje ? 1 : 0;
                    if (aAtrasado !== bAtrasado) return bAtrasado - aAtrasado;
                    
                    if (!a.dataVencimento) return 1;
                    if (!b.dataVencimento) return -1;
                    return a.dataVencimento - b.dataVencimento;
                });
                
                document.getElementById('listaPagar').innerHTML = pagarOrdenados.length > 0
                    ? pagarOrdenados.map(item => {
                        const atrasado = item.dataVencimento && item.dataVencimento < hoje;
                        const dataStr = item.dataVencimento 
                            ? item.dataVencimento.toLocaleDateString('pt-PT') 
                            : 'Data n√£o definida';
                        
                        return `
                            <div class="list-item despesa ${atrasado ? 'atrasado' : ''}">
                                <div class="list-icon"><i class="fas fa-building"></i></div>
                                <div class="list-content">
                                    <div class="list-title">${item.nome}</div>
                                    <div class="list-subtitle">${item.descricao}</div>
                                    <div class="list-meta">
                                        <span><i class="fas fa-calendar"></i> Vence: ${dataStr}</span>
                                        <span><i class="fas fa-tag"></i> ${item.categoria}</span>
                                        ${atrasado ? '<span class="badge atrasado">ATRASADO</span>' : ''}
                                    </div>
                                </div>
                                <div class="list-value despesa ${atrasado ? 'atrasado' : ''}">
                                    ${formatarMoeda(item.valor)}
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 12px;"></i><p>Nenhuma despesa pendente</p></div>';
            }
            
            function formatarMoeda(valor) {
                return new Intl.NumberFormat('pt-PT', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(valor);
            }
            
            // Auto-refresh
            setInterval(carregarDados, 60000);
            
            // Iniciar
            carregarDados();
        });
    </script>

    <script src="../core/engine.js"></script>
</body>
</html>