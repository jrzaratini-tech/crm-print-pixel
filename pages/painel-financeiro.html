<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>PrintPixel - Gestor Financeiro Profissional</title>
    
    <!-- BIBLIOTECAS EXTERNAS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ============================================
           VARI√ÅVEIS E RESET
           ============================================ */
        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --hover-bg: #f1f5f9;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            /* Cores do gr√°fico */
            --chart-receita: #3b82f6;
            --chart-despesa: #f59e0b;
            --chart-atraso: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            padding: 20px;
        }

        /* ============================================
           HEADER PROFISSIONAL
           ============================================ */
        .page-header {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            padding: 24px 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            margin-bottom: 24px;
            color: white;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.3px;
            margin-bottom: 4px;
            opacity: 0.95;
        }

        .header-title p {
            font-size: 14px;
            opacity: 0.7;
        }

        .header-balance {
            background: rgba(255, 255, 255, 0.1);
            padding: 16px 28px;
            border-radius: 100px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .balance-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .balance-value {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
        }

        .balance-value.positive {
            color: #4ade80;
        }

        .balance-value.negative {
            color: #f87171;
        }

        .last-update {
            background: rgba(255, 255, 255, 0.08);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ============================================
           BALAN√áO PRINCIPAL (RECEITA VS DESPESA)
           ============================================ */
        .balance-section {
            margin-bottom: 24px;
        }

        .balance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .balance-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .balance-card.receita {
            background: linear-gradient(135deg, #1e3a8a, #2563eb);
            color: white;
        }

        .balance-card.despesa {
            background: linear-gradient(135deg, #78350f, #b45309);
            color: white;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-header h3 {
            font-size: 16px;
            font-weight: 500;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-header i {
            font-size: 24px;
            opacity: 0.8;
        }

        .card-value {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1;
        }

        .card-sub {
            display: flex;
            gap: 16px;
            font-size: 14px;
            opacity: 0.8;
        }

        .card-sub span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ============================================
           GR√ÅFICO PROFISSIONAL
           ============================================ */
        .chart-section {
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .chart-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-legend {
            display: flex;
            gap: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 4px;
        }

        .legend-color.receita {
            background: var(--chart-receita);
        }

        .legend-color.despesa {
            background: var(--chart-despesa);
        }

        .legend-color.atraso {
            background: var(--chart-atraso);
        }

        .chart-container {
            height: 300px;
            position: relative;
            margin-bottom: 20px;
        }

        .insight-card {
            background: var(--light-bg);
            border-radius: var(--radius-md);
            padding: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .insight-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: #e0e7ff;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .insight-content {
            flex: 1;
        }

        .insight-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .insight-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .insight-action {
            font-size: 14px;
            color: var(--primary-color);
            font-weight: 500;
            padding: 8px 16px;
            background: white;
            border-radius: 30px;
            border: 1px solid var(--border-color);
        }

        /* ============================================
           LISTAS PROFISSIONAIS
           ============================================ */
        .lists-section {
            margin-bottom: 24px;
        }

        .lists-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .lists-grid {
                grid-template-columns: 1fr;
            }
        }

        .list-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .list-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-header.receita {
            background: linear-gradient(135deg, #1e3a8a15, #2563eb15);
        }

        .list-header.despesa {
            background: linear-gradient(135deg, #78350f15, #b4530915);
        }

        .list-header h3 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .list-header h3 i {
            font-size: 18px;
        }

        .list-header.receita h3 {
            color: #1e3a8a;
        }

        .list-header.despesa h3 {
            color: #b45309;
        }

        .list-total {
            font-size: 20px;
            font-weight: 700;
        }

        .list-total.receita {
            color: #2563eb;
        }

        .list-total.despesa {
            color: #b45309;
        }

        .list-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--light-bg);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .list-item:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .list-item.atrasado {
            border-left: 4px solid var(--danger-color);
            background: #fee2e2;
        }

        .list-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .list-item.receita .list-icon {
            background: #dbeafe;
            color: #1e3a8a;
        }

        .list-item.despesa .list-icon {
            background: #fef3c7;
            color: #b45309;
        }

        .list-content {
            flex: 1;
            min-width: 0;
        }

        .list-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .list-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .list-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .list-value {
            font-weight: 700;
            font-size: 16px;
            white-space: nowrap;
        }

        .list-value.receita {
            color: #2563eb;
        }

        .list-value.despesa {
            color: #b45309;
        }

        .list-value.atrasado {
            color: var(--danger-color);
        }

        .badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 20px;
            font-weight: 600;
        }

        .badge.atrasado {
            background: #fee2e2;
            color: var(--danger-color);
        }

        .badge.hoje {
            background: #fef3c7;
            color: #92400e;
        }

        /* ============================================
           LOADING
           ============================================ */
        .loading-container {
            text-align: center;
            padding: 80px;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body data-page-id="gestor-financeiro" data-page-type="READ">

    <!-- ============================================
         HEADER PROFISSIONAL
         ============================================ -->
    <header class="page-header">
        <div class="header-content">
            <div class="header-title">
                <h1>Gestor Financeiro</h1>
                <p>An√°lise em tempo real ‚Ä¢ Fluxo de caixa ‚Ä¢ Intelig√™ncia de neg√≥cio</p>
            </div>
            
            <div class="header-balance" id="headerBalance">
                <div class="balance-label">BALAN√áO PATRIMONIAL</div>
                <div class="balance-value" id="balanceValue">‚Ç¨ 0</div>
            </div>
            
            <div class="last-update" id="lastUpdate">
                <i class="fas fa-sync-alt"></i>
                <span>Carregando...</span>
            </div>
        </div>
    </header>

    <!-- LOADING STATE -->
    <div id="loadingState" class="loading-container">
        <div class="loading-spinner"></div>
        <h3 style="margin-bottom: 8px;">Processando dados financeiros</h3>
        <p style="color: var(--text-secondary);">Carregando pedidos, despesas e gerando an√°lise</p>
    </div>

    <!-- CONTE√öDO PRINCIPAL -->
    <div id="mainContent" style="display: none;">
        
        <!-- BALAN√áO PRINCIPAL (RECEITA VS DESPESA) -->
        <section class="balance-section">
            <div class="balance-grid">
                <div class="balance-card receita">
                    <div class="card-header">
                        <h3><i class="fas fa-arrow-down"></i> A RECEBER</h3>
                        <i class="fas fa-arrow-circle-down"></i>
                    </div>
                    <div class="card-value" id="totalReceber">‚Ç¨ 0</div>
                    <div class="card-sub">
                        <span><i class="fas fa-clock"></i> <span id="qtdReceber">0</span> pendentes</span>
                        <span><i class="fas fa-exclamation-triangle"></i> <span id="receberAtrasado">‚Ç¨ 0</span> atrasado</span>
                    </div>
                </div>
                
                <div class="balance-card despesa">
                    <div class="card-header">
                        <h3><i class="fas fa-arrow-up"></i> A PAGAR</h3>
                        <i class="fas fa-arrow-circle-up"></i>
                    </div>
                    <div class="card-value" id="totalPagar">‚Ç¨ 0</div>
                    <div class="card-sub">
                        <span><i class="fas fa-clock"></i> <span id="qtdPagar">0</span> pendentes</span>
                        <span><i class="fas fa-exclamation-triangle"></i> <span id="pagarAtrasado">‚Ç¨ 0</span> atrasado</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- GR√ÅFICO DE LINHA PROFISSIONAL -->
        <section class="chart-section">
            <div class="chart-card">
                <div class="chart-header">
                    <h2><i class="fas fa-chart-line" style="margin-right: 8px; color: var(--primary-color);"></i> Evolu√ß√£o Financeira - √öltimos 6 Meses</h2>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color receita"></div>
                            <span>Receitas</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color despesa"></div>
                            <span>Despesas</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color atraso"></div>
                            <span>A receber atrasado</span>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="financialChart"></canvas>
                </div>
                
                <div class="insight-card" id="insightCard">
                    <!-- Preenchido via JS -->
                </div>
            </div>
        </section>

        <!-- LISTAS COMPLETAS -->
        <section class="lists-section">
            <div class="lists-grid">
                <!-- A RECEBER -->
                <div class="list-card">
                    <div class="list-header receita">
                        <h3><i class="fas fa-arrow-down"></i> A RECEBER ‚Ä¢ Pendentes</h3>
                        <span class="list-total receita" id="totalReceberLista">‚Ç¨ 0</span>
                    </div>
                    <div class="list-container" id="listaReceber">
                        <!-- Preenchido via JS -->
                    </div>
                </div>

                <!-- A PAGAR -->
                <div class="list-card">
                    <div class="list-header despesa">
                        <h3><i class="fas fa-arrow-up"></i> A PAGAR ‚Ä¢ Pendentes</h3>
                        <span class="list-total despesa" id="totalPagarLista">‚Ç¨ 0</span>
                    </div>
                    <div class="list-container" id="listaPagar">
                        <!-- Preenchido via JS -->
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        // ============================================
        // GESTOR FINANCEIRO PROFISSIONAL
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä Gestor Financeiro Profissional iniciado');
            
            // Elementos do DOM
            const loadingState = document.getElementById('loadingState');
            const mainContent = document.getElementById('mainContent');
            const lastUpdateSpan = document.getElementById('lastUpdate').querySelector('span');
            
            // Estado da aplica√ß√£o
            let todosPedidos = [];
            let todasDespesas = [];
            let grafico = null;
            
            // ============================================
            // CARREGAR DADOS
            // ============================================
            
            async function carregarDados() {
                try {
                    console.log('üîÑ Carregando dados...');
                    
                    const responsePedidos = await fetch('/api/database/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ schema: 'pedido', filters: {} })
                    });
                    
                    const responseDespesas = await fetch('/api/database/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ schema: 'despesa', filters: {} })
                    });
                    
                    if (!responsePedidos.ok || !responseDespesas.ok) {
                        throw new Error('Erro ao carregar dados');
                    }
                    
                    const resultPedidos = await responsePedidos.json();
                    const resultDespesas = await responseDespesas.json();
                    
                    processarPedidos(resultPedidos.events || []);
                    processarDespesas(resultDespesas.events || []);
                    
                    renderizarPainel();
                    
                    loadingState.style.display = 'none';
                    mainContent.style.display = 'block';
                    
                    dataAtualizacao = new Date();
                    lastUpdateSpan.textContent = `${dataAtualizacao.toLocaleDateString('pt-PT')} ‚Ä¢ ${dataAtualizacao.toLocaleTimeString('pt-PT')}`;
                    
                } catch (error) {
                    console.error('‚ùå Erro:', error);
                    loadingState.innerHTML = `
                        <div style="color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px;"></i>
                            <h3>Erro ao carregar</h3>
                            <p>${error.message}</p>
                            <button onclick="location.reload()" style="margin-top: 16px; padding: 12px 24px; background: var(--primary-color); color: white; border: none; border-radius: 8px;">
                                <i class="fas fa-redo"></i> Tentar novamente
                            </button>
                        </div>
                    `;
                }
            }
            
            // ============================================
            // PROCESSADORES
            // ============================================
            
            function processarPedidos(events) {
                const pedidosMap = new Map();
                events
                    .filter(e => e.schema === 'pedido' && !e.deleted)
                    .forEach(e => {
                        const id = e.id;
                        if (pedidosMap.has(id)) {
                            const existing = pedidosMap.get(id);
                            const existingTime = new Date(existing.timestamp || 0).getTime();
                            const newTime = new Date(e.timestamp || 0).getTime();
                            if (newTime > existingTime) pedidosMap.set(id, e);
                        } else {
                            pedidosMap.set(id, e);
                        }
                    });
                
                todosPedidos = Array.from(pedidosMap.values()).map(event => {
                    let payload = event.payload;
                    if (typeof payload === 'string') {
                        try { payload = JSON.parse(payload); } 
                        catch (e) { payload = {}; }
                    }
                    
                    const pagamentos = Array.isArray(payload.pagamentos) ? payload.pagamentos : [];
                    const totalPago = pagamentos
                        .filter(p => p.status === 'pago')
                        .reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0);
                    
                    const totalPedido = parseFloat(payload.total) || 0;
                    const saldoPendente = totalPedido - totalPago;
                    
                    let statusPagamento = 'pendente';
                    if (totalPago === 0) statusPagamento = 'pendente';
                    else if (totalPago > 0 && totalPago < totalPedido) statusPagamento = 'parcial';
                    else if (totalPago >= totalPedido) statusPagamento = 'pago';
                    
                    let dataVencimento = null;
                    if (payload.dataEntrega) {
                        dataVencimento = new Date(payload.dataEntrega);
                        dataVencimento.setHours(0,0,0,0);
                    }
                    
                    // Data de cria√ß√£o para o gr√°fico
                    let dataCriacao = null;
                    if (event.timestamp) {
                        dataCriacao = new Date(event.timestamp);
                    } else if (event.created_at) {
                        dataCriacao = new Date(event.created_at);
                    }
                    
                    return {
                        id: event.id,
                        nome: payload.cliente || 'Cliente',
                        descricao: payload.empresa || `Pedido ${payload.numero || ''}`,
                        valor: saldoPendente,
                        valorTotal: totalPedido,
                        status: statusPagamento,
                        dataVencimento: dataVencimento,
                        dataCriacao: dataCriacao,
                        createdAt: event.timestamp || event.created_at
                    };
                }).filter(p => p.valor > 0);
            }
            
            function processarDespesas(events) {
                const despesasMap = new Map();
                events
                    .filter(e => e.schema === 'despesa')
                    .forEach(e => {
                        const id = e.id;
                        if (despesasMap.has(id)) {
                            const existing = despesasMap.get(id);
                            const existingTime = new Date(existing.timestamp || 0).getTime();
                            const newTime = new Date(e.timestamp || 0).getTime();
                            if (newTime > existingTime) despesasMap.set(id, e);
                        } else {
                            despesasMap.set(id, e);
                        }
                    });
                
                todasDespesas = Array.from(despesasMap.values()).map(event => {
                    let payload = event.payload;
                    if (typeof payload === 'string') {
                        try { payload = JSON.parse(payload); } 
                        catch (e) { payload = {}; }
                    }
                    
                    const valorBruto = parseFloat(payload.valorBruto) || 0;
                    const comIVA = payload.comIVA === 'sim';
                    const valorIVA = comIVA ? valorBruto * 0.23 : 0;
                    const valorTotal = valorBruto + valorIVA;
                    
                    let dataVencimento = null;
                    if (payload.dataVencimento) {
                        dataVencimento = new Date(payload.dataVencimento);
                        dataVencimento.setHours(0,0,0,0);
                    } else if (payload.data) {
                        dataVencimento = new Date(payload.data);
                        dataVencimento.setHours(0,0,0,0);
                    }
                    
                    let dataCriacao = null;
                    if (event.timestamp) {
                        dataCriacao = new Date(event.timestamp);
                    } else if (event.created_at) {
                        dataCriacao = new Date(event.created_at);
                    }
                    
                    return {
                        id: event.id,
                        nome: payload.fornecedor || 'Fornecedor',
                        descricao: payload.descricao || payload.categoria || 'Despesa',
                        valor: valorTotal,
                        status: payload.statusPagamento || 'pendente',
                        dataVencimento: dataVencimento,
                        dataCriacao: dataCriacao,
                        categoria: payload.categoria || 'OUTROS',
                        data: payload.data,
                        createdAt: event.timestamp || event.created_at,
                        deleted: event.deleted || false
                    };
                });
            }
            
            // ============================================
            // GR√ÅFICO DE LINHA
            // ============================================
            
            function gerarDadosGrafico() {
                const hoje = new Date();
                const meses = [];
                const receitasMensais = [];
                const despesasMensais = [];
                const atrasadosMensais = [];
                
                // Gerar √∫ltimos 6 meses
                for (let i = 5; i >= 0; i--) {
                    const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                    const mesAno = data.toLocaleDateString('pt-PT', { month: 'short', year: '2-digit' });
                    meses.push(mesAno);
                    
                    const ano = data.getFullYear();
                    const mes = data.getMonth();
                    
                    // Calcular receitas do m√™s (pedidos pagos ou criados no m√™s)
                    let receitaMes = 0;
                    todosPedidos.forEach(p => {
                        if (p.dataCriacao && p.dataCriacao.getMonth() === mes && p.dataCriacao.getFullYear() === ano) {
                            receitaMes += p.valorTotal;
                        }
                    });
                    receitasMensais.push(receitaMes);
                    
                    // Calcular despesas do m√™s (pagas no m√™s)
                    let despesaMes = 0;
                    todasDespesas.forEach(d => {
                        if (d.status === 'paga' && d.dataCriacao && d.dataCriacao.getMonth() === mes && d.dataCriacao.getFullYear() === ano) {
                            despesaMes += d.valor;
                        }
                    });
                    despesasMensais.push(despesaMes);
                    
                    // Calcular atrasados do m√™s
                    let atrasadoMes = 0;
                    todosPedidos.forEach(p => {
                        if (p.status !== 'pago' && p.dataVencimento && 
                            p.dataVencimento.getMonth() === mes && 
                            p.dataVencimento.getFullYear() === ano &&
                            p.dataVencimento < hoje) {
                            atrasadoMes += p.valor;
                        }
                    });
                    atrasadosMensais.push(atrasadoMes);
                }
                
                return { meses, receitasMensais, despesasMensais, atrasadosMensais };
            }
            
            function criarGrafico() {
                const ctx = document.getElementById('financialChart').getContext('2d');
                const dados = gerarDadosGrafico();
                
                if (grafico) {
                    grafico.destroy();
                }
                
                grafico = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dados.meses,
                        datasets: [
                            {
                                label: 'Receitas',
                                data: dados.receitasMensais,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 3,
                                pointBackgroundColor: '#3b82f6',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.3,
                                fill: false
                            },
                            {
                                label: 'Despesas',
                                data: dados.despesasMensais,
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                borderWidth: 3,
                                pointBackgroundColor: '#f59e0b',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.3,
                                fill: false
                            },
                            {
                                label: 'A receber atrasado',
                                data: dados.atrasadosMensais,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 3,
                                borderDash: [5, 5],
                                pointBackgroundColor: '#ef4444',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                tension: 0.3,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: '#1e293b',
                                titleColor: '#ffffff',
                                bodyColor: '#e2e8f0',
                                borderColor: '#334155',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('pt-PT', {
                                                style: 'currency',
                                                currency: 'EUR',
                                                minimumFractionDigits: 0
                                            }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#e2e8f0',
                                    drawBorder: false
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '‚Ç¨' + value.toLocaleString('pt-PT');
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                return dados;
            }
            
            // ============================================
            // RENDERIZA√á√ÉO
            // ============================================
            
            function renderizarPainel() {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                // Filtrar dados
                const aReceber = todosPedidos.filter(p => 
                    p.status === 'pendente' || p.status === 'parcial'
                );
                
                const aPagar = todasDespesas.filter(d => 
                    d.status === 'pendente' && !d.deleted
                );
                
                // Atrasados
                const aReceberAtrasado = aReceber.filter(p => {
                    if (!p.dataVencimento) return false;
                    return p.dataVencimento < hoje;
                });
                
                const aPagarAtrasado = aPagar.filter(d => {
                    if (!d.dataVencimento) return false;
                    return d.dataVencimento < hoje;
                });
                
                // Totais
                const totalReceber = aReceber.reduce((sum, p) => sum + p.valor, 0);
                const totalPagar = aPagar.reduce((sum, d) => sum + d.valor, 0);
                const totalReceberAtrasado = aReceberAtrasado.reduce((sum, p) => sum + p.valor, 0);
                const totalPagarAtrasado = aPagarAtrasado.reduce((sum, d) => sum + d.valor, 0);
                
                // BALAN√áO PATRIMONIAL (header)
                const balanco = totalReceber - totalPagar;
                const balanceElement = document.getElementById('balanceValue');
                balanceElement.textContent = formatarMoeda(balanco);
                balanceElement.className = `balance-value ${balanco >= 0 ? 'positive' : 'negative'}`;
                
                // CARDS DE BALAN√áO
                document.getElementById('totalReceber').textContent = formatarMoeda(totalReceber);
                document.getElementById('qtdReceber').textContent = aReceber.length;
                document.getElementById('receberAtrasado').textContent = formatarMoeda(totalReceberAtrasado);
                
                document.getElementById('totalPagar').textContent = formatarMoeda(totalPagar);
                document.getElementById('qtdPagar').textContent = aPagar.length;
                document.getElementById('pagarAtrasado').textContent = formatarMoeda(totalPagarAtrasado);
                
                // GR√ÅFICO
                const dadosGrafico = criarGrafico();
                
                // INSIGHT INTELIGENTE
                const ultimoMesReceita = dadosGrafico.receitasMensais[dadosGrafico.receitasMensais.length - 1] || 0;
                const ultimoMesDespesa = dadosGrafico.despesasMensais[dadosGrafico.despesasMensais.length - 1] || 0;
                const totalAtrasado = totalReceberAtrasado + totalPagarAtrasado;
                
                let insightMensagem = '';
                let insightValor = '';
                
                if (totalAtrasado > 0) {
                    insightMensagem = 'Para regularizar a situa√ß√£o, voc√™ precisa receber:';
                    insightValor = formatarMoeda(totalAtrasado);
                } else if (ultimoMesReceita < ultimoMesDespesa) {
                    const deficit = ultimoMesDespesa - ultimoMesReceita;
                    insightMensagem = 'No √∫ltimo m√™s, suas despesas superaram as receitas em:';
                    insightValor = formatarMoeda(deficit);
                } else if (ultimoMesReceita > ultimoMesDespesa) {
                    const superavit = ultimoMesReceita - ultimoMesDespesa;
                    insightMensagem = 'No √∫ltimo m√™s, voc√™ teve um super√°vit de:';
                    insightValor = formatarMoeda(superavit);
                } else {
                    insightMensagem = 'Seu fluxo est√° equilibrado. Meta sugerida para crescer:';
                    insightValor = formatarMoeda(ultimoMesReceita * 0.2);
                }
                
                document.getElementById('insightCard').innerHTML = `
                    <div class="insight-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">${insightMensagem}</div>
                        <div class="insight-value">${insightValor}</div>
                    </div>
                    <div class="insight-action">
                        <i class="fas fa-arrow-right"></i> Detalhes
                    </div>
                `;
                
                // LISTAS
                document.getElementById('totalReceberLista').textContent = formatarMoeda(totalReceber);
                document.getElementById('totalPagarLista').textContent = formatarMoeda(totalPagar);
                
                // Lista A RECEBER
                const receberOrdenados = [...aReceber].sort((a, b) => {
                    const aAtrasado = a.dataVencimento && a.dataVencimento < hoje ? 1 : 0;
                    const bAtrasado = b.dataVencimento && b.dataVencimento < hoje ? 1 : 0;
                    if (aAtrasado !== bAtrasado) return bAtrasado - aAtrasado;
                    
                    if (!a.dataVencimento) return 1;
                    if (!b.dataVencimento) return -1;
                    return a.dataVencimento - b.dataVencimento;
                });
                
                document.getElementById('listaReceber').innerHTML = receberOrdenados.length > 0 
                    ? receberOrdenados.map(item => {
                        const atrasado = item.dataVencimento && item.dataVencimento < hoje;
                        const dataStr = item.dataVencimento 
                            ? item.dataVencimento.toLocaleDateString('pt-PT') 
                            : 'Data n√£o definida';
                        
                        return `
                            <div class="list-item receita ${atrasado ? 'atrasado' : ''}">
                                <div class="list-icon"><i class="fas fa-user"></i></div>
                                <div class="list-content">
                                    <div class="list-title">${item.nome}</div>
                                    <div class="list-subtitle">${item.descricao}</div>
                                    <div class="list-meta">
                                        <span><i class="fas fa-calendar"></i> Vence: ${dataStr}</span>
                                        ${atrasado ? '<span class="badge atrasado">ATRASADO</span>' : ''}
                                    </div>
                                </div>
                                <div class="list-value receita ${atrasado ? 'atrasado' : ''}">
                                    ${formatarMoeda(item.valor)}
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 12px;"></i><p>Nenhum valor a receber pendente</p></div>';
                
                // Lista A PAGAR
                const pagarOrdenados = [...aPagar].sort((a, b) => {
                    const aAtrasado = a.dataVencimento && a.dataVencimento < hoje ? 1 : 0;
                    const bAtrasado = b.dataVencimento && b.dataVencimento < hoje ? 1 : 0;
                    if (aAtrasado !== bAtrasado) return bAtrasado - aAtrasado;
                    
                    if (!a.dataVencimento) return 1;
                    if (!b.dataVencimento) return -1;
                    return a.dataVencimento - b.dataVencimento;
                });
                
                document.getElementById('listaPagar').innerHTML = pagarOrdenados.length > 0
                    ? pagarOrdenados.map(item => {
                        const atrasado = item.dataVencimento && item.dataVencimento < hoje;
                        const dataStr = item.dataVencimento 
                            ? item.dataVencimento.toLocaleDateString('pt-PT') 
                            : 'Data n√£o definida';
                        
                        return `
                            <div class="list-item despesa ${atrasado ? 'atrasado' : ''}">
                                <div class="list-icon"><i class="fas fa-building"></i></div>
                                <div class="list-content">
                                    <div class="list-title">${item.nome}</div>
                                    <div class="list-subtitle">${item.descricao}</div>
                                    <div class="list-meta">
                                        <span><i class="fas fa-calendar"></i> Vence: ${dataStr}</span>
                                        ${atrasado ? '<span class="badge atrasado">ATRASADO</span>' : ''}
                                    </div>
                                </div>
                                <div class="list-value despesa ${atrasado ? 'atrasado' : ''}">
                                    ${formatarMoeda(item.valor)}
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 12px;"></i><p>Nenhuma despesa pendente</p></div>';
            }
            
            function formatarMoeda(valor) {
                return new Intl.NumberFormat('pt-PT', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(valor);
            }
            
            // Auto-refresh
            setInterval(carregarDados, 60000);
            
            // Iniciar
            carregarDados();
        });
    </script>

    <script src="../core/engine.js"></script>
</body>
</html>