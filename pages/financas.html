<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de D√≠vidas - Finan√ßas & Escrit√≥rio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* HEADER MODERNO */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 30px 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .header h1 {
            font-size: 36px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 i {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 40px;
        }

        .subtitle {
            color: #64748b;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subtitle span {
            background: #e2e8f0;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #475569;
        }

        /* TABS PARA CATEGORIAS */
        .categorias-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .categoria-tab {
            flex: 1;
            background: white;
            border: none;
            padding: 20px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #64748b;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .categoria-tab i {
            font-size: 24px;
        }

        .categoria-tab.financas {
            border-bottom: 4px solid #3b82f6;
        }

        .categoria-tab.financas.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 10px 25px rgba(59,130,246,0.3);
        }

        .categoria-tab.escritorio {
            border-bottom: 4px solid #10b981;
        }

        .categoria-tab.escritorio.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 10px 25px rgba(16,185,129,0.3);
        }

        /* INDICADORES */
        .indicadores-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }

        .card-indicador {
            background: white;
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-indicador:hover {
            transform: translateY(-5px);
        }

        .indicador-titulo {
            color: #64748b;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .indicador-valor {
            font-size: 42px;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.2;
            margin-bottom: 8px;
        }

        .indicador-sub {
            color: #94a3b8;
            font-size: 13px;
        }

        .card-indicador.financas .indicador-titulo i { color: #3b82f6; }
        .card-indicador.escritorio .indicador-titulo i { color: #10b981; }

        /* GRID PRINCIPAL */
        .grid-2colunas {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        /* CARDS */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-titulo {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-titulo i {
            color: #667eea;
        }

        /* FORMUL√ÅRIOS */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #334155;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102,126,234,0.4);
        }

        .btn-financas {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .btn-escritorio {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        /* LISTAS */
        .lista-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .lista-container::-webkit-scrollbar {
            width: 8px;
        }

        .lista-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .lista-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .item-divida {
            background: #f8fafc;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .item-divida:hover {
            background: #f1f5f9;
            transform: translateX(5px);
        }

        .item-divida.selected {
            border-color: #667eea;
            background: #eff6ff;
        }

        .divida-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .divida-descricao {
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
        }

        .divida-categoria {
            font-size: 11px;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .categoria-financas {
            background: #dbeafe;
            color: #1e40af;
        }

        .categoria-escritorio {
            background: #d1fae5;
            color: #065f46;
        }

        .divida-valores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .valor-item {
            text-align: center;
        }

        .valor-label {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 5px;
        }

        .valor-number {
            font-weight: 700;
            font-size: 16px;
            color: #1e293b;
        }

        .progresso {
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progresso-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.3s;
        }

        /* ITEM DE PAGAMENTO */
        .item-pagamento {
            background: #f8fafc;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-pagamento.financas {
            border-left-color: #3b82f6;
        }

        .item-pagamento.escritorio {
            border-left-color: #10b981;
        }

        .pagamento-info h4 {
            color: #1e293b;
            margin-bottom: 5px;
            font-size: 15px;
        }

        .pagamento-info p {
            color: #64748b;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pagamento-valor {
            font-weight: 700;
            font-size: 20px;
            color: #10b981;
        }

        .badge {
            background: #e2e8f0;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: #475569;
        }

        /* MENSAGENS */
        .mensagem-flutuante {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 16px;
            color: white;
            font-weight: 600;
            z-index: 9999;
            animation: slideIn 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* RESPONSIVO */
        @media (max-width: 1024px) {
            .grid-2colunas {
                grid-template-columns: 1fr;
            }
            
            .indicadores-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .indicadores-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-group.full-width {
                grid-column: span 1;
            }
            
            .categorias-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>
                <i>üí∞</i> 
                Gest√£o de D√≠vidas
            </h1>
            <div class="subtitle">
                Controle de pagamentos - Finan√ßas & Escrit√≥rio
                <span>‚ö° Independente do CRM</span>
            </div>
        </div>

        <!-- TABS DE CATEGORIA -->
        <div class="categorias-tabs">
            <button class="categoria-tab financas active" onclick="mudarCategoria('financas')" id="tabFinancas">
                <i>üèõÔ∏è</i> Finan√ßas
            </button>
            <button class="categoria-tab escritorio" onclick="mudarCategoria('escritorio')" id="tabEscritorio">
                <i>üìã</i> Escrit√≥rio Contabil
            </button>
        </div>

        <!-- INDICADORES - FINAN√áAS (VIS√çVEL POR PADR√ÉO) -->
        <div id="indicadoresFinancas" class="indicadores-grid">
            <div class="card-indicador financas">
                <div class="indicador-titulo">
                    <i>üìä</i> TOTAL D√çVIDAS (FINAN√áAS)
                </div>
                <div class="indicador-valor" id="totalDividasFinancas">‚Ç¨0,00</div>
                <div class="indicador-sub">Valor total das d√≠vidas</div>
            </div>
            
            <div class="card-indicador financas">
                <div class="indicador-titulo">
                    <i>‚úÖ</i> TOTAL PAGO (FINAN√áAS)
                </div>
                <div class="indicador-valor" id="totalPagoFinancas">‚Ç¨0,00</div>
                <div class="indicador-sub">Soma dos pagamentos</div>
            </div>
            
            <div class="card-indicador financas">
                <div class="indicador-titulo">
                    <i>‚è≥</i> RESTANTE (FINAN√áAS)
                </div>
                <div class="indicador-valor" id="totalRestanteFinancas">‚Ç¨0,00</div>
                <div class="indicador-sub">Saldo a pagar</div>
            </div>
        </div>

        <!-- INDICADORES - ESCRIT√ìRIO (INICIALMENTE OCULTO) -->
        <div id="indicadoresEscritorio" class="indicadores-grid" style="display: none;">
            <div class="card-indicador escritorio">
                <div class="indicador-titulo">
                    <i>üìä</i> TOTAL D√çVIDAS (ESCRIT√ìRIO)
                </div>
                <div class="indicador-valor" id="totalDividasEscritorio">‚Ç¨0,00</div>
                <div class="indicador-sub">Valor total das d√≠vidas</div>
            </div>
            
            <div class="card-indicador escritorio">
                <div class="indicador-titulo">
                    <i>‚úÖ</i> TOTAL PAGO (ESCRIT√ìRIO)
                </div>
                <div class="indicador-valor" id="totalPagoEscritorio">‚Ç¨0,00</div>
                <div class="indicador-sub">Soma dos pagamentos</div>
            </div>
            
            <div class="card-indicador escritorio">
                <div class="indicador-titulo">
                    <i>‚è≥</i> RESTANTE (ESCRIT√ìRIO)
                </div>
                <div class="indicador-valor" id="totalRestanteEscritorio">‚Ç¨0,00</div>
                <div class="indicador-sub">Saldo a pagar</div>
            </div>
        </div>

        <!-- GRID PRINCIPAL -->
        <div class="grid-2colunas">
            <!-- COLUNA ESQUERDA: Cadastro de D√≠vidas -->
            <div class="card">
                <h2 class="card-titulo">
                    <i>‚ûï</i> <span id="tituloCadastro">Cadastrar Nova D√≠vida (Finan√ßas)</span>
                </h2>
                
                <form id="formDivida">
                    <input type="hidden" id="categoriaAtual" value="financas">
                    
                    <div class="form-group">
                        <label>Descri√ß√£o da D√≠vida</label>
                        <input type="text" id="descricao" placeholder="Ex: IRS 2023 - Finan√ßas" required>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Valor Total (‚Ç¨)</label>
                            <input type="number" id="valorTotal" step="0.01" min="0" placeholder="0,00" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Data de Negocia√ß√£o</label>
                            <input type="date" id="dataNegociacao" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Observa√ß√µes</label>
                        <textarea id="observacoesDivida" rows="3" placeholder="Detalhes da d√≠vida..."></textarea>
                    </div>
                    
                    <button type="button" class="btn" id="btnSalvarDivida" onclick="salvarDivida()">
                        <i>üíæ</i> REGISTRAR D√çVIDA
                    </button>
                </form>

                <div class="mt-20">
                    <h2 class="card-titulo">
                        <i>üìã</i> <span id="tituloLista">D√≠vidas Ativas (Finan√ßas)</span>
                    </h2>
                    <div id="listaDividas" class="lista-container">
                        <div style="text-align: center; color: #94a3b8; padding: 30px;">
                            Carregando d√≠vidas...
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUNA DIREITA: Pagamentos -->
            <div class="card">
                <h2 class="card-titulo">
                    <i>üí≥</i> <span id="tituloPagamento">Registrar Pagamento (Finan√ßas)</span>
                </h2>
                
                <form id="formPagamento">
                    <div class="form-group">
                        <label>Selecionar D√≠vida</label>
                        <select id="dividaSelect" required>
                            <option value="">Selecione uma d√≠vida...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Valor do Pagamento (‚Ç¨)</label>
                        <input type="number" id="valorPago" step="0.01" min="0.01" placeholder="0,00" required>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Data do Pagamento</label>
                            <input type="date" id="dataPagamento" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Forma de Pagamento</label>
                            <select id="formaPagamento" required>
                                <option value="MBWay">MBWay</option>
                                <option value="Transfer√™ncia">Transfer√™ncia Banc√°ria</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Cart√£o">Cart√£o de Cr√©dito</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Observa√ß√µes</label>
                        <textarea id="observacoesPagamento" rows="2" placeholder="Observa√ß√µes..."></textarea>
                    </div>
                    
                    <button type="button" class="btn" id="btnSalvarPagamento" onclick="salvarPagamento()">
                        <i>‚úÖ</i> REGISTRAR PAGAMENTO
                    </button>
                </form>

                <!-- Hist√≥rico de Pagamentos -->
                <div class="mt-20">
                    <h2 class="card-titulo">
                        <i>üìú</i> <span id="tituloHistorico">Hist√≥rico de Pagamentos</span>
                    </h2>
                    <div id="historicoPagamentos" class="lista-container">
                        <div style="text-align: center; color: #94a3b8; padding: 30px;">
                            Selecione uma d√≠vida para ver os pagamentos
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SISTEMA DE GEST√ÉO DE D√çVIDAS - CORRIGIDO
        // ============================================
        
        // Schemas exclusivos por categoria
        const SCHEMAS = {
            financas: {
                divida: 'financas_divida',
                pagamento: 'financas_pagamento'
            },
            escritorio: {
                divida: 'escritorio_divida',
                pagamento: 'escritorio_pagamento'
            }
        };

        let categoriaSelecionada = 'financas';
        let dividaSelecionadaId = null;

        // ============================================
        // MUDAR CATEGORIA
        // ============================================
        function mudarCategoria(categoria) {
            categoriaSelecionada = categoria;
            
            // Atualizar Tabs
            document.getElementById('tabFinancas').classList.remove('active');
            document.getElementById('tabEscritorio').classList.remove('active');
            
            if (categoria === 'financas') {
                document.getElementById('tabFinancas').classList.add('active');
                document.getElementById('indicadoresFinancas').style.display = 'grid';
                document.getElementById('indicadoresEscritorio').style.display = 'none';
                
                // Atualizar t√≠tulos
                document.getElementById('tituloCadastro').textContent = 'Cadastrar Nova D√≠vida (Finan√ßas)';
                document.getElementById('tituloLista').textContent = 'D√≠vidas Ativas (Finan√ßas)';
                document.getElementById('tituloPagamento').textContent = 'Registrar Pagamento (Finan√ßas)';
                document.getElementById('tituloHistorico').textContent = 'Hist√≥rico de Pagamentos';
                
                // Atualizar cores dos bot√µes
                document.getElementById('btnSalvarDivida').className = 'btn btn-financas';
                document.getElementById('btnSalvarPagamento').className = 'btn btn-financas';
            } else {
                document.getElementById('tabEscritorio').classList.add('active');
                document.getElementById('indicadoresEscritorio').style.display = 'grid';
                document.getElementById('indicadoresFinancas').style.display = 'none';
                
                // Atualizar t√≠tulos
                document.getElementById('tituloCadastro').textContent = 'Cadastrar Nova D√≠vida (Escrit√≥rio)';
                document.getElementById('tituloLista').textContent = 'D√≠vidas Ativas (Escrit√≥rio)';
                document.getElementById('tituloPagamento').textContent = 'Registrar Pagamento (Escrit√≥rio)';
                document.getElementById('tituloHistorico').textContent = 'Hist√≥rico de Pagamentos';
                
                // Atualizar cores dos bot√µes
                document.getElementById('btnSalvarDivida').className = 'btn btn-escritorio';
                document.getElementById('btnSalvarPagamento').className = 'btn btn-escritorio';
            }
            
            // Limpar sele√ß√£o
            dividaSelecionadaId = null;
            
            // Recarregar dados da categoria
            carregarDividas();
            atualizarIndicadores();
            
            // Limpar hist√≥rico
            document.getElementById('historicoPagamentos').innerHTML = `
                <div style="text-align: center; color: #94a3b8; padding: 30px;">
                    Selecione uma d√≠vida para ver os pagamentos
                </div>
            `;
        }

        // ============================================
        // CARREGAR D√çVIDAS
        // ============================================
        async function carregarDividas() {
            try {
                const schema = SCHEMAS[categoriaSelecionada].divida;
                
                const response = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: schema,
                        filters: {}
                    })
                });

                if (!response.ok) throw new Error('Erro ao carregar d√≠vidas');
                
                const data = await response.json();
                const dividas = data.events || [];
                
                // Atualizar lista
                atualizarListaDividas(dividas);
                
                // Atualizar select
                atualizarSelectDividas(dividas);
                
                return dividas;
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao carregar d√≠vidas', 'error');
                return [];
            }
        }

        // ============================================
        // CARREGAR PAGAMENTOS
        // ============================================
        async function carregarPagamentos(dividaId = null) {
            try {
                const schema = SCHEMAS[categoriaSelecionada].pagamento;
                let body = {
                    schema: schema,
                    filters: {}
                };
                
                if (dividaId) {
                    body.filters.dividaId = dividaId;
                }
                
                const response = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error('Erro ao carregar pagamentos');
                
                const data = await response.json();
                return data.events || [];
            } catch (error) {
                console.error('Erro:', error);
                return [];
            }
        }

        // ============================================
        // ATUALIZAR LISTA DE D√çVIDAS
        // ============================================
        function atualizarListaDividas(dividas) {
            const container = document.getElementById('listaDividas');
            
            if (!dividas || dividas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #94a3b8; padding: 30px;">
                        Nenhuma d√≠vida cadastrada em ${categoriaSelecionada}
                    </div>
                `;
                return;
            }

            // Ordenar por data (mais recentes primeiro)
            dividas.sort((a, b) => new Date(b.payload.dataNegociacao) - new Date(a.payload.dataNegociacao));

            let html = '';
            dividas.forEach(divida => {
                const p = divida.payload;
                const percentualPago = p.valorTotal > 0 ? (p.valorPago / p.valorTotal) * 100 : 0;
                const categoriaClass = categoriaSelecionada === 'financas' ? 'categoria-financas' : 'categoria-escritorio';
                const selectedClass = dividaSelecionadaId === divida.id ? 'selected' : '';
                
                html += `
                    <div class="item-divida ${selectedClass}" onclick="selecionarDivida('${divida.id}')">
                        <div class="divida-header">
                            <span class="divida-descricao">${p.descricao}</span>
                            <span class="divida-categoria ${categoriaClass}">${categoriaSelecionada === 'financas' ? 'Finan√ßas' : 'Escrit√≥rio'}</span>
                        </div>
                        <div class="divida-valores">
                            <div class="valor-item">
                                <div class="valor-label">Total</div>
                                <div class="valor-number">‚Ç¨${p.valorTotal?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div class="valor-item">
                                <div class="valor-label">Pago</div>
                                <div class="valor-number">‚Ç¨${p.valorPago?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div class="valor-item">
                                <div class="valor-label">Restante</div>
                                <div class="valor-number">‚Ç¨${p.saldoRestante?.toFixed(2) || '0.00'}</div>
                            </div>
                        </div>
                        <div class="progresso">
                            <div class="progresso-bar" style="width: ${percentualPago}%"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ============================================
        // ATUALIZAR SELECT DE D√çVIDAS
        // ============================================
        function atualizarSelectDividas(dividas) {
            const select = document.getElementById('dividaSelect');
            
            let options = '<option value="">Selecione uma d√≠vida...</option>';
            
            dividas
                .filter(d => d.payload.status !== 'quitada')
                .forEach(divida => {
                    options += `<option value="${divida.id}">${divida.payload.descricao} - ‚Ç¨${divida.payload.saldoRestante?.toFixed(2) || '0.00'} restante</option>`;
                });
            
            select.innerHTML = options;
        }

        // ============================================
        // SELECIONAR D√çVIDA
        // ============================================
        async function selecionarDivida(dividaId) {
            dividaSelecionadaId = dividaId;
            
            // Destacar item selecionado
            document.querySelectorAll('.item-divida').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Mostrar hist√≥rico de pagamentos
            await mostrarHistoricoPagamentos(dividaId);
        }

        // ============================================
        // MOSTRAR HIST√ìRICO DE PAGAMENTOS
        // ============================================
        async function mostrarHistoricoPagamentos(dividaId) {
            const pagamentos = await carregarPagamentos(dividaId);
            const container = document.getElementById('historicoPagamentos');
            
            if (!pagamentos || pagamentos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #94a3b8; padding: 30px;">
                        Nenhum pagamento registrado para esta d√≠vida
                    </div>
                `;
                return;
            }

            // Ordenar por data (mais recentes primeiro)
            pagamentos.sort((a, b) => new Date(b.payload.dataPagamento) - new Date(a.payload.dataPagamento));

            let html = '';
            pagamentos.forEach(pagamento => {
                const p = pagamento.payload;
                html += `
                    <div class="item-pagamento ${categoriaSelecionada}">
                        <div class="pagamento-info">
                            <h4>${p.formaPagamento}</h4>
                            <p>
                                <span>üìÖ ${new Date(p.dataPagamento).toLocaleDateString('pt-PT')}</span>
                                <span class="badge">${p.observacoes || 'Sem observa√ß√µes'}</span>
                            </p>
                        </div>
                        <div class="pagamento-valor">‚Ç¨${p.valorPago?.toFixed(2) || '0.00'}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ============================================
        // SALVAR D√çVIDA
        // ============================================
        async function salvarDivida() {
            const descricao = document.getElementById('descricao').value;
            const valorTotal = parseFloat(document.getElementById('valorTotal').value);
            const dataNegociacao = document.getElementById('dataNegociacao').value;
            const observacoes = document.getElementById('observacoesDivida').value;

            if (!descricao || !valorTotal || !dataNegociacao) {
                mostrarMensagem('Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            try {
                const schema = SCHEMAS[categoriaSelecionada].divida;
                
                const response = await fetch('/api/database/commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: schema,
                        payload: {
                            descricao: descricao,
                            valorTotal: valorTotal,
                            valorPago: 0,
                            saldoRestante: valorTotal,
                            dataNegociacao: dataNegociacao,
                            observacoes: observacoes,
                            status: 'ativa',
                            categoria: categoriaSelecionada,
                            dataCriacao: new Date().toISOString()
                        }
                    })
                });

                if (!response.ok) throw new Error('Erro ao salvar');
                
                mostrarMensagem('D√≠vida registrada com sucesso!', 'success');
                
                // Limpar formul√°rio
                document.getElementById('formDivida').reset();
                document.getElementById('dataNegociacao').valueAsDate = new Date();
                
                // Recarregar dados
                await carregarDividas();
                await atualizarIndicadores();
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao registrar d√≠vida', 'error');
            }
        }

        // ============================================
        // SALVAR PAGAMENTO
        // ============================================
        async function salvarPagamento() {
            const dividaId = document.getElementById('dividaSelect').value;
            const valorPago = parseFloat(document.getElementById('valorPago').value);
            const dataPagamento = document.getElementById('dataPagamento').value;
            const formaPagamento = document.getElementById('formaPagamento').value;
            const observacoes = document.getElementById('observacoesPagamento').value;

            if (!dividaId || !valorPago || !dataPagamento || !formaPagamento) {
                mostrarMensagem('Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            try {
                const schemaPagamento = SCHEMAS[categoriaSelecionada].pagamento;
                const schemaDivida = SCHEMAS[categoriaSelecionada].divida;
                
                // 1. Registrar o pagamento
                const responsePagamento = await fetch('/api/database/commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: schemaPagamento,
                        payload: {
                            dividaId: dividaId,
                            valorPago: valorPago,
                            dataPagamento: dataPagamento,
                            formaPagamento: formaPagamento,
                            observacoes: observacoes,
                            dataRegistro: new Date().toISOString()
                        }
                    })
                });

                if (!responsePagamento.ok) throw new Error('Erro ao registrar pagamento');

                // 2. Buscar a d√≠vida atualizada
                const responseDivida = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: schemaDivida,
                        filters: {}
                    })
                });

                const dataDivida = await responseDivida.json();
                const dividas = dataDivida.events || [];
                const divida = dividas.find(d => d.id === dividaId);
                
                if (divida) {
                    // 3. Buscar todos os pagamentos desta d√≠vida
                    const pagamentos = await carregarPagamentos(dividaId);
                    
                    // 4. Calcular totais
                    const totalPago = pagamentos.reduce((sum, p) => sum + (p.payload.valorPago || 0), 0) + valorPago;
                    const valorTotal = divida.payload.valorTotal;
                    const saldoRestante = valorTotal - totalPago;
                    
                    // 5. Atualizar a d√≠vida
                    await fetch('/api/database/commit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            schema: schemaDivida,
                            id: dividaId,
                            payload: {
                                ...divida.payload,
                                valorPago: totalPago,
                                saldoRestante: saldoRestante,
                                status: saldoRestante <= 0 ? 'quitada' : 'ativa'
                            }
                        })
                    });
                }
                
                mostrarMensagem('Pagamento registrado com sucesso!', 'success');
                
                // Limpar formul√°rio
                document.getElementById('formPagamento').reset();
                document.getElementById('dataPagamento').valueAsDate = new Date();
                
                // Recarregar tudo
                await carregarDividas();
                await atualizarIndicadores();
                
                // Se tiver uma d√≠vida selecionada, mostrar hist√≥rico
                if (dividaId) {
                    await mostrarHistoricoPagamentos(dividaId);
                }
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao registrar pagamento', 'error');
            }
        }

        // ============================================
        // ATUALIZAR INDICADORES
        // ============================================
        async function atualizarIndicadores() {
            try {
                // Buscar dados de Finan√ßas
                const responseFinancas = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: SCHEMAS.financas.divida,
                        filters: {}
                    })
                });
                
                const dataFinancas = await responseFinancas.json();
                const dividasFinancas = dataFinancas.events || [];
                
                // Buscar dados de Escrit√≥rio
                const responseEscritorio = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: SCHEMAS.escritorio.divida,
                        filters: {}
                    })
                });
                
                const dataEscritorio = await responseEscritorio.json();
                const dividasEscritorio = dataEscritorio.events || [];
                
                // Buscar todos os pagamentos
                const responsePagamentosFinancas = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: SCHEMAS.financas.pagamento,
                        filters: {}
                    })
                });
                
                const dataPagamentosFinancas = await responsePagamentosFinancas.json();
                const pagamentosFinancas = dataPagamentosFinancas.events || [];
                
                const responsePagamentosEscritorio = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: SCHEMAS.escritorio.pagamento,
                        filters: {}
                    })
                });
                
                const dataPagamentosEscritorio = await responsePagamentosEscritorio.json();
                const pagamentosEscritorio = dataPagamentosEscritorio.events || [];
                
                // Calcular totais FINAN√áAS
                const totalDividasFinancas = dividasFinancas.reduce((sum, d) => sum + (d.payload.valorTotal || 0), 0);
                const totalPagoFinancas = pagamentosFinancas.reduce((sum, p) => sum + (p.payload.valorPago || 0), 0);
                const totalRestanteFinancas = totalDividasFinancas - totalPagoFinancas;
                
                // Calcular totais ESCRIT√ìRIO
                const totalDividasEscritorio = dividasEscritorio.reduce((sum, d) => sum + (d.payload.valorTotal || 0), 0);
                const totalPagoEscritorio = pagamentosEscritorio.reduce((sum, p) => sum + (p.payload.valorPago || 0), 0);
                const totalRestanteEscritorio = totalDividasEscritorio - totalPagoEscritorio;
                
                // Atualizar interface FINAN√áAS
                document.getElementById('totalDividasFinancas').textContent = `‚Ç¨${totalDividasFinancas.toFixed(2)}`;
                document.getElementById('totalPagoFinancas').textContent = `‚Ç¨${totalPagoFinancas.toFixed(2)}`;
                document.getElementById('totalRestanteFinancas').textContent = `‚Ç¨${totalRestanteFinancas.toFixed(2)}`;
                
                // Atualizar interface ESCRIT√ìRIO
                document.getElementById('totalDividasEscritorio').textContent = `‚Ç¨${totalDividasEscritorio.toFixed(2)}`;
                document.getElementById('totalPagoEscritorio').textContent = `‚Ç¨${totalPagoEscritorio.toFixed(2)}`;
                document.getElementById('totalRestanteEscritorio').textContent = `‚Ç¨${totalRestanteEscritorio.toFixed(2)}`;
                
            } catch (error) {
                console.error('Erro ao atualizar indicadores:', error);
            }
        }

        // ============================================
        // MOSTRAR MENSAGEM
        // ============================================
        function mostrarMensagem(texto, tipo) {
            const mensagem = document.createElement('div');
            mensagem.className = 'mensagem-flutuante';
            
            let cor;
            if (tipo === 'success') cor = 'linear-gradient(135deg, #10b981, #059669)';
            else if (tipo === 'error') cor = 'linear-gradient(135deg, #ef4444, #dc2626)';
            else if (tipo === 'warning') cor = 'linear-gradient(135deg, #f59e0b, #d97706)';
            else cor = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            
            mensagem.style.background = cor;
            mensagem.textContent = texto;
            document.body.appendChild(mensagem);
            
            setTimeout(() => mensagem.remove(), 3000);
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Sistema Financeiro Iniciado');
            
            // Definir datas padr√£o
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataNegociacao').value = hoje;
            document.getElementById('dataPagamento').value = hoje;
            
            // Carregar dados iniciais
            await carregarDividas();
            await atualizarIndicadores();
            
            // Verificar conex√£o
            try {
                await fetch('/api/database/init');
                console.log('‚úÖ Conectado √† API');
            } catch (err) {
                console.error('‚ùå Erro de conex√£o:', err);
                mostrarMensagem('Erro de conex√£o com o servidor', 'error');
            }
        });
    </script>
</body>
</html>