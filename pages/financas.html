<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de D√≠vidas - Finan√ßas & Escrit√≥rio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
            padding: 24px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* HEADER LUXO */
        .header {
            background: white;
            border-radius: 24px;
            padding: 28px 36px;
            margin-bottom: 28px;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.08);
            border: 1px solid rgba(226, 232, 240, 0.6);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .header-left h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #0f172a, #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left h1 i {
            font-size: 32px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .badge {
            background: #f1f5f9;
            color: #475569;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #e2e8f0;
        }

        /* MEGA INDICADORES */
        .mega-indicadores {
            display: flex;
            gap: 24px;
            background: white;
            padding: 20px 28px;
            border-radius: 60px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.02);
            border: 1px solid #e2e8f0;
        }

        .mega-item {
            text-align: center;
            min-width: 140px;
        }

        .mega-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .mega-valor {
            font-size: 26px;
            font-weight: 700;
            color: #0f172a;
        }

        .mega-valor.financas { color: #3b82f6; }
        .mega-valor.escritorio { color: #10b981; }
        .mega-valor.total { color: #8b5cf6; }

        /* TABS MODERNAS */
        .tabs-modernas {
            display: flex;
            gap: 12px;
            margin-bottom: 28px;
            background: white;
            padding: 8px;
            border-radius: 60px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            border: 1px solid #e2e8f0;
            width: fit-content;
        }

        .tab-moderna {
            padding: 14px 36px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab-moderna i {
            font-size: 20px;
        }

        .tab-moderna.financas.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 8px 20px -8px #3b82f6;
        }

        .tab-moderna.escritorio.active {
            background: #10b981;
            color: white;
            box-shadow: 0 8px 20px -8px #10b981;
        }

        /* GRID PRINCIPAL */
        .grid-principal {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 28px;
            margin-top: 28px;
        }

        /* CARDS ELEGANTES */
        .card-elegante {
            background: white;
            border-radius: 28px;
            padding: 28px;
            box-shadow: 0 15px 40px -12px rgba(0,0,0,0.08);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: transform 0.2s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }

        .card-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header h2 i {
            color: #94a3b8;
        }

        .btn-novo {
            background: #f1f5f9;
            border: none;
            padding: 10px 20px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 13px;
            color: #334155;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #e2e8f0;
        }

        .btn-novo:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }

        /* LISTA DE D√çVIDAS */
        .lista-dividas {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .lista-dividas::-webkit-scrollbar {
            width: 6px;
        }

        .lista-dividas::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .lista-dividas::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .item-divida {
            background: #ffffff;
            border: 1px solid #f1f5f9;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }

        .item-divida:hover {
            border-color: #3b82f6;
            box-shadow: 0 8px 20px -12px #3b82f6;
            transform: translateY(-1px);
        }

        .item-divida.selected {
            border: 2px solid #3b82f6;
            background: #f0f9ff;
        }

        .divida-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .divida-titulo {
            font-weight: 600;
            color: #0f172a;
            font-size: 16px;
        }

        .categoria-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 40px;
        }

        .categoria-badge.financas {
            background: #dbeafe;
            color: #1e40af;
        }

        .categoria-badge.escritorio {
            background: #d1fae5;
            color: #065f46;
        }

        .divida-valores-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .valor-box {
            text-align: center;
        }

        .valor-label {
            font-size: 11px;
            color: #64748b;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .valor-numero {
            font-weight: 700;
            font-size: 16px;
            color: #0f172a;
        }

        .progresso-bar {
            height: 6px;
            background: #f1f5f9;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progresso-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 10px;
            transition: width 0.3s;
        }

        /* FORMUL√ÅRIO COMPACTO */
        .form-compacto {
            background: #f8fafc;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 28px;
            border: 1px solid #e2e8f0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 12px;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }

        .form-control:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -8px #0f172a;
        }

        .btn-primary.financas {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .btn-primary.escritorio {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        /* HIST√ìRICO DE PAGAMENTOS */
        .historico-pagamentos {
            max-height: 300px;
            overflow-y: auto;
        }

        .pagamento-item {
            background: #f8fafc;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 10px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #f1f5f9;
        }

        .pagamento-item.financas {
            border-left-color: #3b82f6;
        }

        .pagamento-item.escritorio {
            border-left-color: #10b981;
        }

        .pagamento-info h4 {
            color: #0f172a;
            margin-bottom: 4px;
            font-size: 15px;
            font-weight: 600;
        }

        .pagamento-meta {
            color: #64748b;
            font-size: 12px;
            display: flex;
            gap: 16px;
        }

        .pagamento-valor {
            font-weight: 700;
            font-size: 20px;
            color: #10b981;
        }

        /* MENSAGENS FLUTUANTES */
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 28px;
            border-radius: 60px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.2s;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            font-size: 14px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* UTILS */
        .hidden {
            display: none !important;
        }

        .mt-4 {
            margin-top: 20px;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .grid-principal {
                grid-template-columns: 1fr;
            }
            
            .mega-indicadores {
                flex-wrap: wrap;
                border-radius: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER LUXO -->
        <div class="header">
            <div class="header-left">
                <h1>
                    <i>üí∞</i> 
                    Gest√£o de D√≠vidas
                </h1>
                <div class="badge">
                    <span>‚ö°</span> Controle Financeiro Inteligente
                </div>
            </div>
            
            <!-- MEGA INDICADORES TOPO -->
            <div class="mega-indicadores">
                <div class="mega-item">
                    <div class="mega-label">Total Geral</div>
                    <div class="mega-valor total" id="megaTotalGeral">‚Ç¨0,00</div>
                </div>
                <div class="mega-item">
                    <div class="mega-label">Pago Geral</div>
                    <div class="mega-valor total" id="megaPagoGeral">‚Ç¨0,00</div>
                </div>
                <div class="mega-item">
                    <div class="mega-label">Restante Geral</div>
                    <div class="mega-valor total" id="megaRestanteGeral">‚Ç¨0,00</div>
                </div>
            </div>
        </div>

        <!-- TABS MODERNAS -->
        <div class="tabs-modernas">
            <button class="tab-moderna financas active" onclick="mudarCategoria('financas')" id="tabFinancas">
                <i>üèõÔ∏è</i> Finan√ßas
            </button>
            <button class="tab-moderna escritorio" onclick="mudarCategoria('escritorio')" id="tabEscritorio">
                <i>üìã</i> Escrit√≥rio Cont√°bil
            </button>
        </div>

        <!-- INDICADORES POR CATEGORIA -->
        <div id="indicadoresFinancas" class="mega-indicadores" style="margin-bottom: 20px;">
            <div class="mega-item">
                <div class="mega-label">Total Finan√ßas</div>
                <div class="mega-valor financas" id="totalDividasFinancas">‚Ç¨0,00</div>
            </div>
            <div class="mega-item">
                <div class="mega-label">Pago Finan√ßas</div>
                <div class="mega-valor financas" id="totalPagoFinancas">‚Ç¨0,00</div>
            </div>
            <div class="mega-item">
                <div class="mega-label">Restante Finan√ßas</div>
                <div class="mega-valor financas" id="totalRestanteFinancas">‚Ç¨0,00</div>
            </div>
        </div>

        <div id="indicadoresEscritorio" class="mega-indicadores" style="margin-bottom: 20px; display: none;">
            <div class="mega-item">
                <div class="mega-label">Total Escrit√≥rio</div>
                <div class="mega-valor escritorio" id="totalDividasEscritorio">‚Ç¨0,00</div>
            </div>
            <div class="mega-item">
                <div class="mega-label">Pago Escrit√≥rio</div>
                <div class="mega-valor escritorio" id="totalPagoEscritorio">‚Ç¨0,00</div>
            </div>
            <div class="mega-item">
                <div class="mega-label">Restante Escrit√≥rio</div>
                <div class="mega-valor escritorio" id="totalRestanteEscritorio">‚Ç¨0,00</div>
            </div>
        </div>

        <!-- GRID PRINCIPAL -->
        <div class="grid-principal">
            <!-- COLUNA ESQUERDA: LISTA DE D√çVIDAS -->
            <div class="card-elegante">
                <div class="card-header">
                    <h2>
                        <i>üìã</i> 
                        <span id="tituloLista">D√≠vidas Ativas - Finan√ßas</span>
                    </h2>
                    <button class="btn-novo" onclick="mostrarFormNovaDivida()">
                        <i>‚ûï</i> Nova D√≠vida
                    </button>
                </div>

                <!-- FORM NOVA D√çVIDA (OCULTO INICIALMENTE) -->
                <div id="formNovaDividaContainer" class="form-compacto hidden">
                    <h3 style="margin-bottom: 20px; font-size: 16px;">‚ûï Nova D√≠vida</h3>
                    <div class="form-group">
                        <label>Descri√ß√£o</label>
                        <input type="text" id="descricao" class="form-control" placeholder="Ex: IRS 2023">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Valor Total (‚Ç¨)</label>
                            <input type="number" id="valorTotal" step="0.01" class="form-control" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="dataNegociacao" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Observa√ß√µes</label>
                        <textarea id="observacoesDivida" rows="2" class="form-control" placeholder="Detalhes..."></textarea>
                    </div>
                    <button class="btn-primary" id="btnSalvarDivida" onclick="salvarDivida()">
                        <i>üíæ</i> REGISTRAR D√çVIDA
                    </button>
                </div>

                <!-- LISTA DE D√çVIDAS -->
                <div id="listaDividas" class="lista-dividas">
                    <div style="text-align: center; color: #94a3b8; padding: 40px;">
                        Carregando d√≠vidas...
                    </div>
                </div>
            </div>

            <!-- COLUNA DIREITA: PAGAMENTOS -->
            <div class="card-elegante">
                <div class="card-header">
                    <h2>
                        <i>üí≥</i> 
                        <span id="tituloPagamento">Registrar Pagamento</span>
                    </h2>
                </div>

                <!-- FORM PAGAMENTO (S√ì APARECE QUANDO SELECIONA D√çVIDA) -->
                <div id="formPagamentoContainer" class="form-compacto hidden">
                    <h3 style="margin-bottom: 20px; font-size: 16px;">üí∞ Novo Pagamento</h3>
                    <div class="form-group">
                        <label>D√≠vida Selecionada</label>
                        <select id="dividaSelect" class="form-control">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Valor (‚Ç¨)</label>
                            <input type="number" id="valorPago" step="0.01" class="form-control" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label>Data</label>
                            <input type="date" id="dataPagamento" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Forma de Pagamento</label>
                        <select id="formaPagamento" class="form-control">
                            <option value="MBWay">MBWay</option>
                            <option value="Transfer√™ncia">Transfer√™ncia</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cart√£o">Cart√£o</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Observa√ß√µes</label>
                        <textarea id="observacoesPagamento" rows="2" class="form-control" placeholder="..."></textarea>
                    </div>
                    <button class="btn-primary" id="btnSalvarPagamento" onclick="salvarPagamento()">
                        <i>‚úÖ</i> REGISTRAR PAGAMENTO
                    </button>
                </div>

                <!-- HIST√ìRICO DE PAGAMENTOS -->
                <div class="mt-4">
                    <h3 style="font-size: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i>üìú</i> Hist√≥rico de Pagamentos
                    </h3>
                    <div id="historicoPagamentos" class="historico-pagamentos">
                        <div style="text-align: center; color: #94a3b8; padding: 30px;">
                            Selecione uma d√≠vida para ver os pagamentos
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SISTEMA DE GEST√ÉO DE D√çVIDAS - CORRIGIDO
        // ============================================
        
        const SCHEMAS = {
            financas: {
                divida: 'financas_divida',
                pagamento: 'financas_pagamento'
            },
            escritorio: {
                divida: 'escritorio_divida',
                pagamento: 'escritorio_pagamento'
            }
        };

        let categoriaSelecionada = 'financas';
        let dividaSelecionadaId = null;

        // ============================================
        // UTILS
        // ============================================
        function mostrarMensagem(texto, tipo) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            const cores = {
                success: 'linear-gradient(135deg, #10b981, #059669)',
                error: 'linear-gradient(135deg, #ef4444, #dc2626)',
                warning: 'linear-gradient(135deg, #f59e0b, #d97706)'
            };
            
            toast.style.background = cores[tipo] || cores.success;
            toast.textContent = texto;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function formatarMoeda(valor) {
            return `‚Ç¨${(valor || 0).toFixed(2)}`;
        }

        // ============================================
        // MUDAR CATEGORIA
        // ============================================
        function mudarCategoria(categoria) {
            categoriaSelecionada = categoria;
            
            document.getElementById('tabFinancas').classList.remove('active');
            document.getElementById('tabEscritorio').classList.remove('active');
            document.getElementById(`tab${categoria.charAt(0).toUpperCase() + categoria.slice(1)}`).classList.add('active');
            
            // Mostrar/esconder indicadores
            document.getElementById('indicadoresFinancas').style.display = categoria === 'financas' ? 'flex' : 'none';
            document.getElementById('indicadoresEscritorio').style.display = categoria === 'escritorio' ? 'flex' : 'none';
            
            // Atualizar t√≠tulos
            document.getElementById('tituloLista').textContent = `D√≠vidas Ativas - ${categoria === 'financas' ? 'Finan√ßas' : 'Escrit√≥rio'}`;
            document.getElementById('tituloPagamento').textContent = `Registrar Pagamento - ${categoria === 'financas' ? 'Finan√ßas' : 'Escrit√≥rio'}`;
            
            // Atualizar cor do bot√£o
            const btnDivida = document.getElementById('btnSalvarDivida');
            const btnPagamento = document.getElementById('btnSalvarPagamento');
            
            btnDivida.className = `btn-primary ${categoria}`;
            btnPagamento.className = `btn-primary ${categoria}`;
            
            // Limpar sele√ß√£o
            dividaSelecionadaId = null;
            document.getElementById('formPagamentoContainer').classList.add('hidden');
            
            // Recarregar
            carregarDividas();
            atualizarIndicadores();
            atualizarMegaIndicadores();
        }

        // ============================================
        // MOSTRAR FORM NOVA D√çVIDA
        // ============================================
        function mostrarFormNovaDivida() {
            const container = document.getElementById('formNovaDividaContainer');
            container.classList.toggle('hidden');
            
            // Setar data padr√£o
            if (!document.getElementById('dataNegociacao').value) {
                document.getElementById('dataNegociacao').valueAsDate = new Date();
            }
        }

        // ============================================
        // CARREGAR D√çVIDAS
        // ============================================
        async function carregarDividas() {
            try {
                const response = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: SCHEMAS[categoriaSelecionada].divida,
                        filters: {}
                    })
                });

                if (!response.ok) throw new Error('Erro ao carregar');
                
                const data = await response.json();
                const dividas = data.events || [];
                
                atualizarListaDividas(dividas);
                atualizarSelectDividas(dividas);
                
                return dividas;
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao carregar d√≠vidas', 'error');
                return [];
            }
        }

        // ============================================
        // CARREGAR PAGAMENTOS
        // ============================================
        async function carregarPagamentos(dividaId = null) {
            try {
                const response = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: SCHEMAS[categoriaSelecionada].pagamento,
                        filters: dividaId ? { dividaId } : {}
                    })
                });

                if (!response.ok) throw new Error('Erro ao carregar pagamentos');
                
                const data = await response.json();
                return data.events || [];
            } catch (error) {
                console.error('Erro:', error);
                return [];
            }
        }

        // ============================================
        // ATUALIZAR LISTA DE D√çVIDAS
        // ============================================
        function atualizarListaDividas(dividas) {
            const container = document.getElementById('listaDividas');
            
            if (!dividas || dividas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #94a3b8; padding: 40px;">
                        Nenhuma d√≠vida cadastrada
                    </div>
                `;
                return;
            }

            dividas.sort((a, b) => new Date(b.payload.dataNegociacao) - new Date(a.payload.dataNegociacao));

            let html = '';
            dividas.forEach(divida => {
                const p = divida.payload;
                const percentual = p.valorTotal > 0 ? ((p.valorPago || 0) / p.valorTotal) * 100 : 0;
                const selectedClass = dividaSelecionadaId === divida.id ? 'selected' : '';
                
                html += `
                    <div class="item-divida ${selectedClass}" onclick="selecionarDivida('${divida.id}')">
                        <div class="divida-header">
                            <span class="divida-titulo">${p.descricao}</span>
                            <span class="categoria-badge ${categoriaSelecionada}">
                                ${categoriaSelecionada === 'financas' ? 'Finan√ßas' : 'Escrit√≥rio'}
                            </span>
                        </div>
                        <div class="divida-valores-grid">
                            <div class="valor-box">
                                <div class="valor-label">Total</div>
                                <div class="valor-numero">${formatarMoeda(p.valorTotal)}</div>
                            </div>
                            <div class="valor-box">
                                <div class="valor-label">Pago</div>
                                <div class="valor-numero">${formatarMoeda(p.valorPago || 0)}</div>
                            </div>
                            <div class="valor-box">
                                <div class="valor-label">Restante</div>
                                <div class="valor-numero">${formatarMoeda(p.saldoRestante || p.valorTotal)}</div>
                            </div>
                        </div>
                        <div class="progresso-bar">
                            <div class="progresso-fill" style="width: ${percentual}%"></div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ============================================
        // ATUALIZAR SELECT DE D√çVIDAS
        // ============================================
        function atualizarSelectDividas(dividas) {
            const select = document.getElementById('dividaSelect');
            let options = '<option value="">Selecione uma d√≠vida...</option>';
            
            dividas
                .filter(d => (d.payload.saldoRestante || d.payload.valorTotal) > 0)
                .forEach(divida => {
                    const restante = divida.payload.saldoRestante || divida.payload.valorTotal;
                    options += `<option value="${divida.id}">${divida.payload.descricao} - ${formatarMoeda(restante)} restante</option>`;
                });
            
            select.innerHTML = options;
        }

        // ============================================
        // SELECIONAR D√çVIDA
        // ============================================
        async function selecionarDivida(dividaId) {
            dividaSelecionadaId = dividaId;
            
            // Mostrar formul√°rio de pagamento
            document.getElementById('formPagamentoContainer').classList.remove('hidden');
            
            // Setar data padr√£o
            if (!document.getElementById('dataPagamento').value) {
                document.getElementById('dataPagamento').valueAsDate = new Date();
            }
            
            // Selecionar no dropdown
            const select = document.getElementById('dividaSelect');
            select.value = dividaId;
            
            // Destacar item
            document.querySelectorAll('.item-divida').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Mostrar hist√≥rico
            await mostrarHistoricoPagamentos(dividaId);
        }

        // ============================================
        // MOSTRAR HIST√ìRICO DE PAGAMENTOS
        // ============================================
        async function mostrarHistoricoPagamentos(dividaId) {
            const pagamentos = await carregarPagamentos(dividaId);
            const container = document.getElementById('historicoPagamentos');
            
            if (!pagamentos || pagamentos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #94a3b8; padding: 20px;">
                        Nenhum pagamento registrado
                    </div>
                `;
                return;
            }

            pagamentos.sort((a, b) => new Date(b.payload.dataPagamento) - new Date(a.payload.dataPagamento));

            let html = '';
            pagamentos.forEach(pagamento => {
                const p = pagamento.payload;
                html += `
                    <div class="pagamento-item ${categoriaSelecionada}">
                        <div class="pagamento-info">
                            <h4>${p.formaPagamento}</h4>
                            <div class="pagamento-meta">
                                <span>üìÖ ${new Date(p.dataPagamento).toLocaleDateString('pt-PT')}</span>
                                <span>üìù ${p.observacoes || 'Sem obs'}</span>
                            </div>
                        </div>
                        <div class="pagamento-valor">${formatarMoeda(p.valorPago)}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ============================================
        // SALVAR D√çVIDA
        // ============================================
        async function salvarDivida() {
            const descricao = document.getElementById('descricao').value;
            const valorTotal = parseFloat(document.getElementById('valorTotal').value);
            const dataNegociacao = document.getElementById('dataNegociacao').value;
            const observacoes = document.getElementById('observacoesDivida').value;

            if (!descricao || !valorTotal || !dataNegociacao) {
                mostrarMensagem('Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/database/commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: SCHEMAS[categoriaSelecionada].divida,
                        payload: {
                            descricao,
                            valorTotal,
                            valorPago: 0,
                            saldoRestante: valorTotal,
                            dataNegociacao,
                            observacoes,
                            status: 'ativa',
                            categoria: categoriaSelecionada,
                            dataCriacao: new Date().toISOString()
                        }
                    })
                });

                if (!response.ok) throw new Error('Erro ao salvar');
                
                mostrarMensagem('D√≠vida registrada com sucesso!', 'success');
                
                // Limpar e esconder form
                document.getElementById('descricao').value = '';
                document.getElementById('valorTotal').value = '';
                document.getElementById('observacoesDivida').value = '';
                document.getElementById('formNovaDividaContainer').classList.add('hidden');
                
                // Recarregar
                await carregarDividas();
                await atualizarIndicadores();
                await atualizarMegaIndicadores();
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao registrar d√≠vida', 'error');
            }
        }

        // ============================================
        // SALVAR PAGAMENTO
        // ============================================
        async function salvarPagamento() {
            const dividaId = document.getElementById('dividaSelect').value;
            const valorPago = parseFloat(document.getElementById('valorPago').value);
            const dataPagamento = document.getElementById('dataPagamento').value;
            const formaPagamento = document.getElementById('formaPagamento').value;
            const observacoes = document.getElementById('observacoesPagamento').value;

            if (!dividaId || !valorPago || !dataPagamento || !formaPagamento) {
                mostrarMensagem('Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            try {
                // 1. Buscar d√≠vida atual
                const responseDividas = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: SCHEMAS[categoriaSelecionada].divida,
                        filters: {}
                    })
                });
                
                const dataDividas = await responseDividas.json();
                const divida = (dataDividas.events || []).find(d => d.id === dividaId);
                
                if (!divida) {
                    mostrarMensagem('D√≠vida n√£o encontrada', 'error');
                    return;
                }

                // 2. Registrar pagamento
                const responsePagamento = await fetch('/api/database/commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: SCHEMAS[categoriaSelecionada].pagamento,
                        payload: {
                            dividaId,
                            valorPago,
                            dataPagamento,
                            formaPagamento,
                            observacoes,
                            dataRegistro: new Date().toISOString()
                        }
                    })
                });

                if (!responsePagamento.ok) throw new Error('Erro ao registrar pagamento');

                // 3. Buscar todos pagamentos da d√≠vida
                const pagamentos = await carregarPagamentos(dividaId);
                const totalPago = pagamentos.reduce((sum, p) => sum + p.payload.valorPago, 0) + valorPago;
                const saldoRestante = divida.payload.valorTotal - totalPago;

                // 4. Atualizar d√≠vida
                await fetch('/api/database/commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        schema: SCHEMAS[categoriaSelecionada].divida,
                        id: dividaId,
                        payload: {
                            ...divida.payload,
                            valorPago: totalPago,
                            saldoRestante: saldoRestante,
                            status: saldoRestante <= 0 ? 'quitada' : 'ativa'
                        }
                    })
                });
                
                mostrarMensagem('Pagamento registrado com sucesso!', 'success');
                
                // Limpar campos
                document.getElementById('valorPago').value = '';
                document.getElementById('observacoesPagamento').value = '';
                
                // Recarregar
                await carregarDividas();
                await atualizarIndicadores();
                await atualizarMegaIndicadores();
                await mostrarHistoricoPagamentos(dividaId);
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarMensagem('Erro ao registrar pagamento', 'error');
            }
        }

        // ============================================
        // ATUALIZAR INDICADORES
        // ============================================
        async function atualizarIndicadores() {
            try {
                // Finan√ßas
                const respF = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schema: SCHEMAS.financas.divida, filters: {} })
                });
                const dataF = await respF.json();
                const dividasF = dataF.events || [];
                
                const respPF = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schema: SCHEMAS.financas.pagamento, filters: {} })
                });
                const dataPF = await respPF.json();
                const pagamentosF = dataPF.events || [];
                
                const totalF = dividasF.reduce((s, d) => s + (d.payload.valorTotal || 0), 0);
                const pagoF = pagamentosF.reduce((s, p) => s + (p.payload.valorPago || 0), 0);
                
                document.getElementById('totalDividasFinancas').textContent = formatarMoeda(totalF);
                document.getElementById('totalPagoFinancas').textContent = formatarMoeda(pagoF);
                document.getElementById('totalRestanteFinancas').textContent = formatarMoeda(totalF - pagoF);
                
                // Escrit√≥rio
                const respE = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schema: SCHEMAS.escritorio.divida, filters: {} })
                });
                const dataE = await respE.json();
                const dividasE = dataE.events || [];
                
                const respPE = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schema: SCHEMAS.escritorio.pagamento, filters: {} })
                });
                const dataPE = await respPE.json();
                const pagamentosE = dataPE.events || [];
                
                const totalE = dividasE.reduce((s, d) => s + (d.payload.valorTotal || 0), 0);
                const pagoE = pagamentosE.reduce((s, p) => s + (p.payload.valorPago || 0), 0);
                
                document.getElementById('totalDividasEscritorio').textContent = formatarMoeda(totalE);
                document.getElementById('totalPagoEscritorio').textContent = formatarMoeda(pagoE);
                document.getElementById('totalRestanteEscritorio').textContent = formatarMoeda(totalE - pagoE);
                
            } catch (error) {
                console.error('Erro ao atualizar indicadores:', error);
            }
        }

        // ============================================
        // ATUALIZAR MEGA INDICADORES
        // ============================================
        async function atualizarMegaIndicadores() {
            try {
                // Finan√ßas
                const respF = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schema: SCHEMAS.financas.divida, filters: {} })
                });
                const dataF = await respF.json();
                const dividasF = dataF.events || [];
                
                const respPF = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schema: SCHEMAS.financas.pagamento, filters: {} })
                });
                const dataPF = await respPF.json();
                const pagamentosF = dataPF.events || [];
                
                const totalF = dividasF.reduce((s, d) => s + (d.payload.valorTotal || 0), 0);
                const pagoF = pagamentosF.reduce((s, p) => s + (p.payload.valorPago || 0), 0);
                
                // Escrit√≥rio
                const respE = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schema: SCHEMAS.escritorio.divida, filters: {} })
                });
                const dataE = await respE.json();
                const dividasE = dataE.events || [];
                
                const respPE = await fetch('/api/database/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schema: SCHEMAS.escritorio.pagamento, filters: {} })
                });
                const dataPE = await respPE.json();
                const pagamentosE = dataPE.events || [];
                
                const totalE = dividasE.reduce((s, d) => s + (d.payload.valorTotal || 0), 0);
                const pagoE = pagamentosE.reduce((s, p) => s + (p.payload.valorPago || 0), 0);
                
                // Totais gerais
                const totalGeral = totalF + totalE;
                const pagoGeral = pagoF + pagoE;
                
                document.getElementById('megaTotalGeral').textContent = formatarMoeda(totalGeral);
                document.getElementById('megaPagoGeral').textContent = formatarMoeda(pagoGeral);
                document.getElementById('megaRestanteGeral').textContent = formatarMoeda(totalGeral - pagoGeral);
                
            } catch (error) {
                console.error('Erro ao atualizar mega indicadores:', error);
            }
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Sistema Iniciado');
            
            // Setar datas padr√£o
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataNegociacao').value = hoje;
            document.getElementById('dataPagamento').value = hoje;
            
            // Carregar dados
            await carregarDividas();
            await atualizarIndicadores();
            await atualizarMegaIndicadores();
            
            // Verificar conex√£o
            try {
                await fetch('/api/database/init');
                console.log('‚úÖ Conectado √† API');
            } catch (err) {
                console.error('‚ùå Erro de conex√£o:', err);
                mostrarMensagem('Erro de conex√£o com o servidor', 'error');
            }
        });
    </script>
</body>
</html>